<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LNPresents - Builder</title>
  <style>
/* ===============================
   LNPresents — Builder Rich CSS
   (UI polish only; no layout/JS changes)
   =============================== */

/* 1) Design tokens (aligned to Presenter) */
:root{
  --bg: linear-gradient(90deg,#191970,#4b0082);
  --surface: #0f172a;
  --card-bg: #ffffff;
  --card-muted:#f8fafc;
  --input-bg:#f1f3f5;
  --text:#0b0f19;
  --ink:#5b6470;
  --border: rgba(0,0,0,.08);
  --accent:linear-gradient(90deg,#191970,#4b0082);          /* LN red for actions */
  --accent-ink:#fff;
  --green:#16a34a;

  --radius-lg:16px;
  --radius-md:12px;
  --radius-sm:10px;
  --shadow-sm:0 2px 10px rgba(0,0,0,.08);
  --shadow-md:0 10px 24px rgba(0,0,0,.12);
  --shadow-lg:0 18px 40px rgba(0,0,0,.18);
}

/* Optional themes (toggle via data-theme) */
[data-theme="indigo"]{ --accent:#4b0082; }
[data-theme="ln-red"]{ --bg:linear-gradient(90deg,#8b0000,#cc0000); --accent:#cc0000; }
[data-theme="emerald"]{ --bg:linear-gradient(90deg,#065f46,#059669); --accent:#059669; }
[data-theme="slate"]{ --bg:linear-gradient(90deg,#334155,#0f172a); --accent:#334155; }
[data-theme="midnight"]{
  --card-bg:#0f172a; --card-muted:#0b1320; --text:#e5e7eb; --ink:#b8c0cc;
  --border:rgba(255,255,255,.08); --accent:#7c3aed;
}

/* 2) Base */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background: var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{ color:inherit; text-decoration:none; }
h1,h2{ margin:0; }

@media (prefers-reduced-motion: reduce){
  *{ animation:none !important; transition:none !important; }
}

/* 3) Page header */
.page-header{
  max-width:1280px;
  margin: 30px auto 10px;
  padding: 0 24px;
  color:#fff;
  display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;
}
.page-header-left{ flex:1 1 600px; min-width:0; }
.page-header h1{ font-size: clamp(1.15rem,2.6vw,1.5rem); font-weight:700; letter-spacing:.01em; }
.page-header p{ font-size: clamp(.8rem,1.2vw,.95rem); line-height:1.4; opacity:.92; max-width:75ch; margin-top:2px; }
.page-header-actions{ display:flex; gap:8px; align-items:left; margin-top:0; }
@media (max-width:640px){ .page-header{ align-items:flex-start; } .page-header-actions{ margin-top:8px; width:100%; } }

/* 4) Top action row (Save/Export/etc.) */
.form-top-actions{
  max-width:1280px; margin: 0 auto 8px; padding: 0 24px;
  display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;
}

/* Buttons */
.ln-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:.65rem .95rem; border-radius:999px; font-weight:700;
  color:var(--bg);
  background: #fff;
  border:1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 22px rgba(0,0,0,.25);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.ln-btn:hover{ transform: translateY(-1px); filter: brightness(1.02); box-shadow: var(--shadow-lg); }
.ln-btn:active{ transform: translateY(0); }
.ln-btn:focus-visible{ outline:3px solid #fff; outline-offset:2px; }
.btn-open{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:.65rem .95rem; border-radius:6px; font-weight:700;
  color:var(--bg);
  background: #fff;
  border:1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 22px rgba(0,0,0,.25);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  }

/* small variant (keeps link inline) */
.ln-btn--sm{ font-size:.86rem; padding:.45rem .8rem; }

/* 5) Form shell + panel row */
.form-shell{ max-width:1280px; margin: 0 auto; padding: 0 24px 24px; }
.form-panel-row{ display:flex; flex-wrap:wrap; gap:.6rem; width:100%; align-items:stretch; }

/* 6) Cards (panels) */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
  border:1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(6px);
}
.form-panel-row .card{ flex:1 1 300px; display:flex; flex-direction:column; gap:.5rem; min-height:120px; }
@media (max-width:1100px){ .form-panel-row .card{ flex:1 1 70%; } }

.card h2{ font-size:1.05rem; margin: 0 0 8px; }
.lede{ margin:0 0 8px; color:#334155; font-weight:600; }
.card-info{ background: var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:16px 18px; box-shadow: var(--shadow-sm); }

/* Profile save/load card */
.profile-card-controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
.profile-upload{
  position:relative;
  border:1px dashed var(--border);
  border-radius:10px;
  padding:8px 10px;
  background:rgba(148,163,184,.08);
  font-size:.8rem;
  color:#334155;
  cursor:pointer;
}
.profile-upload span{
  pointer-events:none;
}
.profile-upload input[type="file"]{
  position:absolute;
  inset:0;
  opacity:0;
  cursor:pointer;
}
.muted-text{
  margin-top:8px;
  font-size:.8rem;
  color:#64748b;
}

/* NEW: profile filename input */
.profile-filename-input {
  max-width: 220px;
  flex: 0 0 auto;
}

/* 7) Tabs */
.tab-row{ display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.tab-btn{
  padding: 6px 12px; border-radius: 999px;
  background: #eef2f7; border: 1px solid var(--border);
  font-size:.8rem; cursor:pointer; font-weight:700; color:#0b0f19;
  transition: filter .12s ease, transform .12s ease, box-shadow .12s ease;
}
.tab-btn:hover{ filter: brightness(1.02); box-shadow: var(--shadow-sm); transform: translateY(-1px); }
.tab-btn.active{ background: var(--accent); color:#fff; border-color: transparent; box-shadow: 0 8px 20px rgba(0,0,0,.18); }
.panel{ display:none; }
.panel.active{ display:block; }

/* 8) Top/simple grids and terms */
.top-grid{ display:grid; gap:10px; }
.top-simple{ display:grid; grid-template-columns: repeat(auto-fit,minmax(10px,1fr)); gap:8px 10px; }

.top-term-row{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 300px));
  column-gap:0; row-gap:0;
}
.top-field{ display:grid; gap:9px; min-width:150px; font-size:.95rem; }
.top-field.term-style{ grid-template-columns: 20px 110px minmax(100px, 60px); align-items:center; font-size:.86rem; }
.top-field.yoy-row{ grid-template-columns: 20px 123px minmax(50px,10px); font-size:.9rem; padding:6px 0; gap:3px; }

/* 9) Inputs, selects, checkbox */
.input-style,
select, input[type="text"], input[type="number"], input[type="date"], textarea{
  appearance: none;
  width: 100%;
  background: #fff;
  border:1px solid var(--border);
  border-radius: 10px;
  padding: 8px 10px;
  font-size:.95rem; color: var(--text);
  box-shadow: inset 0 1px 0 rgba(0,0,0,.03);
  transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
}
input::placeholder, textarea::placeholder{ color:#9aa4b2; }

input:focus, select:focus, textarea:focus{
  outline:none;
  border-color:#94a3b8;
  box-shadow: 0 0 0 3px rgba(59,130,246,.25);
  background:#fff;
}

.term-check{ width:16px; height:16px; display:flex; align-items:center; justify-content:center; position:relative; }
.term-check input[type="checkbox"]{ position:absolute; opacity:0; inset:0; cursor:pointer; }
.term-check .box{ width:16px; height:16px; border:1px solid rgba(0,0,0,.25); border-radius:4px; background:#fff; }
.term-check input[type="checkbox"]:checked + .box{
  background: var(--accent); border-color: var(--accent); box-shadow: 0 0 0 1px rgba(25,25,112,.15);
}

/* =============== Small utility buttons — engaging & professional =============== */

/* shared base */
.btn-clear,
.btn-save,
.btn-export,
.btn-copy,
.btn-open{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:0.25rem;

  padding:6px 12px;
  font-size:.78rem;
  font-weight:600;
  letter-spacing:.02em;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.16);
  cursor:pointer;
  line-height:1.1;
  white-space:nowrap;

  transition:
    background-color .18s ease,
    box-shadow .18s ease,
    transform .08s ease,
    filter .18s ease,
    border-color .18s ease;
  box-shadow:0 1px 2px rgba(15,23,42,.18);
}

/* shared interactions */
.btn-clear:hover,
.btn-save:hover,
.btn-export:hover,
.btn-copy:hover,
.btn-open:hover{
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(15,23,42,.25);
  filter:brightness(1.03);
}

.btn-clear:active,
.btn-save:active,
.btn-export:active,
.btn-copy:active,
.btn-open:active{
  transform:translateY(0);
  box-shadow:0 1px 4px rgba(15,23,42,.45);
  filter:brightness(.98);
}

.btn-clear:focus-visible,
.btn-save:focus-visible,
.btn-export:focus-visible,
.btn-copy:focus-visible,
.btn-open:focus-visible{
  outline:none;
  box-shadow:
    0 0 0 1px #0f172a,
    0 0 0 3px rgba(59,130,246,.5);
}

/* Individual button treatments */

/* Clear / reset */
.btn-clear{
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  color:#f9fafb;
  border-color:rgba(185,28,28,.9);
}
.btn-clear:hover{
  background:linear-gradient(135deg,#f05252,#b91c1c);
}

/* Save */
.btn-save{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#f9fafb;
  border-color:rgba(22,163,74,.9);
}
.btn-save:hover{
  background:linear-gradient(135deg,#34d399,#16a34a);
}

/* Export */
.btn-export{
  background:linear-gradient(135deg,#4f46e5,#4338ca);
  color:#f9fafb;
  border-color:rgba(67,56,202,.95);
}
.btn-export:hover{
  background:linear-gradient(135deg,#6366f1,#4338ca);
}

/* Add Plan */
.addPlanbtn:hover{
  background:var(--bg);
}

/* Copy */
.btn-copy{
  background:linear-gradient(135deg,#0f766e,#0e7490);
  color:#f9fafb;
  border-color:rgba(15,118,110,.95);
}
.btn-copy:hover{
  background:linear-gradient(135deg,#14b8a6,#0e7490);
}

/* Open Presenter */
.btn-open{
  background:linear-gradient(135deg,#be123c,#9f1239);
  color:#fdf2f8;
  border-color:rgba(159,18,57,.95);
  box-shadow:0 6px 22px rgba(24,24,27,.35);
  padding:.65rem 1rem;
  font-weight:700;
}
.btn-open:hover{
  background:linear-gradient(135deg,#e11d48,#9f1239);
}

.addPlanbtn{ background: var(--accent); color:#fff; border:1px solid transparent; border-radius:8px; padding:6px 10px; font-size:.72rem; cursor:pointer; }

/* 10) Term rows */
.term-row{
  display:grid; grid-template-columns: 20px 115px minmax(160px,1fr);
  gap:2px; align-items:center; margin-bottom:6px;
}
.term-label{ font-size:.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Preset panel (compact, now inside Plans card) */
.presets-panel{
  margin: 6px 0 10px;
  padding: 8px 10px;
  background: var(--card-muted);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: none;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.presets-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:.75rem;
  margin-bottom:4px;
}
.presets-header h3{
  margin:0;
  font-size: .9rem;
}
.presets-header p{
  margin:.15rem 0 0;
  font-size:.78rem;
  color: var(--ink);
}

/* Small button */
.btn-small{
  padding:.35rem .3rem;
  font-size:.8rem;
  border-radius:999px;
  background:linear-gradient(90deg,#191970,#4b0082);
  color:#f9fafb;
}

/* Grouped list */
.preset-list{
  max-height: 140px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:.5rem;
}

.presets-empty{
  margin:0;
  font-size:.82rem;
  color: var(--ink);
}

/* Group container */
.preset-group{
  border-radius:8px;
  border:1px solid var(--border);
  padding:.4rem .5rem;
  background: #ffffff;
}
.preset-group__label{
  font-size:.72rem;
  text-transform:uppercase;
  letter-spacing:.08em;
  color: var(--ink);
  margin:0 0 .25rem;
}
.preset-group__pills{
  display:flex;
  flex-wrap:wrap;
  gap:.25rem;
  padding: 0 0 0 24px;
}

/* Individual draggable preset “pill” */
.preset-pill{
  display:inline-flex;
  align-items:center;
  padding:.25rem .5rem;
  border-radius:999px;
  background:#eef2ff;
  color:#111;
  font-size:.75rem;
  border:1px solid var(--border);
  cursor:grab;
  user-select:none;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
}
.preset-pill:hover{
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  background:#e0e7ff;
}
.preset-pill:active{
  cursor:grabbing;
  transform: translateY(0);
  box-shadow:none;
}
.preset-pill.is-dragging{
  opacity:.8;
  box-shadow: var(--shadow-md);
}

/* Drop hint on plan contents */
[data-plan-content="true"].preset-drop-target{
  outline: 2px dashed var(--accent);
  outline-offset: 2px;
}

/* 11) Plans container grid */
#plansContainer{
  display:grid; gap:16px;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  align-items:start;
}
@media (max-width:780px){ #plansContainer{ grid-template-columns: 1fr; } }
@media (max-width:300px){ #plansContainer{ grid-template-columns: .98fr; } }

/* 12) Plan card in Builder (editor) */
.plan-card{
  background: var(--card-bg);
  border:1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 10px 12px;
  display:flex; flex-direction:column; gap:8px;
  min-height:190px; min-width:0;
  box-shadow: var(--shadow-sm);
  transition: box-shadow .15s ease, transform .15s ease, border-color .15s ease;
}
.plan-card:hover{ transform: translateY(-1px); box-shadow: var(--shadow-md); }

/* Header + fields */
.plan-card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.plan-card-title{ font-weight:700; font-size:.85rem; }

.plan-card-topfields{ display:grid; grid-template-columns: 1fr; gap:6px; margin-bottom:4px; }
.plan-card .field{ display:grid; gap:4px; }
.plan-card label{ font-size:.78rem; color:#334155; }

/* 13) Toolbar (RTE controls) */
.plan-toolbar{
  display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin: 4px 0 8px;
}
.plan-toolbar button,
.plan-toolbar select,
.plan-toolbar input[type="color"]{
  border:1px solid rgba(0,0,0,.15);
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  font-size:.8rem; cursor:pointer;
  transition: background .12s ease, transform .12s ease, box-shadow .12s ease;
}
.plan-toolbar button:hover{ background:#f6f6f6; transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.plan-toolbar input[type="color"].rte-color{ width:34px; height:28px; padding:0; border-radius:8px; }
.plan-toolbar .rte-size-select{ display:none !important; }

/* 14) Plan Contents (RTE area) */
.plan-contents.rte{
  min-height: 120px; max-height: 260px; max-width:100%;
  overflow:auto;
  background:#fff;
  border:2px solid rgba(0,0,0,.08);
  border-radius:12px;
  padding:10px 12px;
  font-size:.95rem; line-height:1.5;
  overflow-wrap:anywhere; word-break:break-word;
}
.plan-contents.rte:focus{ outline:2px solid rgba(25,25,112,.25); }
.plan-contents.rte p{ margin:.4rem 0; }
.plan-contents.rte ul, .plan-contents.rte ol{ margin:.25rem 0 .25rem 1.1rem; padding:0; }
.plan-contents.rte li{ margin:3px 0; }
.plan-contents.rte a{ text-decoration: underline; }

/* Avoid extra space at edges */
.plan-contents.rte > *:first-child{ margin-top:0 !important; }
.plan-contents.rte > *:last-child{  margin-bottom:0 !important; }

/* 15) Info panel bullets */
.bullet-list{ margin:0; padding-left:1.2rem; list-style:disc; }
.bullet-list li{ margin:6px 0; line-height:1.45; }
.bullet-list li::marker{ color:#e1251b; }
.footnote{ margin-top:10px; font-size:.95rem; color:#475569; }

/* 16) Footer */
.site-footer{
  border-top:1px solid var(--border);
  padding:16px 24px; text-align:center; color:#e7ecf3;
}

/* 17) Print polish (builder exports/print dialog) */
@page{ size: A3 portrait; margin: 10mm; }
@media print{
  html, body{
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    background: #fff;
  }
  .page-header, .form-top-actions{ color:#000; }
  .ln-btn, .btn-clear, .btn-save, .btn-export, .addPlanbtn{ filter: none !important; box-shadow:none !important; }
}
  </style>
</head>
<!-- PASSCODE GATE (front-end only) -->
<div id="gate" style="
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background: var(--bg); padding:24px;
">
  <div style="
    width:min(420px, 92vw);
    background:#fff; border-radius:16px; padding:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  ">
    <div style="font-weight:800; font-size:1.05rem; margin-bottom:6px;">LNPresents Builder</div>
    <div style="color:#5b6470; font-size:.9rem; margin-bottom:12px;">Enter passcode to continue.</div>

    <div style="display:flex; gap:8px;">
      <input id="gateCode" type="password" placeholder="Passcode"
        style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); outline:none;">
      <button id="gateBtn"
        style="padding:10px 12px; border-radius:10px; border:0; cursor:pointer; color:#fff; background:#4b0082;">
        Unlock
      </button>
    </div>

    <div id="gateErr" style="display:none; color:#b91c1c; font-size:.85rem; margin-top:10px;">
      Incorrect passcode.
    </div>

    <label style="display:flex; gap:8px; align-items:center; margin-top:12px; color:#334155; font-size:.85rem;">
      <input id="gateRemember" type="checkbox">
      Remember on this device
    </label>
  </div>
</div>

<script>
(function(){
  // CHANGE THIS:
  const PASSCODE = "937";

  const gate = document.getElementById("gate");
  const input = document.getElementById("gateCode");
  const btn = document.getElementById("gateBtn");
  const err = document.getElementById("gateErr");
  const remember = document.getElementById("gateRemember");

  // if remembered, skip gate
  try{
    if (localStorage.getItem("LNP_BUILDER_UNLOCKED") === "1") {
      gate.remove();
      return;
    }
  } catch(e){}

  function unlock(){
    if (input.value === PASSCODE) {
      err.style.display = "none";
      if (remember.checked) {
        try{ localStorage.setItem("LNP_BUILDER_UNLOCKED", "1"); } catch(e){}
      }
      gate.remove();
    } else {
      err.style.display = "block";
      input.select();
    }
  }

  btn.addEventListener("click", unlock);
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlock(); });

  // autofocus
  setTimeout(()=>input.focus(), 50);
})();
</script>
<body>
  <!-- ========== HEADER ========== -->
  <header class="page-header">
    <div class="page-header-left">
      <h1>LNPresents - Builder</h1>
      <p>
        Welcome to the LexisNexis Proposal Builder for LNPresents.
        Fill out this form and show up to four proposals with up to five term details selected to present on LNPresents.
        The plan contents support basic text formatting (bold, italic, underline, bulletpoint, and color).
      </p>
    </div>
  </header>

  <!-- ========== TOP ACTIONS ========== -->
  <div class="form-top-actions">
    <button type="button" id="clearBtn" class="btn-clear">Clear</button>
    <button type="submit" form="clgForm" id="saveBtn" class="btn-save">Save Details</button>
    <button id="openPresenterBtn" type="button" class="btn-open">Open Presenter</button>
    <span id="copyProposalBtn"  hidden aria-hidden="true"></span>

    <script>
      const PRESENTER_URL  = './LNPresents-Presenter.html';
      const PRESENTER_NAME = 'lnp_presenter_tab';
      let presenterWin = null;

      function openPresenter() {
        presenterWin = window.open(PRESENTER_URL, PRESENTER_NAME);
        if (presenterWin) {
          try { presenterWin.focus(); } catch (e) {}
        } else {
          location.href = PRESENTER_URL;
        }
      }

      document.getElementById('openPresenterBtn')
        .addEventListener('click', openPresenter);
    </script>

    <!-- Export button kept; placeholder keeps scripts happy -->
    <span id="exportEmailBtn" hidden aria-hidden="true"></span>
  </div>

  <!-- ========== FORM ========== -->
  <div class="form-shell">
    <form id="clgForm">
      <!-- 1) Firm Details -->
      <div class="card">
        <h2>Firm Details</h2>
        <div class="top-grid">
          <div class="top-simple">
            <div class="top-field">
              <label>Firm Name</label>
              <input type="text" data-key="clgFirmName" placeholder="Law Office of LexisNexis" class="input-style">
            </div>
            <div class="top-field">
              <label>Incentive</label>
              <input type="text" data-key="clgIncentive" placeholder="Customers get more value than ever" class="input-style">
            </div>
          </div>

          <div class="top-term-row">
            <div class="top-field term-style">
              <div class="term-check">
                <input type="checkbox" data-term-option="numAttorneys">
                <span class="box"></span>
              </div>
              <div class="top-label">Attorney Count</div>
              <div>
                <select data-key="clgNumAttorneys">
                  <option value="">Select…</option>
                  <option>1</option><option>2</option><option>3</option><option>4</option>
                  <option>5</option><option>6</option><option>7</option><option>8</option>
                  <option>9</option><option>10</option>
                </select>
              </div>
            </div>

            <div class="top-field yoy-row">
              <div class="term-check">
                <input type="checkbox" data-term-option="yoyIncrease">
                <span class="box"></span>
              </div>
              <div class="top-label">Year over Year increase</div>
              <div><input type="text" data-key="clgYoyIncrease" placeholder="3%" class="input-style"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2) Side-by-side panels -->
      <div class="form-panel-row">
        <div class="card">
          <h2>Terms</h2>
          <div class="tab-row">
            <button type="button" class="tab-btn active" data-panel="retentionPanel">Retention</button>
            <button type="button" class="tab-btn" data-panel="newBizPanel">New Business</button>
          </div>
          <div id="retentionPanel" class="panel active"><div id="retentionTerms"></div></div>
          <div id="newBizPanel" class="panel"><div id="newBizTerms"></div></div>
        </div>

        <!-- NEW: Save / Load Profiles card with filename input -->
        <div class="card">
  <h2>Save / Load Profiles</h2>
  <p class="lede">Export or import full Builder details (firm, terms, and plans).</p>
  <div class="card-info">
    <div class="profile-card-controls">
      <button type="button" id="downloadProfileBtn" class="btn-export">
        Download Profile
      </button>

      <label class="profile-upload">
        <span>Load Profile JSON</span>
        <input type="file" id="uploadProfileInput" accept="application/json">
      </label>
    </div>
    <p class="muted-text">
      When you download, you’ll be asked to name the file. If you leave it blank,
      the Firm Name (or <strong>lnpresents-profile</strong>) will be used and
      <strong>.json</strong> will be added.
    </p>
  </div>
</div>


        <div class="card">
          <p class="lede">Quick tips for using LNPresents:</p>
          <ul class="bullet-list">
            <li>You may choose up to <strong>six</strong> terms to show above your plans.</li>
            <li>You may show up to <strong>four</strong> plans at once.</li>
            <li>Plan contents support basic styling, color, and <a href="https://example.com" target="_blank" rel="noopener">hyperlinks</a>. Highlight to style; clear to reset.</li>
            <li>Click the button below to <strong>Submit Feature Requests</strong> or <strong>Report Bugs</strong>.</li>
          </ul>
          <a
            class="ln-btn ln-btn--sm"
            role="button"
            aria-label="Send LN Presents feedback email"
            href="mailto:chase.lawarregardner@lexisnexis.com
            ?subject=LN%20Presents%20Feedback
            &amp;body=Hello,%0D%0A%0D%0AThanks%20for%20using%20LN%20Presents!%20Please%20answer%20these%20questions%20when%20sending%20feedback%20or%20reporting%20bugs.%0D%0A%0D%0AFeature%20Request%20or%20Bug%3F%0D%0A%0D%0ADescribe%20the%20idea%20or%20issue%3F%0D%0A%0D%0AIf%20bug,%20list%20steps%20to%20reproduce.%0D%0A%0D%0AOther%20Information%20or%20suggestions%3F%0D%0A%0D%0ADo%20I%20have%20your%20permission%20to%20reach%20out%20to%20you%20to%20seek%20more%20detail%20about%20your%20submission,%20if%20necessary%3F">
            Send Feedback
          </a>
        </div>
      </div>

      <!-- 3) Plans -->
      <div class="card" id="plansSection">
        <h2>Plans</h2>

        <!-- Plan content presets panel (JSON + drag & drop, compact, drag-only) -->
        <div class="presets-panel">
          <div class="presets-header">
            <div>
              <h3>Plan Content Presets</h3>
              <p>Drag a preset into a plan's Contents area to start from a template.</p>
            </div>
            <span id="reloadPresetsBtn"  hidden aria-hidden="true"></span>
          </div>
          <div id="presetList" class="preset-list">
            <p class="presets-empty">Loading presets…</p>
          </div>
        </div>

        <button type="button" id="addPlanBtn" class="addPlanbtn" style="addPlanbtn">+ Add Plan</button>
        <div id="plansContainer"></div>
      </div>
    </form>
  </div>

  <footer class="site-footer">
    <small>&copy; <span>LexisNexis</span></small>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js" crossorigin="anonymous"></script>

<!-- ========== APP SCRIPT ========== -->
<script>
  document.addEventListener("DOMContentLoaded", function () {

    /* =========================
     * A) DOM REFERENCES
     * ========================= */
    const form = document.getElementById("clgForm");
    const retentionHost = document.getElementById("retentionTerms");
    const newBizHost = document.getElementById("newBizTerms");
    const plansContainer = document.getElementById("plansContainer");
    const addPlanBtn = document.getElementById("addPlanBtn");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const tabs = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".panel");
    const exportBtn = document.getElementById('exportEmailBtn');
    const emailProposalBtn = document.getElementById("emailProposalBtn");
    const copyProposalBtn = document.getElementById("copyProposalBtn");

    // NEW: profile save/load controls
    const downloadProfileBtn = document.getElementById("downloadProfileBtn");
    const uploadProfileInput = document.getElementById("uploadProfileInput");

    /* =========================
     * B) CONSTANTS & FORMATTERS
     * ========================= */
    const MAX_PLANS = 4;
    const MAX_TERM_SELECTIONS = 6;
    const currencyFmt = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" });

    /* =========================
     * C) TERM DEFINITIONS
     * ========================= */
    const retentionTerms = [
      { key: "currentSpend",     label: "Current Spend",     input: { type: "text", dataKey: "clgCurrentSpend",    placeholder: "$0.00" }, defaultSelected: false },
      { key: "effectiveDate",    label: "Effective Date",    input: { type: "date", dataKey: "clgEffectiveDate" },  defaultSelected: false },
      { key: "currentTermEnd",   label: "Current Term End",  input: { type: "date", dataKey: "clgCurrentTermEnd" }, defaultSelected: false },
      { key: "extensionTermEnd", label: "Extension Term End",input: { type: "date", dataKey: "clgExtensionTermEnd"}, defaultSelected: false },
      { key: "extensionTerm",    label: "Term Extension",    input: { type: "select", dataKey: "clgExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] }, defaultSelected: false }
    ];

    const newBizTerms = [
      { key: "ActivationDate", label: "Activation Date", input: { type: "date", dataKey: "clgActivationDate" }, defaultSelected: false },
      { key: "introPrice",     label: "Promo Price",     input: { type: "text", dataKey: "clgIntroPrice", placeholder: "$0.00" }, defaultSelected: false },
      { key: "termStartDate",  label: "Promo End Date",  input: { type: "date", dataKey: "clgTermStartDate" }, defaultSelected: false },
      { key: "termEndDate",    label: "Term End Date",   input: { type: "date", dataKey: "clgTermEndDate" }, defaultSelected: false },
      { key: "nbExtensionTerm",label: "Term Length",     input: { type: "select", dataKey: "clgnbExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] }, defaultSelected: false }
    ];

    /* =========================
     * D) PERSISTED & STATE
     * ========================= */
    const saved = JSON.parse(localStorage.getItem("clgFormVars") || "{}");

    function makeEmptyPlan() {
      return { clgPlatform: "", clgPriceCents: null, clgPrice: "", clgContents: "" };
    }

    const state = {
      clgFirmName: saved.clgFirmName || "",
      clgNumAttorneys: saved.clgNumAttorneys || "",
      clgYoyIncrease: saved.clgYoyIncrease || "",
      clgIncentive: saved.clgIncentive || "",
      clgSelectedTerms: Array.isArray(saved.clgSelectedTerms) ? saved.clgSelectedTerms : [],
      clgPlans: Array.isArray(saved.clgPlans) && saved.clgPlans.length ? saved.clgPlans : [makeEmptyPlan()]
    };

    // NEW: snapshot -> used by Save & profile download
    function buildProfilePayload() {
      return {
        clgFirmName: state.clgFirmName,
        clgNumAttorneys: state.clgNumAttorneys,
        clgYoyIncrease: state.clgYoyIncrease,
        clgIncentive: state.clgIncentive,
        clgSelectedTerms: state.clgSelectedTerms,
        clgCurrentSpend: state.clgCurrentSpend,
        clgEffectiveDate: state.clgEffectiveDate,
        clgActivationDate: state.clgActivationDate,
        clgCurrentTermEnd: state.clgCurrentTermEnd,
        clgTermEndDate: state.clgTermEndDate,
        clgExtensionTermEnd: state.clgExtensionTermEnd,
        clgExtensionTerm: state.clgExtensionTerm,
        clgnbExtensionTerm: state.clgnbExtensionTerm,
        clgIntroPrice: state.clgIntroPrice,
        clgTermStartDate: state.clgTermStartDate,
        clgPlans: state.clgPlans
      };
    }

    // NEW: hydrate DOM from current state (top fields + term selections)
    function hydrateFormFromState() {
      form.querySelectorAll("[data-key]").forEach(el => {
        const key = el.getAttribute("data-key");
        if (!key) return;
        const value = state[key];
        el.value = value != null ? value : "";
      });

      form.querySelectorAll("[data-term-option]").forEach(cb => {
        const key = cb.getAttribute("data-term-option");
        if (!key) return;
        const selected = Array.isArray(state.clgSelectedTerms) && state.clgSelectedTerms.includes(key);
        cb.checked = selected;
      });
    }

    // NEW: apply profile JSON to state + DOM + storage
    function applyLoadedProfile(raw) {
      if (!raw || typeof raw !== "object") {
        alert("That file does not look like an LN Presents profile.");
        return;
      }

      const data = raw.data && typeof raw.data === "object" ? raw.data : raw;

      state.clgFirmName = data.clgFirmName || "";
      state.clgNumAttorneys = data.clgNumAttorneys || "";
      state.clgYoyIncrease = data.clgYoyIncrease || "";
      state.clgIncentive = data.clgIncentive || "";
      state.clgSelectedTerms = Array.isArray(data.clgSelectedTerms) ? data.clgSelectedTerms : [];
      state.clgCurrentSpend = data.clgCurrentSpend || "";
      state.clgEffectiveDate = data.clgEffectiveDate || "";
      state.clgActivationDate = data.clgActivationDate || "";
      state.clgCurrentTermEnd = data.clgCurrentTermEnd || "";
      state.clgTermEndDate = data.clgTermEndDate || "";
      state.clgExtensionTermEnd = data.clgExtensionTermEnd || "";
      state.clgExtensionTerm = data.clgExtensionTerm || "";
      state.clgnbExtensionTerm = data.clgnbExtensionTerm || "";
      state.clgIntroPrice = data.clgIntroPrice || "";
      state.clgTermStartDate = data.clgTermStartDate || "";
      state.clgPlans = Array.isArray(data.clgPlans) && data.clgPlans.length ? data.clgPlans : [makeEmptyPlan()];

      hydrateFormFromState();
      renderPlans();

      const toSave = buildProfilePayload();
      localStorage.setItem("clgFormVars", JSON.stringify(toSave));
      buildAppConfigFromState(state);
    }

    /* =========================
     * E) GENERIC HELPERS
     * ========================= */
    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
    }

    function fmtDate(iso) {
      if (!iso) return "";
      try { return new Date(iso + "T00:00:00").toLocaleDateString(); }
      catch { return iso; }
    }

    // RTE Normalization helpers
    const SIZE_PRESET_CLASSES = ['rte-size-body','rte-size-subhead','rte-size-head'];
    const SIZE_PRESET_ORDER = ['body','subhead','head'];
    const SIZE_PRESETS = {
      body:{px:14, class:'rte-size-body'},
      subhead:{px:17, class:'rte-size-subhead'},
      head:{px:19, class:'rte-size-head'}
    };

    function closestPreset(px){
      let best = 'body', bestDiff = Infinity;
      for (const key of SIZE_PRESET_ORDER){
        const d = Math.abs(px - SIZE_PRESETS[key].px);
        if (d < bestDiff){ bestDiff = d; best = key;
        }
      }
      return best;
    }

    /* ===== NEW HELPERS FOR MORE OUTLOOK-FRIENDLY COPY ===== */

    // Grab just what's inside <body>…</body> so we paste only the email body
    function extractBodyHtmlFromEmail(fullHtml) {
      const match = fullHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      return match ? match[1] : fullHtml;
    }

    // First try execCommand('copy') from a hidden contenteditable (better for Outlook),
    // then fall back to modern Clipboard APIs.
    async function copyEmailHtmlWithFallback(fullHtml) {
      const fragmentHtml = extractBodyHtmlFromEmail(fullHtml);
      let success = false;

      try {
        const temp = document.createElement('div');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        temp.style.top = '0';
        temp.style.opacity = '0';
        temp.setAttribute('contenteditable', 'true');
        temp.innerHTML = fragmentHtml;

        document.body.appendChild(temp);

        const range = document.createRange();
        range.selectNodeContents(temp);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        success = document.execCommand('copy');

        sel.removeAllRanges();
        document.body.removeChild(temp);
      } catch (e) {
        console.warn('execCommand copy failed:', e);
      }

      if (success) return true;

      // Fallback: modern clipboard APIs (great for Gmail, Apple Mail, etc.)
      try {
        if (navigator.clipboard && window.ClipboardItem) {
          const blobHtml = new Blob([fragmentHtml], { type: 'text/html' });
          const blobText = new Blob(
            [fragmentHtml.replace(/<[^>]+>/g, '')],
            { type: 'text/plain' }
          );
          const item = new ClipboardItem({
            'text/html': blobHtml,
            'text/plain': blobText
          });
          await navigator.clipboard.write([item]);
          return true;
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(fragmentHtml);
          return true;
        }
      } catch (err) {
        console.error('Async clipboard failed:', err);
      }

      return false;
    }

    /* ===== UPDATED COPY BUTTON HANDLER (Outlook-friendly) ===== */
    if (copyProposalBtn) {
      copyProposalBtn.addEventListener('click', async () => {
        const data = {
          clgFirmName:      state.clgFirmName,
          clgNumAttorneys:  state.clgNumAttorneys,
          clgYoyIncrease:   state.clgYoyIncrease,
          clgIncentive:     state.clgIncentive,
          clgSelectedTerms: state.clgSelectedTerms,
          clgCurrentSpend:  state.clgCurrentSpend,
          clgEffectiveDate: state.clgEffectiveDate,
          clgActivationDate: state.clgActivationDate,
          clgCurrentTermEnd: state.clgCurrentTermEnd,
          clgTermEndDate:    state.clgTermEndDate,
          clgExtensionTermEnd: state.clgExtensionTermEnd,
          clgExtensionTerm:    state.clgExtensionTerm,
          clgnbExtensionTerm:  state.clgnbExtensionTerm,
          clgIntroPrice:       state.clgIntroPrice,
          clgTermStartDate:    state.clgTermStartDate
        };

        const plans = (state.clgPlans || []).map((p, idx) => ({
          name:     p.clgPlatform || `Plan ${idx + 1}`,
          price:    p.clgPrice || "",
          term:     "",
          contents: p.clgContents || ""
        }));

        const fullHtml = buildEmailHtml(plans, data);

        const ok = await copyEmailHtmlWithFallback(fullHtml);
        if (ok) {
          alert("Proposal copied. In Outlook, click into the message body and paste.");
        } else {
          alert("Could not copy automatically. As a fallback, use the Export Email HTML option, open it in a browser, then copy & paste into Outlook.");
        }
      });
    }

    function applyTextPresetMapping(doc){
      const mapEl = (el) => {
        el.classList.remove(...SIZE_PRESET_CLASSES);
        const tag = el.tagName.toLowerCase();

        if (['h1','h2','h3'].includes(tag)) {
          el.classList.add(tag === 'h1' ? 'rte-size-head' : 'rte-size-subhead');
        }
        const style = el.getAttribute('style') || '';
        const m = /font-size\s*:\s*([0-9.]+)\s*(px|pt|rem|em)/i.exec(style);
        if (m) {
          const val = parseFloat(m[1]);
          const unit = (m[2] || 'px').toLowerCase();
          let px = val;
          if (unit === 'pt')  px = val * (96/72);
          if (unit === 'rem' || unit === 'em') px = val * 16;
          el.classList.add(SIZE_PRESETS[closestPreset(px)].class);
        }
        if (style) {
          const color = /color\s*:\s*[^;]+/i.exec(style);
          if (color) el.setAttribute('style', color[0]); else el.removeAttribute('style');
        }
      };
      doc.querySelectorAll('p, li, span, h1, h2, h3').forEach(mapEl);
    }

    function blockifyTopLevel(doc){
      [...doc.body.childNodes].forEach(node=>{
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') {
          const p = doc.createElement('p'); p.textContent = node.textContent; node.replaceWith(p);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toLowerCase();
          if (!['p','ul','ol'].includes(tag)) {
            const p = doc.createElement('p'); p.innerHTML = node.outerHTML; node.replaceWith(p);
          }
        }
      });
    }

    function normalizeForPaste(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      applyTextPresetMapping(doc);

      // Flatten lists ONLY on paste
      doc.querySelectorAll('ul, ol').forEach(list => {
        const frag = doc.createDocumentFragment();
        list.querySelectorAll('li').forEach(li => {
          const p = doc.createElement('p');
          p.innerHTML = li.innerHTML;
          frag.appendChild(p);
        });
        list.replaceWith(frag);
      });

      blockifyTopLevel(doc);
      doc.querySelectorAll('h1,h2,h3').forEach(h => { if (!h.textContent.trim()) h.remove(); });
      return doc.body.innerHTML || '<p><br></p>';
    }

    function normalizeForStorage(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      applyTextPresetMapping(doc);
      blockifyTopLevel(doc);
      doc.querySelectorAll('h1,h2,h3').forEach(h => { if (!h.textContent.trim()) h.remove(); });
      return doc.body.innerHTML || '<p><br></p>';
    }

    function sanitizeAndReplaceIfChanged(editor){
      const before = editor.innerHTML;
      const cleaned = DOMPurify.sanitize(before, PLAN_RTE_ALLOWED);
      const normalized = normalizeForStorage(cleaned);

      if (normalized !== before) {
        const y = editor.scrollTop;
        const lockH = editor.clientHeight;
        editor.style.minHeight = lockH + 'px';
        editor.innerHTML = normalized;
        editor.scrollTop = y;
        requestAnimationFrame(()=> { editor.style.minHeight = ''; });
      }
    }

    function parseCurrencyToCents(str) {
      const normalized = String(str).replace(/[^0-9.]/g, "");
      if (!normalized) return null;
      const num = Number(normalized);
      if (Number.isNaN(num)) return null;
      return Math.round(num * 100);
    }

    function parsePercentToBps(str) {
      const normalized = String(str).replace(/[^0-9.\-]/g, "");
      if (!normalized) return null;
      const num = Number(normalized);
      if (Number.isNaN(num)) return null;
      const pct = num <= 1 ? num * 100 : num;
      return Math.round(pct * 100);
    }

    function normalizePlan(raw) {
      if (!raw) return {};
      return {
        name: raw.clgPlatform || raw.name || raw.planName || 'Plan',
        price: raw.clgPrice || raw.price || raw.planPrice || '',
        contents: raw.clgContents || raw.contents || raw.planContents || '',
        term: raw.term || raw.selectedTerm || raw.selectedTerms || ''
      };
    }

    function getProposalData() {
      if (window.clgFormVars) return window.clgFormVars;
      const ls = localStorage.getItem('clgFormVars') || localStorage.getItem('lnpresentsFormVars');
      if (ls) { try { return JSON.parse(ls); } catch (e) { console.warn('Could not parse proposal from localStorage', e); } }
      return { plans: [] };
    }

    function downloadEmailHtml(content, filename) {
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function buildSelectedTermsHtml(data = {}) {
      const sel = Array.isArray(data.clgSelectedTerms) ? data.clgSelectedTerms : [];
      if (!sel.length) return "";
      const items = [];

      const add = (key, label, value, type) => {
        if (!sel.includes(key)) return;
        let out = label;
        if (value) out += ": " + (type === "date" ? fmtDate(value) : value);
        items.push(
          '<li style="margin:0 0 4px 0; font-size:12px; color:#374151;">' +
          escapeHtml(out) +
          '</li>'
        );
      };

      add("numAttorneys","Number of Attorneys",data.clgNumAttorneys);
      add("yoyIncrease","Year over Year increase",data.clgYoyIncrease);

      add("currentSpend","Current Spend",data.clgCurrentSpend);
      add("effectiveDate","Effective Date",data.clgEffectiveDate,"date");
      add("currentTermEnd","Current Term End",data.clgCurrentTermEnd,"date");
      add("extensionTermEnd","Extension Term End",data.clgExtensionTermEnd,"date");
      add("extensionTerm","Term Extension",data.clgExtensionTerm);

      add("ActivationDate","Activation Date",data.clgActivationDate,"date");
      add("introPrice","Promo Price",data.clgIntroPrice);
      add("termStartDate","Promo End Date",data.clgTermStartDate,"date");
      add("termEndDate","Term End Date",data.clgTermEndDate,"date");
      add("nbExtensionTerm","Term Length",data.clgnbExtensionTerm);

      return items.join("");
    }

    function buildEmailHtml(plans, data, opts = {}) {
      const firm = (data && (data.clgFirmName || data.firmName)) || "Firm Name";
      const incentive = data && data.clgIncentive ? data.clgIncentive : "";
      const termsListHtml = buildSelectedTermsHtml(data);

      // Chunk plans into rows of 2 for the inner table
      const planRows = (plans && plans.length ? plans : []).reduce((rows, plan, idx) => {
        if (idx % 2 === 0) rows.push([plan]);
        else rows[rows.length - 1].push(plan);
        return rows;
      }, []);

      const planTableHtml = planRows.length
        ? planRows
          .map(rowPlans => `
          <tr>
            ${rowPlans
              .map(plan => `
                <td width="50%" valign="top" style="padding:12px 10px 14px 10px; border-bottom:1px solid #e5e7eb;">
                  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
                    <tr>
                      <td style="font-size:14px; font-weight:600; color:#111827; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 4px 0;">
                        ${escapeHtml(plan.name || "Plan")}
                      </td>
                    </tr>
                    ${
                      plan.price
                        ? `<tr>
                             <td style="font-size:13px; color:#111827; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 2px 0;">
                               <strong>Price:</strong> ${escapeHtml(plan.price)}
                             </td>
                           </tr>`
                        : ""
                    }
                    ${
                      plan.term
                        ? `<tr>
                             <td style="font-size:12px; color:#4b5563; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 6px 0;">
                               <strong>Term:</strong> ${escapeHtml(plan.term)}
                             </td>
                           </tr>`
                        : ""
                    }
                    ${
                      plan.contents
                        ? `<tr>
                             <td style="font-size:12px; color:#374151; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; line-height:1.5;">
                               ${plan.contents}
                             </td>
                           </tr>`
                        : ""
                    }
                  </table>
                </td>
              `)
              .join("")}
            ${
              rowPlans.length === 1
                ? `<td width="50%" valign="top" style="padding:12px 10px 14px 10px; border-bottom:1px solid #e5e7eb;">
                     &nbsp;
                   </td>`
                : ""
            }
          </tr>
        `)
        .join("")
        : "";

      return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Proposal</title>
</head>
<body style="margin:0; padding:0; background:#ffffff;">
  <!-- Single narrow card aligned left -->
  <table width="600" align="left" cellpadding="0" cellspacing="0" border="0" style="width:600px; margin:16px 0 16px 16px;">
    <tr>
      <td align="left" valign="top" style="padding:0;">
        <!-- Card wrapper (header + details + plans + footer) -->
        <table width="100%" cellpadding="0" cellspacing="0" border="0"
               style="border-collapse:separate; border-radius:8px; border:1px solid #e5e7eb; background-color:#ffffff; overflow:hidden;">
          <!-- Header -->
          <tr>
            <td style="padding:16px 20px; background:linear-gradient(90deg,#191970,#4b0082); color:#ffffff; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <div style="font-size:12px; text-transform:uppercase; letter-spacing:.1em; opacity:.9;">LexisNexis</div>
              <div style="margin-top:2px; font-size:18px; font-weight:700;">Proposal Summary</div>
              <div style="margin-top:4px; font-size:13px; opacity:.9;">${escapeHtml(firm)}</div>
              ${
                incentive
                  ? `<div style="margin-top:4px; font-size:12px; opacity:.9;">
                       <strong>Incentive:</strong> ${escapeHtml(incentive)}
                     </div>`
                  : ""
              }
            </td>
          </tr>

          <!-- Selected Terms -->
          <tr>
            <td style="padding:14px 20px; border-bottom:1px solid #e5e7eb; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <div style="font-size:13px; font-weight:600; color:#111827; margin-bottom:6px;">Proposal Details</div>
              ${
                termsListHtml
                  ? `<ul style="list-style:none; margin:0; padding:0;">${termsListHtml}</ul>`
                  : `<p style="margin:0; font-size:12px; color:#6b7280;">(No terms selected)</p>`
              }
            </td>
          </tr>

          <!-- Plans (2 per row) -->
          ${
            planTableHtml
              ? `
                <tr>
                  <td style="padding:0 12px 8px 12px; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
                    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
                      ${planTableHtml}
                    </table>
                  </td>
                </tr>`
              : ""
          }

          <!-- Footer -->
          <tr>
            <td style="padding:10px 20px 14px 20px; text-align:center; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <p style="margin:0; font-size:11px; color:#9ca3af;">
                LexisNexis Confidential
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;
    }

    /* =========================
     * F) RENDERERS
     * ========================= */
    function renderTermPanel(host, termList) {
      host.innerHTML = "";
      termList.forEach(term => {
        const row = document.createElement("div");
        row.className = "term-row";

        const checkWrap = document.createElement("div");
        checkWrap.className = "term-check";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.setAttribute("data-term-option", term.key);
        const box = document.createElement("span");
        box.className = "box";
        cb.checked = term.defaultSelected === true;
        checkWrap.appendChild(cb);
        checkWrap.appendChild(box);

        const label = document.createElement("div");
        label.className = "term-label";
        label.textContent = term.label;

        let inputEl;
        if (term.input.type === "select") {
          inputEl = document.createElement("select");
          inputEl.setAttribute("data-key", term.input.dataKey);
          term.input.options.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt; o.textContent = opt === "" ? "-- choose --" : opt;
            inputEl.appendChild(o);
          });
        } else {
          inputEl = document.createElement("input");
          inputEl.type = term.input.type;
          inputEl.setAttribute("data-key", term.input.dataKey);
          if (term.input.placeholder) inputEl.placeholder = term.input.placeholder;
        }

        if (saved[term.input.dataKey]) inputEl.value = saved[term.input.dataKey];

        row.appendChild(checkWrap);
        row.appendChild(label);
        row.appendChild(inputEl);
        host.appendChild(row);
      });
    }

    function renderPlans() {
      plansContainer.innerHTML = "";
      state.clgPlans.forEach((plan, idx) => {
        const card = document.createElement("div");
        card.className = "plan-card";
        card.innerHTML = `
          <div class="plan-card-header">
            <div class="plan-card-title">Plan ${idx + 1}</div>
            <button type="button" class="secondary" data-remove="${idx}">Remove</button>
          </div>

          <div class="plan-card-topfields">
            <div class="field">
              <label>Platform</label>
              <input type="text" data-plan-idx="${idx}" data-plan-field="clgPlatform" value="${plan.clgPlatform || ""}">
            </div>
            <div class="field">
              <label>Plan Price</label>
              <input type="text" data-plan-idx="${idx}" data-plan-field="clgPrice" value="${plan.clgPrice || ""}" placeholder="$0.00">
            </div>
          </div>

          <div class="field">
            <label>Plan Contents</label>

            <div class="plan-toolbar" data-plan-idx="${idx}" role="toolbar" aria-label="Formatting">
              <button type="button" data-cmd="bold" title="Bold (⌘/Ctrl+B)"><b>B</b></button>
              <button type="button" data-cmd="italic" title="Italic (⌘/Ctrl+I)"><i>I</i></button>
              <button type="button" data-cmd="underline" title="Underline (⌘/Ctrl+U)"><u>U</u></button>
              <button type="button" data-cmd="insertUnorderedList" title="Bulleted list">• • •</button>
              <button type="button" data-cmd="insertOrderedList" title="Numbered list">1.</button>
              <button type="button" data-cmd="createLink" title="Add link (⌘/Ctrl+K)">Link</button>
              <button type="button" class="rte-color-btn"></button>
              <input type="color" class="rte-color" aria-label="Text color">
              <select data-size-select class="rte-size-select" aria-label="Text size">
                <option value="body">Body</option>
                <option value="subhead">Subhead</option>
                <option value="head">Head</option>
              </select>
              <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
            </div>

           <div class="plan-contents rte" contenteditable="true" data-plan-content="true"
              data-plan-idx="${idx}" data-plan-field="clgContents"
              placeholder="Type or paste content. Use ⌘/Ctrl+B, I, U. Bullets and links supported.">
              ${(plan.clgContents || '').trim() || '<p><br></p>'}
           </div>

            <small class="muted-text">Tip: Use ⌘/Ctrl+B, I, U. Click list buttons for bullets. ⌘/Ctrl+K for links.</small>
          </div>
        `;
        plansContainer.appendChild(card);
      });

      if (state.clgPlans.length >= MAX_PLANS) {
        addPlanBtn.disabled = true; addPlanBtn.textContent = "Max plans reached";
      } else {
        addPlanBtn.disabled = false; addPlanBtn.textContent = "+ Add Plan";
      }
    }

    function buildAppConfigFromState(s) {
      const termMap = {};
      termMap.numAttorneys = { key: "numAttorneys", label: s.clgNumAttorneys ? "Number of Attorneys: " + s.clgNumAttorneys : "Number of Attorneys" };
      termMap.yoyIncrease =  { key: "yoyIncrease",  label: s.clgYoyIncrease  ? "Year over Year increase: " + s.clgYoyIncrease : "Year over Year increase" };

      function makeLabelFromTermDef(termDef) {
        const dataKey = termDef.input?.dataKey;
        const baseLabel = termDef.label;
        const rawVal = dataKey ? s[dataKey] : "";
        if (termDef.input?.type === "date") {
          return { key: termDef.key, label: rawVal ? baseLabel + ": " + fmtDate(rawVal) : baseLabel };
        }
        if (rawVal && rawVal !== "") {
          const needsColon = !baseLabel.endsWith(":");
          return { key: termDef.key, label: baseLabel + (needsColon ? ": " : " ") + rawVal };
        }
        return { key: termDef.key, label: baseLabel };
      }

      retentionTerms.forEach(termDef => { termMap[termDef.key] = makeLabelFromTermDef(termDef); });
      newBizTerms.forEach(termDef => { termMap[termDef.key] = makeLabelFromTermDef(termDef); });

      const delivered = [];
      for (const key of s.clgSelectedTerms || []) {
        if (termMap[key]) delivered.push(termMap[key]);
        if (delivered.length >= 6) break;
      }

      const plans = (s.clgPlans || []).map((plan, idx) => ({
        id: idx + 1,
        title: plan.clgPlatform || `Plan ${idx + 1}`,
        price: plan.clgPrice || "",
        contentsHtml: plan.clgContents || ""
      }));

      window.APP_CONFIG = {
        ui: {
          companyName: s.clgFirmName || "Default Firm",
          subhead: s.clgIncentive || "",
          terms: delivered,
          plans: plans
        }
      };
    }

    /* =========================
     * G) RTE SANITIZE/HOOKS
     * ========================= */
    const PLAN_RTE_ALLOWED = {
      ALLOWED_TAGS: ['b','strong','i','em','u','p','br','ul','ol','li','a','span'],
      ALLOWED_ATTR: ['href','target','rel','style','class'],
      FORBID_TAGS: ['style','script','iframe','object','embed','form','input','button','img','video','audio']
    };

    if (window.DOMPurify && DOMPurify.addHook) {
      DOMPurify.addHook('uponSanitizeAttribute', (node, data) => {
        if (data.attrName !== 'style') return;
        const m = /color\s*:\s*([^;]+)/i.exec(data.attrValue);
        if (m) { data.attrValue = `color:${m[1].trim()}`; } else { data.keepAttr = false; }
      });
    }

    const planSelectionByIdx = {};
    function rememberSelectionFor(el){
      const idx = el.getAttribute('data-plan-idx');
      const sel = window.getSelection();
      if (!idx || !sel || sel.rangeCount === 0) return;
      planSelectionByIdx[idx] = sel.getRangeAt(0);
    }
    function restoreSelectionFor(idx, editor){
      const r = planSelectionByIdx[idx];
      if (!r) return;
      const sel = window.getSelection();
      editor.focus();
      sel.removeAllRanges();
      sel.addRange(r);
    }

    // selection + color handling
    (() => {
      const rangeByEditor = new WeakMap();

      function getCurrentRange() {
        const sel = window.getSelection();
        return (sel && sel.rangeCount) ? sel.getRangeAt(0).cloneRange() : null;
      }

      function restoreRange(range) {
        if (!range) return false;
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        return true;
      }

      document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (!sel || !sel.anchorNode) return;
        const editor = sel.anchorNode.nodeType === 1
          ? sel.anchorNode.closest?.('.plan-contents.rte')
          : sel.anchorNode.parentElement?.closest?.('.plan-contents.rte');
        if (editor) {
          const r = getCurrentRange();
          if (r) rangeByEditor.set(editor, r);
        }
      });

      document.addEventListener('mousedown', (e) => {
        const btn = e.target.closest('.plan-toolbar button, .plan-toolbar .ln-btn');
        if (btn) e.preventDefault();
      });

      let savedRange = null;

      function saveSelection() {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          savedRange = sel.getRangeAt(0).cloneRange();
        }
      }

      document.addEventListener('change', (e) => {
        const colorInput = e.target.closest('.plan-toolbar input[type="color"].rte-color');
        if (!colorInput) return;

        const card = colorInput.closest('.plan-card');
        const editor = card?.querySelector('.plan-contents.rte');
        if (!editor) return;

        const saved = rangeByEditor.get(editor);

        requestAnimationFrame(() => {
          editor.focus({ preventScroll: true });
          restoreRange(saved);

          const color = colorInput.value;
          applyColorByWrap(color);
        });
      });

      function applyColorByWrap(color) {
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) return;

        const range = sel.getRangeAt(0);
        if (range.collapsed) return;

        const frag = range.extractContents();
        const span = document.createElement('span');
        span.style.color = color;

        if (frag.childNodes.length === 1 &&
            frag.firstChild.nodeType === 1 &&
            frag.firstChild.nodeName === 'SPAN' &&
            frag.firstChild.style?.color === color) {
          range.insertNode(frag.firstChild);
        } else {
          span.appendChild(frag);
          range.insertNode(span);
          span.normalize();
        }

        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.addRange(newRange);
      }
    })();

    function textToParagraphs(t){
      const esc = t.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      return '<p>'+esc.split(/\n{2,}/).map(s=>s.replace(/\n/g,'<br>')).join('</p><p>')+'</p>';
    }

    function insertHtmlAtCursor(editor, html){
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) { editor.insertAdjacentHTML('beforeend', html); return; }
      let range = sel.getRangeAt(0);
      if (!editor.contains(range.startContainer)) { editor.focus(); range = window.getSelection().getRangeAt(0); }
      range.deleteContents();
      const frag = range.createContextualFragment(html);
      const last = frag.lastChild;
      range.insertNode(frag);
      if (last){
        range.setStartAfter(last);
        range.collapse(true);
        sel.removeAllRanges(); sel.addRange(range);
      }
    }

    const SIZE_MAP = {
      body:    { px: 14, className: 'rte-size-body'    },
      subhead: { px: 17, className: 'rte-size-subhead' },
      head:    { px: 19, className: 'rte-size-head'    }
    };
    const SIZE_ORDER = ['body','subhead','head'];

    function closestSize(px){
      let best = 'body', bestDiff = Infinity;
      for (const key of SIZE_ORDER){
        const d = Math.abs(px - SIZE_MAP[key].px);
        if (d < bestDiff){ bestDiff = d; best = key;
        }
      }
      return best;
    }

    function convertFontTagsToSpan(rootEl){
      rootEl.querySelectorAll('font[color]').forEach(font => {
        const span = document.createElement('span');
        const color = font.getAttribute('color');
        if (color) span.setAttribute('style', `color:${color}`);
        span.innerHTML = font.innerHTML;
        font.replaceWith(span);
      });
    }

    function syncPlanContents(idx, editor){
      sanitizeAndReplaceIfChanged(editor);
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    }

    const SIZE_CLASS_SET = ['rte-size-body','rte-size-subhead','rte-size-head'];
    const SIZE_CLASS_BY_KEY = { body:'rte-size-body', subhead:'rte-size-subhead', head:'rte-size-head' };

    function stripSizeClassesIn(root){
      root.querySelectorAll('span').forEach(s=>{
        const had = SIZE_CLASS_SET.some(cls => s.classList.contains(cls));
        if (had){
          s.classList.remove(...SIZE_CLASS_SET);
          if (!s.getAttribute('class')) s.removeAttribute('class');
        }
      });
    }

    function insertLinkWithLabel(editor){
      const url = prompt('Link URL:');
      if (!url) return;
      const label = prompt('Link label (text to show):');
      if (!label) return;

      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      let range = sel.getRangeAt(0);
      if (!editor.contains(range.commonAncestorContainer)) return;

      range.deleteContents();
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = label;
      range.insertNode(a);

      range = document.createRange();
      range.setStartAfter(a); range.collapse(true);
      sel.removeAllRanges(); sel.addRange(range);
    }

    function applySizeClassToSelection(editor, classKey){
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount === 0) return;
      let range = sel.getRangeAt(0);
      if (!editor.contains(range.commonAncestorContainer)) { editor.focus(); return; }
      if (range.collapsed) return;
      const frag = range.cloneContents();
      const tmp = document.createElement('div'); tmp.appendChild(frag);
      stripSizeClassesIn(tmp);
      const wrapper = document.createElement('span');
      wrapper.classList.add(SIZE_CLASS_BY_KEY[classKey]);
      while (tmp.firstChild) wrapper.appendChild(tmp.firstChild);
      range.deleteContents(); range.insertNode(wrapper);
      range = document.createRange(); range.selectNodeContents(wrapper); range.collapse(false);
      sel.removeAllRanges(); sel.addRange(range);
    }

    /* =========================
     * H) EVENT WIRING
     * ========================= */

    // Hydrate top fields from state (initial)
    form.querySelectorAll("[data-key]").forEach(el => {
      const key = el.getAttribute("data-key");
      if (state[key]) el.value = state[key];
    });

    // Render term panels
    renderTermPanel(retentionHost, retentionTerms);
    renderTermPanel(newBizHost, newBizTerms);

    // Tabs
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-panel");
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        panels.forEach(p => p.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });

      // === PRESETS: DRAG → DROP AT CARET POSITION ===

// 1) Track caret position inside each plan body
let currentRange = null;
const planBodies = document.querySelectorAll('.plan-body[contenteditable="true"]');

planBodies.forEach(el => {
  const saveCaret = () => {
    const sel = window.getSelection();
    if (sel && sel.rangeCount > 0) {
      currentRange = sel.getRangeAt(0);
    }
  };

  el.addEventListener('mouseup', saveCaret);
  el.addEventListener('keyup', saveCaret);
  el.addEventListener('focus', saveCaret);

  // Allow drop
  el.addEventListener('dragover', e => {
    e.preventDefault();
  });

  el.addEventListener('drop', e => {
    e.preventDefault();

    const presetHTML =
      e.dataTransfer.getData('text/html') ||
      e.dataTransfer.getData('text/plain');

    if (!presetHTML) return;

    // Use last known caret, or fallback to end of this plan body
    let range = currentRange;
    if (!range) {
      range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
    }

    const fragment = range.createContextualFragment(presetHTML);
    range.insertNode(fragment);

    // Move caret after inserted content
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
});

// 2) Make presets draggable and carry HTML content
const presetItemsInitial = document.querySelectorAll('.preset-item');

presetItemsInitial.forEach(item => {
  item.setAttribute('draggable', 'true');

  item.addEventListener('dragstart', e => {
    // If you already store the HTML in a data attribute, use that:
    const html = item.dataset.html || item.innerHTML;
    e.dataTransfer.setData('text/html', html);
  });
});
    });

    // Clear
    function clearForm() {
      form.querySelectorAll("[data-key]").forEach(el => { el.value = ""; });
      form.querySelectorAll("[data-term-option]").forEach(cb => { cb.checked = false; });

      state.clgFirmName = "";
      state.clgNumAttorneys = "";
      state.clgYoyIncrease = "";
      state.clgIncentive = "";
      state.clgSelectedTerms = [];
      state.clgCurrentSpend = "";
      state.clgEffectiveDate = "";
      state.clgActivationDate = "";
      state.clgExtensionTermEnd = "";
      state.clgCurrentTermEnd = "";
      state.clgTermEndDate = "";
      state.clgExtensionTerm = "";
      state.clgnbExtensionTerm = "";
      state.clgIntroPrice = "";
      state.clgTermStartDate = "";
      state.clgPlans = [makeEmptyPlan()];
      renderPlans();
      localStorage.removeItem("clgFormVars");
      buildAppConfigFromState(state);
    }
    clearBtn.addEventListener("click", clearForm);

    // Plans initial render
    renderPlans();

    // Plan inputs
    plansContainer.addEventListener("input", function (e) {
      const field = e.target.getAttribute("data-plan-field");
      const idxStr = e.target.getAttribute("data-plan-idx");
      if (!field || idxStr == null) return;

      const idx = Number(idxStr);
      if (!state.clgPlans[idx]) return;

      let val = e.target.value;

      if (field === "clgPrice") {
        state.clgPlans[idx].clgPrice = val;
        const cents = parseCurrencyToCents(val);
        state.clgPlans[idx].clgPriceCents = (cents == null ? null : cents);
        return;
      }

      if (field === "clgPlatform") {
        state.clgPlans[idx].clgPlatform = val;
        return;
      }

      if (field === "clgContents") {
        state.clgPlans[idx].clgContents = val;
      }
    });

    plansContainer.addEventListener("blur", function (e) {
      const field = e.target.getAttribute("data-plan-field");
      const idxStr = e.target.getAttribute("data-plan-idx");
      if (field !== "clgPrice" || idxStr == null) return;

      const idx = Number(idxStr);
      const cents = parseCurrencyToCents(e.target.value);
      if (cents != null) {
        const pretty = currencyFmt.format(cents / 100);
        e.target.value = pretty;
        state.clgPlans[idx].clgPrice = pretty;
        state.clgPlans[idx].clgPriceCents = cents;
      }
    }, true);

    // Plans: remove
    plansContainer.addEventListener("click", function (e) {
      const rem = e.target.getAttribute("data-remove");
      if (rem != null) {
        state.clgPlans.splice(Number(rem), 1);
        if (state.clgPlans.length === 0) state.clgPlans.push(makeEmptyPlan());
        renderPlans();
      }
    });

    // Plans: add
    addPlanBtn.addEventListener("click", function () {
      if (state.clgPlans.length >= MAX_PLANS) return;
      state.clgPlans.push(makeEmptyPlan());
      renderPlans();
    });

    // Form input (top-level)
    form.addEventListener("input", function (e) {
      const key = e.target.getAttribute("data-key");
      if (!key) return;

      if (key === "clgCurrentSpend" || key === "clgIntroPrice") {
        const cents = parseCurrencyToCents(e.target.value);
        state[key] = cents == null ? "" : currencyFmt.format(cents / 100);
        return;
      }

      if (key === "clgYoyIncrease") {
        const bps = parsePercentToBps(e.target.value);
        state.clgYoyIncrease = bps == null ? "" : (bps / 100).toFixed(2).replace(/\.00$/, "") + "%";
        return;
      }

      state[key] = e.target.value;
    });

    // Term checkbox selection
    form.addEventListener("change", function (e) {
      const termKey = e.target.getAttribute("data-term-option");
      if (!termKey) return;

      let selected = Array.isArray(state.clgSelectedTerms) ? [...state.clgSelectedTerms] : [];
      if (e.target.checked) {
        if (!selected.includes(termKey)) {
          if (selected.length >= MAX_TERM_SELECTIONS) { e.target.checked = false; return; }
          selected.push(termKey);
        }
      } else {
        selected = selected.filter(k => k !== termKey);
      }
      state.clgSelectedTerms = selected;
    });

    // Export -> HTML file
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        const data = getProposalData();
        const rawPlans = data.clgPlans || data.plans || data.planCards || (data.form?.plans) || [];
        const plans = rawPlans.map(normalizePlan);
        const emailHtml = buildEmailHtml(plans, data);
        downloadEmailHtml(emailHtml, 'proposal-email.html');
      });
    }

    document.getElementById('exportEmailBtn').addEventListener('click', () => {
      const data = getProposalData();
      const rawPlans = data.plans || data.planCards || data.form?.plans || [];
      const plans = rawPlans.map(normalizePlan);
      const emailHtml = buildEmailHtml(plans, data);
      downloadEmailHtml(emailHtml, 'proposal-email.html');
    });

    // Email Proposal button (if present)
    if (emailProposalBtn) {
      emailProposalBtn.addEventListener('click', () => {
        const data = {
          clgFirmName:      state.clgFirmName,
          clgNumAttorneys:  state.clgNumAttorneys,
          clgYoyIncrease:   state.clgYoyIncrease,
          clgIncentive:     state.clgIncentive,
          clgSelectedTerms: state.clgSelectedTerms,
          clgCurrentSpend:  state.clgCurrentSpend,
          clgEffectiveDate: state.clgEffectiveDate,
          clgActivationDate: state.clgActivationDate,
          clgCurrentTermEnd: state.clgCurrentTermEnd,
          clgTermEndDate:    state.clgTermEndDate,
          clgExtensionTermEnd: state.clgExtensionTermEnd,
          clgExtensionTerm:    state.clgExtensionTerm,
          clgnbExtensionTerm:  state.clgnbExtensionTerm,
          clgIntroPrice:       state.clgIntroPrice,
          clgTermStartDate:    state.clgTermStartDate
        };

        const plans = (state.clgPlans || []).map((p, idx) => ({
          name:     p.clgPlatform || `Plan ${idx + 1}`,
          price:    p.clgPrice || "",
          term:     "",
          contents: p.clgContents || ""
        }));

        const html = buildEmailHtml(plans, data);
        const subject = `LexisNexis Proposal – ${data.clgFirmName || 'Proposal'}`;
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(html)}`;
        window.location.href = mailto;
      });
    }

   // NEW: Download Profile (JSON) with popup filename prompt
if (downloadProfileBtn) {
  downloadProfileBtn.addEventListener("click", () => {
    const payload = {
      meta: {
        app: "LNPresents-Builder",
        version: 1,
        exportedAt: new Date().toISOString()
      },
      data: buildProfilePayload()
    };

    // Suggested base from firm name or default
    const suggestedBase = state.clgFirmName || "lnpresents-profile";

    // Ask the user for a name (no extension)
    let rawBase = window.prompt(
      "File name for this profile (no extension):",
      suggestedBase
    );

    // If user cancels, do nothing
    if (rawBase === null) return;

    rawBase = rawBase.trim();
    if (!rawBase) {
      rawBase = suggestedBase;
    }

    let safeBase = rawBase
      .toLowerCase()
      .replace(/[^a-z0-9\-]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");

    if (!safeBase) safeBase = "lnpresents-profile";

    const filename = `${safeBase}.json`;

    const blob = new Blob([JSON.stringify(payload, null, 2)], {
      type: "application/json"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  });
}

    // NEW: Upload Profile (JSON) with overwrite confirmation
    if (uploadProfileInput) {
      uploadProfileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const json = JSON.parse(text);

          const ok = window.confirm(
            "Load this profile and overwrite all current Builder details (firm info, terms, and plan contents)?"
          );
          if (!ok) return;

          applyLoadedProfile(json);
          alert("Profile loaded into Builder.");
        } catch (err) {
          console.error("Error loading profile:", err);
          alert("Could not load that file. Make sure it was exported from LN Presents Builder.");
        } finally {
          e.target.value = "";
        }
      });
    }

    // Save
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const toSave = buildProfilePayload();
      localStorage.setItem("clgFormVars", JSON.stringify(toSave));
      buildAppConfigFromState(state);
      const original = saveBtn.textContent;
      saveBtn.textContent = "Saved ✓";
      setTimeout(() => (saveBtn.textContent = original), 1200);
    });

    /* =========================
     * I) RTE INTERACTIONS
     * ========================= */
    plansContainer.addEventListener('input', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      const idx = Number(editor.getAttribute('data-plan-idx'));
      if (Number.isNaN(idx)) return;
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    });

    ['mouseup','keyup','touchend'].forEach(ev=>{
      plansContainer.addEventListener(ev, (e)=>{
        const editor = e.target.closest('.plan-contents[contenteditable]');
        if (editor) rememberSelectionFor(editor);
      });
    });

    plansContainer.addEventListener('paste', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      e.preventDefault();
      const html = (e.clipboardData && e.clipboardData.getData('text/html')) || '';
      const text = (e.clipboardData && e.clipboardData.getData('text/plain')) || '';
      const incoming = html && html.trim() ? html : textToParagraphs(text);
      const cleaned = DOMPurify.sanitize(incoming, PLAN_RTE_ALLOWED);
      const normalized = normalizeForPaste(cleaned);
      insertHtmlAtCursor(editor, normalized);
      const idx = Number(editor.getAttribute('data-plan-idx'));
      syncPlanContents(idx, editor);
      convertFontTagsToSpan(editor);
    });

    plansContainer.addEventListener('keydown', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      const mod = e.ctrlKey || e.metaKey;
      if (!mod) return;
      const k = e.key.toLowerCase();
      if (!['b','i','u','k'].includes(k)) return;
      e.preventDefault();
      if (k === 'b') document.execCommand('bold');
      if (k === 'i') document.execCommand('italic');
      if (k === 'u') document.execCommand('underline');
      if (k === 'k') {
        const url = prompt('URL to link:');
        if (url) {
          document.execCommand('createLink', false, url);
          editor.querySelectorAll('a').forEach(a=>{ a.target='_blank'; a.rel='noopener noreferrer'; });
        }
      }
      convertFontTagsToSpan(editor);
      const idx = Number(editor.getAttribute('data-plan-idx'));
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    });

    plansContainer.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cmd]');
      if (!btn) return;
      const toolbar = btn.closest('.plan-toolbar');
      const idx = toolbar?.getAttribute('data-plan-idx');
      if (idx == null) return;
      const editor = plansContainer.querySelector('.plan-contents[data-plan-idx="'+idx+'"]');
      if (!editor) return;
      restoreSelectionFor(idx, editor);
      const cmd = btn.getAttribute('data-cmd');
      if (cmd === 'createLink') {
        insertLinkWithLabel(editor);
      } else if (cmd === 'removeFormat') {
        document.execCommand('removeFormat', false, null);
        editor.querySelectorAll('a').forEach(a=>{ a.replaceWith(document.createTextNode(a.textContent)); });
      } else if (cmd !== 'foreColor') {
        document.execCommand(cmd, false, null);
      }

      convertFontTagsToSpan(editor);
      const i = Number(idx);
      if (state.clgPlans[i]) state.clgPlans[i].clgContents = editor.innerHTML;
    });

    const presetItems = document.querySelectorAll('.preset-item');

// keep focus in the plan body when interacting with presets
presetItems.forEach(item => {
  item.setAttribute('draggable', 'true');

  // ⛔ prevent focus change on mousedown so the content box keeps focus
  item.addEventListener('mousedown', e => {
    e.preventDefault();

    // restore caret into the active body if we have one
    if (activeBody && currentRange) {
      activeBody.focus();
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(currentRange);
    }
  });

  // drag payload (for drag-to-insert)
  item.addEventListener('dragstart', e => {
    const html = item.dataset.html || item.innerHTML;
    e.dataTransfer.setData('text/html', html);
  });

  // OPTIONAL: click-to-insert at last caret (if you ever want it)
  /*
  item.addEventListener('click', e => {
    e.preventDefault();
    if (!activeBody) return;

    activeBody.focus();

    let range = currentRange;
    if (!range) {
      range = document.createRange();
      range.selectNodeContents(activeBody);
      range.collapse(false);
    }

    const html = item.dataset.html || item.innerHTML;
    const fragment = range.createContextualFragment(html);
    range.insertNode(fragment);

    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
  */
});
    document.addEventListener('selectionchange', ()=>{
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const node = sel.anchorNode;
      if (!node) return;
      const editor = node.nodeType === 1 ? node.closest('.plan-contents[contenteditable]')
                                         : node.parentElement?.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      rememberSelectionFor(editor);
    });

    plansContainer.addEventListener('focusout', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      sanitizeAndReplaceIfChanged(editor);
      convertFontTagsToSpan(editor);
      const idx = Number(editor.getAttribute('data-plan-idx'));
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    });

    plansContainer.addEventListener('change', (e)=>{
      if (!e.target.matches('[data-cmd="foreColor"]')) return;
      const toolbar = e.target.closest('.plan-toolbar');
      const idx = toolbar?.getAttribute('data-plan-idx');
      const editor = plansContainer.querySelector('.plan-contents[data-plan-idx="'+idx+'"]');
      if (!editor) return;
      restoreSelectionFor(idx, editor);
      try { document.execCommand('styleWithCSS', false, true); } catch(_) {}
      document.execCommand('foreColor', false, e.target.value);
      try { document.execCommand('styleWithCSS', false, false); } catch(_) {}
      convertFontTagsToSpan(editor);
      const i = Number(idx);
      if (state.clgPlans[i]) state.clgPlans[i].clgContents = editor.innerHTML;
    });

    // Duplicate but harmless fmtDate
    function fmtDate(iso) {
      if (!iso) return "";
      return new Date(iso + "T00:00:00").toLocaleDateString();
    }

   // =========================
   // PRESETS: load from GitHub + drag/drop with {{STATE}} injection
   // =========================

const PRESETS_URL = "https://raw.githubusercontent.com/chase-gardner/LN-Presents/refs/heads/main/Plan-Presets.json";

const presetListEl = document.getElementById("presetList");
const STATE_TOKEN_RE = /\{\{\s*STATE\s*\}\}/gi;

let allPresets = [];
let draggedPreset = null;
let lastPresetState = localStorage.getItem("lnpPresetState") || "";

// Fetch presets from GitHub on load
async function loadPlanPresetsFromGitHub() {
  if (!presetListEl) return;

  presetListEl.innerHTML = `<p class="presets-empty">Loading presets…</p>`;

  try {
    const res = await fetch(PRESETS_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    allPresets = Array.isArray(json) ? json : [];
    renderPresetGroups(allPresets);
  } catch (err) {
    console.error("Error loading presets:", err);
    presetListEl.innerHTML = `<p class="presets-empty">Could not load presets from GitHub. Please try again later.</p>`;
  }
}

// Group by "group" and render pills (drag-only)
function renderPresetGroups(presets) {
  if (!presets.length) {
    presetListEl.innerHTML = `<p class="presets-empty">No presets found in Plan-Presets.json.</p>`;
    return;
  }

  // group -> [presets]
  const byGroup = {};
  presets.forEach(p => {
    const g = p.group || "Other";
    if (!byGroup[g]) byGroup[g] = [];
    byGroup[g].push(p);
  });

  presetListEl.innerHTML = "";

  Object.keys(byGroup).sort().forEach(groupName => {
    const groupEl = document.createElement("div");
    groupEl.className = "preset-group";

    const label = document.createElement("div");
    label.className = "preset-group__label";
    label.textContent = groupName;
    groupEl.appendChild(label);

    byGroup[groupName].forEach(preset => {
      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "preset-pill";
      pill.textContent = preset.name || "Preset";
      pill.draggable = true;

      // keep ref to the preset object
      pill.dataset.presetName = preset.name || "";
      pill.dataset.usesState = STATE_TOKEN_RE.test(preset.contents || "") ? "true" : "false";

      pill.addEventListener("dragstart", (e) => {
        draggedPreset = preset;
        e.dataTransfer.effectAllowed = "copy";
        e.dataTransfer.setData("text/plain", preset.name || "Preset");
      });

      pill.addEventListener("dragend", () => {
        draggedPreset = null;
      });

      // NOTE: no click handler here – presets are drag-only

      groupEl.appendChild(pill);
    });

    presetListEl.appendChild(groupEl);
  });
}
let currentRange = null;
let activeBody = null;

const planBodies2 = document.querySelectorAll('.plan-body[contenteditable="true"]');

planBodies2.forEach(el => {
  const saveCaret = () => {
    const sel = window.getSelection();
    if (sel && sel.rangeCount > 0) {
      currentRange = sel.getRangeAt(0);
      activeBody = el;
    }
  };

  el.addEventListener('focus', saveCaret);
  el.addEventListener('mouseup', saveCaret);
  el.addEventListener('keyup', saveCaret);
});

// Apply preset contents into a specific editor, with {{STATE}} injection if needed
function applyPresetToEditor(editor, preset) {
  if (!editor || !preset) return;

  let raw = String(preset.contents || "");

  // If this preset uses {{STATE}}, ask the user once per use
  if (STATE_TOKEN_RE.test(raw)) {
    const userState = window.prompt(
      "Enter the State for this proposal (e.g., Florida):",
      lastPresetState || ""
    );

    // If user cancels, do nothing
    if (userState === null) return;

    lastPresetState = userState.trim();
    if (lastPresetState) {
      localStorage.setItem("lnpPresetState", lastPresetState);
    }

    raw = raw.replace(STATE_TOKEN_RE, lastPresetState || "");
  }

  // Turn plain text (with \n and • bullets) into paragraphs
  const html = textToParagraphs(raw);
  const cleaned = DOMPurify.sanitize(html, PLAN_RTE_ALLOWED);

  // Insert at cursor; don’t flatten lists like normal paste
  insertHtmlAtCursor(editor, cleaned);
}

// Make plan contents act as drop targets
plansContainer.addEventListener("dragover", (e) => {
  const editor = e.target.closest('[data-plan-content="true"]');
  if (!editor || !draggedPreset) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = "copy";
  editor.classList.add("preset-drop-target");
});

plansContainer.addEventListener("dragleave", (e) => {
  const editor = e.target.closest('[data-plan-content="true"]');
  if (!editor) return;
  editor.classList.remove("preset-drop-target");
});

plansContainer.addEventListener("drop", (e) => {
  const editor = e.target.closest('[data-plan-content="true"]');
  if (!editor || !draggedPreset) return;
  e.preventDefault();
  editor.classList.remove("preset-drop-target");

  applyPresetToEditor(editor, draggedPreset);

  const idx = Number(editor.getAttribute("data-plan-idx"));
  syncPlanContents(idx, editor);
});

// Kick off GitHub preset load when the app boots
loadPlanPresetsFromGitHub();

    /* =========================
     * J) INITIAL CONFIG BUILD
     * ========================= */
    buildAppConfigFromState(state);
  });
</script>
</body>
</html>
