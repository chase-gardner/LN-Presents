<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LNPresents - Builder</title>
<style>
/* ===============================
   LNPresents — Builder REVIVED UI + COLLAPSIBLE SIDEBAR
   - Desktop: sticky sidebar (same layout)
   - Small screens: sidebar becomes off-canvas panel with overlay + toggle button
   =============================== */

/* 1) Tokens */
:root{
  --bg: linear-gradient(90deg,#191970,#4b0082);
  --surface: #0b1222;
  --card-bg: #ffffff;
  --card-muted:#f7f8fb;
  --input-bg:#ffffff;

  --text:#0b0f19;
  --ink:#5b6470;
  --border: rgba(15,23,42,.10);

  --accent: linear-gradient(90deg,#191970,#4b0082);
  --accent-solid:#4b0082;
  --accent-ink:#fff;

  --radius-xl:22px;
  --radius-lg:18px;
  --radius-md:14px;
  --radius-sm:12px;

  --shadow-1: 0 10px 30px rgba(2,6,23,.10);
  --shadow-2: 0 18px 50px rgba(2,6,23,.16);
  --shadow-3: 0 26px 80px rgba(2,6,23,.22);

  --ring: 0 0 0 4px rgba(99,102,241,.25);

  --maxw: 1280px;
  --pad: clamp(14px, 2.2vw, 24px);

  /* Off-canvas */
  --panel-w: min(380px, 92vw);
  --panel-z: 99990;
}

/* Optional themes */
[data-theme="indigo"]{ --accent-solid:#4b0082; }
[data-theme="ln-red"]{ --bg:linear-gradient(90deg,#8b0000,#cc0000); --accent:linear-gradient(90deg,#8b0000,#cc0000); --accent-solid:#cc0000; }
[data-theme="emerald"]{ --bg:linear-gradient(90deg,#065f46,#059669); --accent:linear-gradient(90deg,#065f46,#059669); --accent-solid:#059669; }
[data-theme="slate"]{ --bg:linear-gradient(90deg,#334155,#0f172a); --accent:linear-gradient(90deg,#334155,#0f172a); --accent-solid:#334155; }
[data-theme="midnight"]{
  --surface:#070b14;
  --card-bg:#0f172a;
  --card-muted:#0b1320;
  --text:#e5e7eb;
  --ink:#b8c0cc;
  --border:rgba(255,255,255,.10);
  --accent-solid:#7c3aed;
  --accent: linear-gradient(90deg,#4c1d95,#7c3aed);
}

/* 2) Base */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background: var(--bg);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}

/* Dramatic stage lighting */
body::before{
  content:"";
  position:fixed;
  inset:-2px;
  pointer-events:none;
  background:
    radial-gradient(900px 380px at 16% 6%, rgba(255,255,255,.18), transparent 62%),
    radial-gradient(900px 420px at 86% 8%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(700px 520px at 70% 88%, rgba(255,255,255,.10), transparent 62%),
    linear-gradient(180deg, rgba(2,6,23,.40), rgba(2,6,23,.08));
  mix-blend-mode: overlay;
  opacity:.95;
}

a{ color:inherit; text-decoration:none; }
h1,h2,h3{ margin:0; }

@media (prefers-reduced-motion: reduce){
  *{ animation:none !important; transition:none !important; }
}

/* 3) Header */
.page-header{
  max-width:var(--maxw);
  margin: 26px auto 12px;
  padding: 0 var(--pad);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:16px;
  flex-wrap:wrap;
}
.page-header-left{ flex:1 1 620px; min-width:0; }
.page-header h1{
  font-size: clamp(1.2rem, 2.8vw, 1.7rem);
  font-weight: 600;
  letter-spacing:.01em;
  text-shadow: 0 18px 40px rgba(0,0,0,.30);
}
.page-header p{
  font-size: clamp(.85rem, 1.25vw, 1rem);
  line-height:1.55;
  opacity:.93;
  max-width: 78ch;
  margin-top:8px;
  text-shadow: 0 14px 26px rgba(0,0,0,.22);
}

/* 4) Top action row */
.form-top-actions{
  max-width:var(--maxw);
  margin: 0 auto 12px;
  padding: 0 var(--pad);
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* 5) Shell */
.form-shell{
  max-width:var(--maxw);
  margin: 0 auto;
  padding: 0 var(--pad) 26px;
}

/* stage wrapper */
.builder-layout{
  display:flex;
  gap:14px;
  align-items:flex-start;

  background: rgba(2,6,23,.42);
  border: 1px solid rgba(255,255,255,.16);
  border-radius: var(--radius-xl);
  padding: 14px;
  box-shadow: var(--shadow-3);
  backdrop-filter: blur(12px);
}

/* Desktop sidebar + main */
.builder-sidebar{
  flex: 0 0 320px;
  min-width: 280px;
  position: sticky;
  top: 16px;
}
.builder-main{ flex: 1 1 auto; min-width:0; }

/* 6) Cards */
.card{
  background: rgba(255,255,255,.94);
  border: 1px solid rgba(15,23,42,.10);
  border-radius: var(--radius-lg);
  padding: 14px 14px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-1);
  position:relative;
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(900px 160px at 15% 0%, rgba(99,102,241,.18), transparent 60%),
    radial-gradient(900px 140px at 85% 0%, rgba(255,255,255,.20), transparent 58%);
  opacity:.65;
}
.card h2{
  font-size: 1.02rem;
  font-weight: 600;
  letter-spacing:.01em;
  margin: 0 0 10px;
}
.lede{
  margin:0 0 10px;
  color:#334155;
  font-weight:550;
  line-height:1.5;
}
.card-info{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.08);
  border-radius: var(--radius-md);
  padding: 14px 14px;
  box-shadow: 0 14px 30px rgba(2,6,23,.06);
}

/* ===============================
   Header Upload Preview
   =============================== */
.header-preview-wrap{
  border: 1px solid rgba(15,23,42,.10);
  border-radius: 14px;
  background: rgba(255,255,255,.92);
  padding: 10px;
  box-shadow: 0 14px 30px rgba(2,6,23,.06);
  overflow:flex;
}
.clearUploadedHeaderBtn{
  background: var(--accent-solid);
  color:#fff;
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 14px;
  margin: 0, 0, 0, .5rem;
  padding: 6px 10px;
  font-size: .74rem;
  font-weight: 750;
  cursor:pointer;
  box-shadow: 0 22px 60px rgba(2,6,23,.18);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.downloadProfileBtn{
  background: var(--accent-solid);
  color:#fff;
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 14px;
  margin: 0, 0, 0, .5rem;
  padding: 6px 10px;
  font-size: .74rem;
  font-weight: 750;
  cursor:pointer;
  box-shadow: 0 22px 60px rgba(2,6,23,.18);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}

.header-preview-meta{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  font-size:.82rem;
  font-weight:750;
  color:#0f172a;
  margin-bottom:2px;
}
#headerPreviewImg{
  width: 100%;
  height: auto;
  display:none; /* shown when we have an image */
  border-radius: 10px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(248,250,252,.9);
}

/* =========================================
   Profile Upload — Revived Drop Zone
   ========================================= */

.profile-upload{
  /* layout */
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;

  /* spacing */
  margin-top:14px;              /* ⬅ ensures padding from content above */
  padding:14px 16px;

  /* visuals */
  background: linear-gradient(
    180deg,
    rgba(248,250,252,.98),
    rgba(241,245,249,.95)
  );
  border: 2px dashed rgba(99,102,241,.35);
  border-radius: 16px;

  /* text */
  font-size:.85rem;
  font-weight:700;
  letter-spacing:.01em;
  color:#1e293b;

  /* interaction */
  cursor:pointer;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 10px 26px rgba(2,6,23,.08);

  transition:
    border-color .16s ease,
    background .16s ease,
    box-shadow .16s ease,
    transform .12s ease;
}

/* Label text */
.profile-upload span{
  pointer-events:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

/* Optional icon (future-safe) */
.profile-upload span::before{
  content:"⬆";
  font-size:.1.2rem;
  opacity:.75;
}

/* Hover */
.profile-upload:hover{
  background: linear-gradient(
    180deg,
    rgba(238,242,255,.98),
    rgba(224,231,255,.96)
  );
  border-color: rgba(99,102,241,.65);
  transform: translateY(-1px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.95),
    0 18px 44px rgba(2,6,23,.14);
}

/* Active press */
.profile-upload:active{
  transform: translateY(0);
  box-shadow:
    inset 0 2px 6px rgba(2,6,23,.18);
}

/* Keyboard accessibility */
.profile-upload:focus-within{
  outline:none;
  border-color: rgba(99,102,241,.85);
  box-shadow:
    0 0 0 3px rgba(99,102,241,.35),
    0 18px 44px rgba(2,6,23,.18);
}

.profile-upload{
  position: relative; /* ensure proper containment */
}

/* Shrink clickable area to button interior */
.profile-upload input[type="file"]{
  position:absolute;
  inset:8px;               /* ⬅ controls clickable area */
  opacity:0;
  cursor:pointer;
}

.form-panel-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  width:100%;
  align-items:stretch;
}
.form-panel-row .card{
  flex: 1 1 340px;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  min-height: 130px;
}

/* Sidebar “control panel” feel */
.builder-sidebar .card{ background: rgba(255,255,255,.92); }

/* 7) Tabs */
.tab-row{
  display:flex;
  gap:8px;
  margin-bottom:10px;
  flex-wrap:wrap;
  padding: 4px;
  border-radius: 999px;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(15,23,42,.08);
}
.tab-btn{
  padding: 8px 14px;
  border-radius: 999px;
  border: 0;
  background: transparent;
  font-size:.82rem;
  cursor:pointer;
  font-weight: 750;
  color:#0b0f19;
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, background .12s ease;
}
.tab-btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
.tab-btn.active{
  background: var(--accent);
  color:#fff;
  box-shadow: 0 14px 30px rgba(2,6,23,.18);
}
.panel{ display:none; }
.panel.active{ display:block; }

.panel,
.panel.active{
  width: 100%;
}

#retentionTerms,
#newBizTerms{
  width: 100%;
}

/* 8) Grids */
.top-grid{ display:grid; gap:12px; }
.top-simple{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 10px 12px;
}
/* Top terms grid: slightly tighter + better responsive fit */
.top-term-row{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 8px 10px;
  align-items: start;
}

/* Each term field becomes a small surface row */
.top-field.term-style,
.top-field.yoy-row{
  display:grid;
  grid-template-columns: 18px 1fr minmax(140px, 200px);
  align-items:center;

  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.78);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
  gap: 10px;
}

/* Hover: subtle clarity */
.top-field.term-style:hover,
.top-field.yoy-row:hover{
  border-color: rgba(99,102,241,.22);
  background: rgba(255,255,255,.92);
}

/* 9) Inputs */
.input-style,
select, input[type="text"], input[type="number"], input[type="date"], textarea{
  appearance:none;
  width:100%;
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(15,23,42,.12);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  font-size: .95rem;
  color: var(--text);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.6),
    0 12px 24px rgba(2,6,23,.06);
  transition: border-color .14s ease, box-shadow .14s ease, transform .12s ease, background .14s ease;
}
input::placeholder, textarea::placeholder{ color:#9aa4b2; }
input:focus, select:focus, textarea:focus{
  outline:none;
  border-color: rgba(99,102,241,.55);
  box-shadow: var(--ring), 0 18px 44px rgba(2,6,23,.12);
  transform: translateY(-1px);
  background:#fff;
}

/* 10) Checkbox */
.term-check{ width:16px; height:16px; display:flex; align-items:center; justify-content:center; position:relative; }
.term-check input[type="checkbox"]{ position:absolute; opacity:0; inset:0; cursor:pointer; }
.term-check .box{
  width:16px; height:16px;
  border:1px solid rgba(15,23,42,.28);
  border-radius:5px;
  background:#fff;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
}
.term-check input[type="checkbox"]:checked + .box{
  background: var(--accent);
  border-color: transparent;
  box-shadow: 0 10px 20px rgba(2,6,23,.14);
}

/* 11) Term rows */
.term-row{
  display:grid;
  grid-template-columns: 10px minmax(110px, 150px) minmax(150px, 300px);
  gap:10px;
  align-items:center;
  margin-bottom:8px;
  padding: 6px 8px;
  border-radius: var(--radius-md);
  background: rgba(248,250,252,.92);
  border: 1px solid rgba(15,23,42,.06);
}
.term-row:hover{
  border-color: rgba(99,102,241,.20);
  background: rgba(248,250,252,.98);
}
.top-field label,
.top-label{
  font-size: .78rem;
  font-weight: 800;
  color: rgba(15,23,42,.78);
  letter-spacing: .06em;
  text-transform: uppercase;
  line-height: 1.1;
  margin: 0;
}

/* Top row: library left, toggles right */
.terms-tiles-toprow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  width:100%;
}

/* Library should live along the top (horizontal, scroll if needed) */
.terms-tiles-librarywrap{
  flex: 1 1 auto;
  min-width: 0;
}

/* Right side controls (Retention + New Biz) */
.terms-tiles-controls{
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:flex-end;
  white-space:nowrap;
}

/* Make the tab + content stack and stretch full width */
.terms-tiles-toprow{
  flex-direction: column;
  align-items: stretch;
}

/* This is NOT a right-side strip anymore — it's the main content region */
.terms-tiles-controls{
  flex: 1 1 auto;
  width: 100%;
  min-width: 0;
  display: block;          /* important: don't keep it as a horizontal flex strip */
  white-space: normal;     /* undo nowrap */
  justify-content: unset;  /* undo end alignment */
}

/* 11.b) Terms Tiles (Plan-aware, drag-to-activate) */
.yoy-row{ display:none; } /* moved into Terms Tiles library */

/* Classic top panel unchanged */
.terms-classic-panel{
  margin: 10px 0 12px 0;
  padding: 10px 10px;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(15,23,42,.03);
}
.terms-classic-panel__head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:8px;
}
.terms-classic-panel__head h3{
  margin:0;
  font-size:.88rem;
  font-weight:750;
}
.terms-classic-panel__head .muted-text{ margin:.15rem 0 0 0; }
.terms-classic-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 8px;
}
@media (min-width: 880px){
  .terms-classic-grid{ grid-template-columns: 1fr 1fr 1fr; }
}
.terms-classic-row{
  display:grid;
  grid-template-columns: 12px 1fr;
  gap:10px;
  align-items:start;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.92);
}
.terms-classic-row .term-label{
  white-space:normal;
  overflow:visible;
  text-overflow:clip;
  font-size:.74rem;
}
.terms-classic-row .term-input{ margin-top:6px; }
.terms-classic-row input,
.terms-classic-row select{
  width:100%;
  height: 30px;
  border-radius: 12px;
  border:1px solid rgba(15,23,42,.12);
  padding: 0 12px;
  font-size: .82rem;
  background: var(--input-bg);
  outline:none;
}
.terms-classic-row input:focus,
.terms-classic-row select:focus{
  box-shadow: var(--ring);
  border-color: rgba(99,102,241,.55);
}

/* --- NEW layout: top bar (library + toggles) then full-width dropzone --- */
.terms-tiles-split{
  display:grid;
  grid-template-columns: 1fr;   /* no left/right split anymore */
  gap:12px;
  align-items:start;
}

/* Blocks: slightly quieter, less padding */
.terms-tiles-block{
  border-radius: var(--radius-lg);
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(15,23,42,.03);
  padding: 9px 9px;
}
.terms-tiles-block__head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.terms-tiles-block__head h3{
  margin:0;
  font-size:.84rem;
  font-weight:800;
}

/* Library: horizontal strip across top */
.terms-tile-library{
  display:flex;
  flex-direction:row;
  align-items:center;
  gap:.40rem;

  max-height: none;
  overflow-x:auto;
  overflow-y:hidden;

  padding: 2px 2px;
  scrollbar-gutter: stable;
  -webkit-overflow-scrolling: touch;
}

/* nicer horizontal scrollbar */
.terms-tile-library::-webkit-scrollbar{ height: 10px; }
.terms-tile-library::-webkit-scrollbar-thumb{
  background: rgba(15,23,42,.18);
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,.55);
}
.terms-tile-library::-webkit-scrollbar-track{ background: transparent; }

/* Tiles: compact, refined chips */
.term-tile{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.5rem;

  padding: .26rem .46rem;
  border-radius: 10px;
  background: rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.10);

  font-size:.72rem;
  font-weight: 700;
  line-height: 1.05;
  color:#0b0f19;

  cursor:grab;
  user-select:none;
  white-space:nowrap;
  box-shadow: none;
  transition: transform .08s ease, background .10s ease, border-color .10s ease, opacity .10s ease;
}
.term-tile:hover{
  transform: translateY(-1px);
  background: rgba(248,250,252,.98);
  border-color: rgba(99,102,241,.28);
}
.term-tile:active{ cursor:grabbing; transform:none; }

.term-tile.is-used{
  opacity:.42;
  cursor:not-allowed;
  border-style:dashed;
  background: rgba(15,23,42,.04);
}

/* Subtle dot only */
.term-tile .dot{
  width:6px; height:6px; border-radius:999px;
  background: color-mix(in srgb, var(--accent-solid) 78%, white 0%);
  box-shadow: none;
  opacity:.75;
}

/* ===============================
   TERMS: Compact input treatment (scoped)
   - fixes “bulky” inputs inside the active Terms drop zone
   =============================== */

/* Remove the global "lift on focus" feel only inside term rows */
.term-active-row input:focus,
.term-active-row select:focus,
.term-active-row textarea:focus{
  transform: none !important;
  box-shadow: var(--ring) !important;
}

/* Shared (Applies to All) input — compact */
.term-active-row .term-shared-input input{
  height: 32px;
  padding: 0 10px;
  font-size: .86rem;
  border-radius: 10px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.98);
  box-shadow: none;
}

/* Per-plan inputs — compact + clean */
.term-active-row .term-plan-input{
  padding: 8px 9px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(15,23,42,.02);
}

/* Plan chip: smaller and tighter */
.term-active-row .term-plan-chip{
  padding: .12rem .42rem;
  font-size: .70rem;
  font-weight: 750;
  border-radius: 999px;
  margin-bottom: 6px;
  background: rgba(224,231,255,.72);
}

/* Compact field controls */
.term-active-row .term-plan-input input,
.term-active-row .term-plan-input select{
  height: 34px;
  padding: 0 10px;
  font-size: .88rem;
  border-radius: 10px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.98);
  box-shadow: none;
  min-width: 0;
  flex: 1 1 160px;
}

/* Stop oversized dropdown arrow spacing */
.term-active-row .term-plan-input select{
  padding-right: 28px;
}

/* Tighten grid spacing */
.term-active-row .term-plan-grid{
  gap: 9px;
}

/* Optional: make rows visually thinner overall */
.term-active-row__body{
  padding: 7px 9px 9px 9px;
}
.term-active-row__head{
  padding: 7px 9px;
}

/* Optional: slightly reduce the active row card shadow */
.term-active-row{
  box-shadow: 0 8px 18px rgba(2,6,23,.06);
}

@media (min-width: 760px){
  .term-active-row .term-plan-input{
    display:flex;
    align-items:center;
    gap:8px;
    padding: 8px 9px;
    flex-wrap: wrap;
  }
  .term-active-row .term-plan-chip{
    margin:0;
    flex: 0 0 auto;
  }
  .term-active-row .term-plan-input input,
  .term-active-row .term-plan-input select{
    flex: 1 1 auto;
  }
}

.term-active-row .term-plan-input{
  border-color: rgba(15,23,42,.06);
  background: rgba(255,255,255,.70);
}
.term-active-row .term-plan-input input,
.term-active-row .term-plan-input select{
  border-color: rgba(15,23,42,.10);
}

/* Dropzone: calmer workspace */
.terms-dropzone{
  min-height: 120px;
  width: 100%;
  border:1px dashed rgba(99,102,241,.38);
  border-radius: 16px;
  padding: 10px 10px;
  background: rgba(255,255,255,.88);
  outline:none;
  transition: background .12s ease, border-color .12s ease, box-shadow .12s ease;
}

/* ===== Drop zone: strong "Drop here" affordance ===== */
.terms-dropzone{
  position: relative;
  width: 100%;
  min-height: 180px;                 /* bigger target */
  border-radius: 18px;

  /* layered background: soft + subtle diagonal pattern */
  background:
    radial-gradient(800px 220px at 50% 0%, rgba(99,102,241,.16), transparent 60%),
    repeating-linear-gradient(
      135deg,
      rgba(15,23,42,.045) 0px,
      rgba(15,23,42,.045) 10px,
      rgba(255,255,255,.0) 10px,
      rgba(255,255,255,.0) 20px
    ),
    rgba(255,255,255,.92);

  border: 2px dashed rgba(99,102,241,.45);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}

/* ===== Drop zone: strong "Drop here" affordance ===== */
.terms-dropzone{
  position: relative;

  /* bigger target */
  min-height: 180px;

  /* layered background: soft + subtle diagonal pattern */
  background:
    radial-gradient(800px 220px at 50% 0%, rgba(99,102,241,.16), transparent 60%),
    repeating-linear-gradient(
      135deg,
      rgba(15,23,42,.045) 0px,
      rgba(15,23,42,.045) 10px,
      rgba(255,255,255,0) 10px,
      rgba(255,255,255,0) 20px
    ),
    rgba(255,255,255,.92);

  border: 2px dashed rgba(99,102,241,.45);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}

/* Hover: subtle lift so it feels interactive */
.terms-dropzone:hover{
  border-color: rgba(99,102,241,.62);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 18px 44px rgba(2,6,23,.10);
  transform: translateY(-1px);
}

/* Active drag-over: clear "accepting" state */
.terms-dropzone.is-over{
  border-style: solid;
  border-color: rgba(99,102,241,.95);
  background:
    radial-gradient(900px 260px at 50% 0%, rgba(99,102,241,.26), transparent 60%),
    repeating-linear-gradient(
      135deg,
      rgba(99,102,241,.12) 0px,
      rgba(99,102,241,.12) 10px,
      rgba(255,255,255,0) 10px,
      rgba(255,255,255,0) 20px
    ),
    rgba(224,231,255,.50);
  box-shadow:
    0 0 0 4px rgba(99,102,241,.18),
    0 22px 60px rgba(2,6,23,.14);
  transform: translateY(-2px);
}

/* Drop indicator (centered, feels like a real target) */
.drop-indicator{
  position:absolute;
  inset: 0;
  display:grid;
  place-items:center;
  gap:6px;
  text-align:center;
  pointer-events:none;
  padding: 16px;
}

/* Icon bubble */
.drop-indicator__icon{
  width:44px; height:44px;
  display:grid; place-items:center;
  border-radius: 999px;
  background: rgba(99,102,241,.12);
  border: 1px solid rgba(99,102,241,.22);
  font-size: 1.25rem;
  font-weight: 950;
  color: rgba(15,23,42,.85);
}

/* Text */
.drop-indicator__text{
  font-weight: 950;
  font-size: .95rem;
  color: rgba(15,23,42,.78);
}
.drop-indicator__sub{
  font-size: .82rem;
  font-weight: 700;
  color: rgba(91,100,112,.9);
}

/* Keep your existing hint visible but toned down */
.terms-dropzone__hint{
  position: relative;
  z-index: 1;
  margin: 0 0 8px 0;
  font-size: .78rem;
  color: var(--ink);
  opacity: .92;
}

/* Ensure active list sits above the indicator */
.terms-active-list{
  position: relative;
  z-index: 1;
}

/* Auto-hide the indicator once any active term row exists */
.terms-active-list:not(:empty) ~ .drop-indicator,
.terms-dropzone:has(.terms-active-list:not(:empty)) .drop-indicator{
  display:none;
}

/* Stronger indicator when dragging over */
.terms-dropzone.is-over .drop-indicator__icon{
  background: rgba(99,102,241,.18);
  border-color: rgba(99,102,241,.42);
  transform: scale(1.00);
}

/* Empty state message centered */
.terms-dropzone:empty::before{
  content: "Drop terms here";
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-weight: 900;
  font-size: .95rem;
  letter-spacing: .01em;
  color: rgba(15,23,42,.72);
  pointer-events: none;
}

/* Secondary helper line (only when empty) */
.terms-dropzone:empty::after{
  content: "Drag from the library above";
  position: absolute;
  inset: auto 0 18px 0;
  text-align: center;
  font-size: .82rem;
  font-weight: 700;
  color: rgba(91,100,112,.85);
  pointer-events: none;
}

/* Little “+” badge in the corner (only when empty) */
.terms-dropzone:empty .drop-badge{ display:none; } /* safe if not used */
.terms-dropzone:empty{
  outline-offset: 6px;
}

/* Hover: subtle lift so it feels interactive */
.terms-dropzone:hover{
  border-color: rgba(99,102,241,.62);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 18px 44px rgba(2,6,23,.10);
  transform: translateY(-1px);
}

/* Active drag-over: clear "accepting" state */
.terms-dropzone.is-over{
  border-style: solid;
  border-color: rgba(99,102,241,.95);
  background:
    radial-gradient(900px 260px at 50% 0%, rgba(99,102,241,.26), transparent 60%),
    repeating-linear-gradient(
      135deg,
      rgba(99,102,241,.12) 0px,
      rgba(99,102,241,.12) 10px,
      rgba(255,255,255,0) 10px,
      rgba(255,255,255,0) 20px
    ),
    rgba(224,231,255,.50);
  box-shadow:
    0 0 0 4px rgba(99,102,241,.18),
    0 22px 60px rgba(2,6,23,.14);
  transform: translateY(-2px);
}

/* If it has content, keep it calmer and stop the big empty overlay */
.terms-dropzone:not(:empty){
  min-height: 120px; /* can be smaller once used */
  background: rgba(255,255,255,.92);
  border-style: dashed;
}

.terms-dropzone:focus{
  box-shadow: var(--ring);
  border-color: rgba(99,102,241,.65);
}
.terms-dropzone.is-over{
  border-color: rgba(99,102,241,.92);
  background: rgba(224,231,255,.45);
  box-shadow: 0 14px 34px rgba(2,6,23,.10);
}
.terms-dropzone__hint{
  font-size:.78rem;
  color: var(--ink);
}

/* Active list: tighter vertical rhythm */
.terms-active-list{
  display:flex;
  flex-direction:column;
  gap:.55rem;
}

/* Active term row: smaller footprint */
.term-active-row{
  border-radius: 14px;
  border:1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.96);
  box-shadow: 0 10px 24px rgba(2,6,23,.07);
  overflow:hidden;
}

/* Header: slimmer */
.term-active-row__head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding: 8px 10px;
  background: rgba(15,23,42,.03);
}
.term-active-row__title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight: 800;
  font-size:.82rem;
  min-width:0;
}
.term-active-row__title span{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* Controls smaller */
.term-drag-handle{
  width: 20px; height: 20px;
  border-radius: 8px;
  border:1px solid rgba(15,23,42,.12);
  display:inline-flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,.92);
  cursor:grab;
  user-select:none;
}
.term-drag-handle:active{ cursor:grabbing; }

.term-row-actions{
  display:flex;
  align-items:center;
  gap:6px;
}
.term-remove{
  border:none;
  background: transparent;
  color: #b91c1c;
  font-weight: 900;
  cursor:pointer;
  padding: 4px 6px;
  border-radius: 10px;
}
.term-remove:hover{ background: rgba(185,28,28,.10); }

/* Applies toggle more compact */
.applies-toggle{
  display:inline-flex;
  align-items:center;
  gap:7px;
  font-size:.80rem;
  color: var(--ink);
  user-select:none;
  border:none;
  background: transparent;
  padding: 4px 6px;
  border-radius: 10px;
  cursor:pointer;
}
.applies-toggle:hover{ background: rgba(15,23,42,.05); }

.switch{
  position:relative;
  width: 36px;
  height: 20px;
  border-radius: 999px;
  background: rgba(15,23,42,.14);
  border:1px solid rgba(15,23,42,.14);
  transition: background .12s ease, border-color .12s ease;
  flex: 0 0 auto;
}
.switch::after{
  content:"";
  position:absolute;
  top: 2px; left: 2px;
  width: 16px; height: 16px;
  border-radius: 999px;
  background:#fff;
  box-shadow: 0 10px 20px rgba(2,6,23,.12);
  transition: transform .12s ease;
}
.switch.is-on{
  background: color-mix(in srgb, var(--accent-solid) 75%, white 0%);
  border-color: rgba(99,102,241,.55);
}
.switch.is-on::after{ transform: translateX(16px); }

/* Body: tighter padding */
.term-active-row__body{ padding: 8px 10px 10px 10px; }

/* Shared input: shorter */
.term-shared-input input{
  width: 100%;
  height: 36px;
  border-radius: 12px;
  border:1px solid rgba(15,23,42,.12);
  padding: 0 10px;
  font-size: .88rem;
  background: var(--input-bg);
  outline:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
}
.term-shared-input input:focus{ box-shadow: var(--ring); border-color: rgba(99,102,241,.55); }

.term-plan-grid{
  display:flex;
  flex-wrap: nowrap;
  gap:8px; /* slightly roomier */
  overflow-x: auto;
  padding-bottom: 2px;
}


.term-plan-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 8px 9px;
  border-radius: 12px;
  flex-wrap: nowrap;
  min-width: 220px;
}

.term-plan-chip{
  margin:0;
  flex: 0 0 auto;
  padding: .10rem .42rem;
  font-size: .68rem;
}

.term-plan-input input,
.term-plan-input select{
  height: 34px;
  border-radius: 10px;
  font-size: .86rem;
  padding: 0 10px;
  min-width: 0;
  flex: 1 1 auto;
}

.term-row--dragging{ opacity:.55; }

/* 12) Buttons */
.btn-clear,
.btn-save,
.btn-export,
.btn-copy,
.btn-open{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.35rem;
  padding: 8px 12px;
  font-size:.80rem;
  font-weight: 750;
  letter-spacing:.01em;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  cursor:pointer;
  line-height:1.1;
  white-space:nowrap;
  box-shadow: 0 18px 44px rgba(2,6,23,.18);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.btn-clear:hover,
.btn-save:hover,
.btn-export:hover,
.btn-copy:hover,
.btn-open:hover{
  transform: translateY(-1px);
  filter: brightness(1.03);
  box-shadow: 0 26px 70px rgba(2,6,23,.22);
}
.btn-clear:active,
.btn-save:active,
.btn-export:active,
.btn-copy:active,
.btn-open:active{
  transform: translateY(0);
  filter: brightness(.99);
}

.btn-clear{ background:linear-gradient(135deg,#ef4444,#b91c1c); color:#fff; border-color:rgba(255,255,255,.12); }
.btn-save{  background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border-color:rgba(255,255,255,.12); }
.btn-export{background:linear-gradient(135deg,#4f46e5,#4338ca); color:#fff; border-color:rgba(255,255,255,.12); }
.btn-copy{  background:linear-gradient(135deg,#0f766e,#0e7490); color:#fff; border-color:rgba(255,255,255,.12); }
.btn-open{  background:linear-gradient(135deg,#be123c,#9f1239); color:#fff; border-color:rgba(255,255,255,.12); padding:.72rem 1rem; }

/* Add plan */
.addPlanbtn{
  background: var(--accent);
  color:#fff;
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 14px;
  margin: 0, 0, 0, .5rem;
  padding: 6px 10px;
  font-size: .74rem;
  font-weight: 750;
  cursor:pointer;
  box-shadow: 0 22px 60px rgba(2,6,23,.18);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}

.addPlanbtn:hover{ transform: translateY(-1px); filter: brightness(1.03); box-shadow: 0 30px 80px rgba(2,6,23,.22); }
.addPlanbtn:active{ transform: translateY(0); }

/* Sidebar link button */
.ln-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:.55rem .85rem;
  border-radius:999px;
  font-weight:850;
  color:#0b0f19;
  background: rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.10);
  box-shadow: 0 14px 30px rgba(2,6,23,.10);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.ln-btn:hover{ transform: translateY(-1px); filter: brightness(1.02); box-shadow: 0 20px 54px rgba(2,6,23,.14); }
.ln-btn--sm{ font-size:.86rem; padding:.46rem .75rem; }

/* 13) Presets */
.presets-panel{
  margin: 10px 0 12px;
  padding: 12px 12px;
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.08);
  border-radius: var(--radius-md);
  display:flex;
  flex-direction:column;
  gap:10px;

  /* IMPORTANT: not sticky anymore (sidecar handles “always available”) */
  position: relative;
  z-index: 1;
}

.presets-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
.presets-header h3{ margin:0; font-size:.92rem; font-weight:650; }
.presets-header p{ margin:.15rem 0 0; font-size:.82rem; color: var(--ink); line-height:1.35; }

.preset-list{
  max-height: 160px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  padding-right:4px;
}
.presets-empty{ margin:0; font-size:.84rem; color: var(--ink); }

.preset-group{
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.10);
  padding: .6rem .65rem;
  background: rgba(255,255,255,.94);
}
.preset-group__label{
  font-size:.70rem;
  text-transform:uppercase;
  letter-spacing:.10em;
  color: var(--ink);
  margin:0 0 .4rem;
}
.preset-pill{
  display:inline-flex;
  align-items:center;
  padding:.30rem .62rem;
  border-radius:999px;
  background: rgba(224,231,255,.92);
  color:#0b0f19;
  font-size:.78rem;
  font-weight: 600;
  border:1px solid rgba(15,23,42,.10);
  cursor:grab;
  user-select:none;
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
  margin: 0 .35rem .35rem 0;
}
.preset-pill:hover{
  transform: translateY(-1px);
  box-shadow: 0 18px 44px rgba(2,6,23,.12);
  filter: brightness(1.02);
}
.preset-pill:active{ cursor:grabbing; transform: translateY(0); box-shadow:none; }

[data-plan-content="true"].preset-drop-target{
  outline: 2px dashed rgba(99,102,241,.9);
  outline-offset: 4px;
  border-radius: 14px;
}
/* ===============================
   Presets Sidecar (appears on scroll)
   =============================== */

.presets-sidecar{
  position: fixed;
  right: 16px;
  bottom: 75px; /* <-- extend toward the bottom */
  width: min(200px, calc(100vw - 32px));

  /* viewport-fit height (no fixed 600px cap) */
  height: auto;
  max-height: calc(100vh - 400px); /* 300 top + 16 bottom */

  z-index: 9999;

  /* Hidden by default */
  opacity: 0;
  transform: translateX(12px);
  pointer-events: none;

  transition: opacity .18s ease, transform .18s ease;

  /* Match your panel styling */
  padding: 12px 12px;
  background: rgba(105,53,202,1);
  border: 1px solid rgba(15,23,42,.08);
  border-radius: var(--radius-md);

  box-shadow: 0 18px 50px rgba(2,6,23,.18);
  backdrop-filter: blur(8px);

  /* header + body */
  display: flex;
  flex-direction: column;

  /* never collapse too small */
  min-height: 400px;
}

.presets-sidecar.is-open{
  opacity: 1;
  transform: translateX(0);
  pointer-events: auto;
}

.presets-sidecar__header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom: 10px;
  flex: 0 0 auto;
  color: var(--card-muted);
}

.presets-sidecar__header h3{
  margin:0;
  font-size:.82rem;
  font-weight:850;
}

.presets-sidecar__header p{
  margin:.15rem 0 0;
  font-size:.82rem;
  color: var(--card-muted);
  line-height:1.35;
}

.presets-sidecar__close{
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.85);
  border-radius: 10px;
  padding: 6px 8px;
  cursor: pointer;
  font-weight: 700;
  color: #0b0f19;
  line-height: 1;
}

/* The body should fill the rest of the sidecar */
.presets-sidecar__body{
  flex: 1 1 auto;
  min-height: 0;          /* critical in flex layouts */
  overflow: auto;         /* body scrolls ONLY if truly needed */
  overflow-x: hidden;

  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* IMPORTANT: neutralize any old list constraints coming from the main panel */
.presets-sidecar__body #presetList,
.presets-sidecar__body .presets-list{
  flex: 0 0 auto;         /* let it be natural height */
  height: auto !important;
  max-height: none !important;   /* <-- this is usually the culprit */
  overflow: visible !important;  /* <-- remove inner scrolling */
}

/* If your list wrapper is flex/grid, keep it packed to the top */
.presets-sidecar__body #presetList,
.presets-sidecar__body .presets-list{
  align-content: flex-start;
}

/* 14) Plans grid */
#plansContainer{
  display:grid;
  gap:14px;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  align-items:start;
}
@media (max-width:820px){
  #plansContainer{ grid-template-columns: 1fr; }
}

/* 15) Plan cards */
.plan-card{
  background: rgba(255,255,255,.96);
  border: 1px solid rgba(15,23,42,.10);
  border-radius: var(--radius-lg);
  padding: 12px 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height: 200px;
  min-width:0;
  box-shadow: var(--shadow-2);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.plan-card:hover{
  transform: translateY(-1px);
  border-color: rgba(99,102,241,.20);
  box-shadow: 0 28px 80px rgba(2,6,23,.18);
}
.plan-card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(15,23,42,.06);
}
.plan-card-title{
  font-weight: 800;
  font-size:.90rem;
  letter-spacing:.01em;
}
.plan-card button.secondary{
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(248,250,252,.95);
  padding: 6px 10px;
  font-size: .78rem;
  font-weight: 800;
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.plan-card button.secondary:hover{
  transform: translateY(-1px);
  box-shadow: 0 18px 44px rgba(2,6,23,.10);
  filter: brightness(1.02);
}
.plan-card button.secondary:active{ transform: translateY(0); }

/* ===============================
   Plan reorder (drag + drop)
   =============================== */
.plan-card{
  position: relative;
}
.plan-card[draggable="true"]{
  -webkit-user-drag: element;
}

.plan-drag-handle{
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(248,250,252,.95);
  padding: 6px 10px;
  font-size: .78rem;
  font-weight: 950;
  cursor: grab;
  user-select: none;
  line-height: 1;
}
.plan-drag-handle:active{ cursor: grabbing; }

.plan-card.is-dragging{
  opacity: .55;
  transform: scale(.995);
}

.plan-card.drop-target{
  outline: 2px dashed rgba(99,102,241,.85);
  outline-offset: 4px;
}

/* 16) Toolbar */
.plan-toolbar{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
  margin: 6px 0 8px;
  padding: 6px;
  border-radius: 16px;
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.06);
}
.plan-toolbar button,
.plan-toolbar select,
.plan-toolbar input[type="color"]{
  border:1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.98);
  border-radius: 12px;
  padding: 7px 9px;
  font-size:.82rem;
  cursor:pointer;
  box-shadow: 0 14px 30px rgba(2,6,23,.06);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.plan-toolbar button:hover{
  transform: translateY(-1px);
  box-shadow: 0 20px 54px rgba(2,6,23,.10);
  border-color: rgba(99,102,241,.22);
}
.plan-toolbar input[type="color"].rte-color{ width:34px; height:28px; padding:0; border-radius:10px; }
.plan-toolbar .rte-size-select{ display:none !important; }

/* 17) RTE */
.plan-contents.rte{
  min-height: 140px;
  max-height: 320px;
  max-width:100%;
  overflow:auto;
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(15,23,42,.10);
  border-radius: 16px;
  padding: 12px 12px;
  font-size: .97rem;
  line-height: 1.35;
  overflow-wrap:anywhere;
  word-break:break-word;
  box-shadow: 0 18px 50px rgba(2,6,23,.08);
}
.plan-contents.rte:focus{
  outline:none;
  border-color: rgba(99,102,241,.45);
  box-shadow: var(--ring), 0 24px 70px rgba(2,6,23,.14);
}
.plan-contents.rte p{ margin:.45rem 0; line-height: 1.35; }
.plan-contents.rte ul, .plan-contents.rte ol{ margin:.3rem 0 .3rem 1.15rem; padding:0; }
.plan-contents.rte li{ margin:3px 0; }
.plan-contents.rte a{ text-decoration: underline; }
.plan-contents.rte > *:first-child{ margin-top:0 !important; }
.plan-contents.rte > *:last-child{ margin-bottom:0 !important; }

.plan-contents.rte p:has(> span),
.plan-contents.rte p:has(strong),
.plan-contents.rte p:has(em){
  margin-block: .35rem;
}

/* 18) Bullets + footer */
.bullet-list{ margin:0; padding-left:1.15rem; list-style:disc; }
.bullet-list li{ margin:7px 0; line-height:1.5; }
.bullet-list li::marker{ color:#e1251b; }

.site-footer{
  border-top: 1px solid rgba(255,255,255,.18);
  padding: 16px var(--pad);
  text-align:center;
  color:#e7ecf3;
  opacity:.95;
}

/* =========================================================
   OFF-CANVAS SIDEBAR (small screens)
   ========================================================= */

.sidebar-overlay{
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,.62);
  backdrop-filter: none;
  -webkit-backdrop-filter: none;

  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease;
  z-index: var(--panel-z);
}

/* Toggle button (shown only on small screens) */
.sidebar-toggle{
  display:none; /* shown in media query below */
  background: rgba(255,255,255,.92);
  color:#0b0f19;
  border: 1px solid rgba(255,255,255,.22);
  box-shadow: 0 18px 44px rgba(2,6,23,.18);
}
.sidebar-toggle:hover{ transform: translateY(-1px); filter: brightness(1.03); }

/* Close button inside panel */
.sidebar-close{
  display:none; /* shown on small screens */
  width: 100%;
  justify-content: center;
  margin: 0 0 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(248,250,252,.98);
  font-weight: 800;
  cursor:pointer;
  box-shadow: 0 14px 30px rgba(2,6,23,.08);
}

/* When small: main uses full width, sidebar becomes fixed panel */
@media (max-width:1100px){

  .builder-layout{
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

  .builder-sidebar{
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    background: rgba(255,255,255,.96);
  }

  .builder-layout{
    flex-direction: column;
    align-items: stretch;
  }

  .builder-main{
    width:100%;
    max-width:100%;
    min-width:0;
  }

  .builder-sidebar{
    position: fixed;
    top: 0;
    left: 0;
    height: 100dvh;
    width: var(--panel-w);
    max-width: var(--panel-w);
    min-width: 0;
    padding: 14px;
    overflow: auto;

    background: rgba(255,255,255,.86);
    border-right: 1px solid rgba(255,255,255,.22);
    box-shadow: 0 30px 90px rgba(2,6,23,.38);
    backdrop-filter: blur(14px);

    transform: translateX(calc(-1 * var(--panel-w) - 16px));
    transition: transform .22s ease;
    z-index: calc(var(--panel-z) + 1);
  }

  .sidebar-toggle{ display:inline-flex; }
  .sidebar-close{ display:inline-flex; }

  body.sidebar-open{
    overflow: hidden;
    touch-action: none;
  }

  body.sidebar-open .builder-sidebar{
    transform: translateX(0);
  }

  body.sidebar-open .sidebar-overlay{
    opacity: 1;
    pointer-events: auto;
  }
}

/* ===============================
   NEW: First-time Demo / Tour Modal
   =============================== */
.demo-overlay{
  position: fixed;
  inset: 0;
  z-index: 99998;
  background: rgba(2,6,23,.70);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
}
.demo-overlay.is-open{ display:flex; }

.demo-modal{
  width: min(860px, 94vw);
  max-height: min(88vh, 860px);
  overflow: hidden;
  background: rgba(255,255,255,.96);
  border: 1px solid rgba(255,255,255,.55);
  border-radius: 20px;
  box-shadow: 0 30px 120px rgba(2,6,23,.50);
  display:flex;
  flex-direction:column;
}

.demo-head{
  padding: 16px 18px;
  background: var(--accent);
  color:#fff;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
}
.demo-head h2{
  margin:0;
  font-size: 1.05rem;
  font-weight: 850;
  letter-spacing:.01em;
}
.demo-head p{
  margin:.25rem 0 0;
  font-size:.88rem;
  opacity:.95;
  line-height: 1.45;
  max-width: 90ch;
}

.demo-close{
  border: 1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.18);
  color:#fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight: 900;
  line-height: 1;
}
.demo-close:hover{ filter: brightness(1.05); transform: translateY(-1px); }
.demo-close:active{ transform: translateY(0); }

.demo-body{
  padding: 14px 18px 16px;
  overflow:auto;
}
.demo-grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 12px;
}
@media (max-width: 860px){
  .demo-grid{ grid-template-columns: 1fr; }
}

.demo-card{
  background: rgba(255,255,255,.94);
  border: 1px solid rgba(15,23,42,.10);
  border-radius: 16px;
  padding: 12px 12px;
  box-shadow: 0 14px 34px rgba(2,6,23,.10);
}
.demo-card h3{
  margin:0 0 8px;
  font-size:.92rem;
  font-weight: 900;
  color:#0b0f19;
}
.demo-card p{
  margin:0 0 10px;
  color:#334155;
  line-height: 1.55;
  font-size:.90rem;
}
.demo-steps{
  margin:0;
  padding-left: 1.15rem;
}
.demo-steps li{
  margin: 8px 0;
  line-height: 1.5;
  color:#334155;
  font-size:.90rem;
}
.demo-kv{
  display:grid;
  gap:10px;
}
.demo-kv .kv{
  background: rgba(248,250,252,.95);
  border: 1px solid rgba(15,23,42,.08);
  border-radius: 14px;
  padding: 10px 10px;
}
.demo-kv .kv b{
  display:block;
  font-size:.82rem;
  color:#0b0f19;
}
.demo-kv .kv span{
  display:block;
  margin-top:3px;
  font-size:.86rem;
  color:#334155;
  line-height: 1.45;
}
.demo-actions{
  margin-top: 12px;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.demo-actions .pill{
  display:inline-flex;
  align-items:center;
  gap:.45rem;
  padding: 9px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.96);
  cursor:pointer;
  font-weight: 900;
  font-size: .84rem;
  box-shadow: 0 14px 34px rgba(2,6,23,.10);
}
.demo-actions .pill.primary{
  border-color: rgba(255,255,255,.25);
  background: var(--accent);
  color:#fff;
}
.demo-actions .pill:hover{ transform: translateY(-1px); }
.demo-actions .pill:active{ transform: translateY(0); }

.demo-footnote{
  margin-top: 12px;
  font-size:.82rem;
  color:#64748b;
  line-height: 1.45;
}

/* 19) Print */
@page{ size: A3 portrait; margin: 10mm; }
@media print{
  html, body{
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    background:#fff !important;
  }
  body::before{ display:none !important; }
  .page-header, .form-top-actions{ color:#000 !important; text-shadow:none !important; }
  .btn-clear, .btn-save, .btn-export, .btn-copy, .btn-open, .addPlanbtn, .ln-btn{ box-shadow:none !important; }
  .builder-layout{ background:#fff !important; border:0 !important; box-shadow:none !important; }
  .card{ background:#fff !important; box-shadow:none !important; }
  .builder-sidebar,
  .sidebar-overlay,
  .sidebar-toggle,
  .sidebar-close,
  .demo-overlay{ display:none !important; }
}
</style>
</head>

<!-- PASSCODE GATE (front-end only) -->
<div id="gate" style="
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background: var(--bg); padding:24px;
">
  <div style="
    width:min(420px, 92vw);
    background:#fff; border-radius:16px; padding:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  ">
    <div style="font-weight:800; font-size:1.05rem; margin-bottom:6px;">LNPresents Builder</div>
    <div style="color:#5b6470; font-size:.9rem; margin-bottom:12px;">Enter passcode to continue.</div>

    <div style="display:flex; gap:8px;">
      <input id="gateCode" type="password" placeholder="Passcode"
        style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); outline:none;">
      <button id="gateBtn"
        style="padding:10px 12px; border-radius:10px; border:0; cursor:pointer; color:#fff; background:#4b0082;">
        Unlock
      </button>
    </div>

    <div id="gateErr" style="display:none; color:#b91c1c; font-size:.85rem; margin-top:10px;">
      Incorrect passcode.
    </div>

    <label style="display:flex; gap:8px; align-items:center; margin-top:12px; color:#334155; font-size:.85rem;">
      <input id="gateRemember" type="checkbox">
      Remember on this device
    </label>
  </div>
</div>
<script>

(function(){
  // CHANGE THIS:
  const PASSCODE = "937";

  const gate = document.getElementById("gate");
  const input = document.getElementById("gateCode");
  const btn = document.getElementById("gateBtn");
  const err = document.getElementById("gateErr");
  const remember = document.getElementById("gateRemember");

  function signalUnlocked(){
    try{ window.dispatchEvent(new Event("lnp:unlocked")); } catch(e){}
  }

  // if remembered, skip gate
  try{
    if (localStorage.getItem("LNP_BUILDER_UNLOCKED") === "1") {
      gate.remove();
      signalUnlocked();
      return;
    }
  } catch(e){}

  function unlock(){
    if (input.value === PASSCODE) {
      err.style.display = "none";
      if (remember.checked) {
        try{ localStorage.setItem("LNP_BUILDER_UNLOCKED", "1"); } catch(e){}
      }
      gate.remove();
      signalUnlocked();
    } else {
      err.style.display = "block";
      input.select();
    }
  }

  btn.addEventListener("click", unlock);
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlock(); });

  // autofocus
  setTimeout(()=>input.focus(), 50);
})();
</script>

<body>
  <!-- ========== HEADER ========== -->
  <header class="page-header">
    <div class="page-header-left">
      <h1>LNPresents - Builder</h1>
      <p>
        Welcome to the LexisNexis Proposal Builder for LNPresents.
        Fill out this form and show up to four plans with up to six term details selected to present on LNPresents.
        The plan contents support basic text formatting (bold, italic, underline, bulletpoint, and color).
      </p>
    </div>
  </header>

  <!-- ========== TOP ACTIONS ========== -->
  <div class="form-top-actions">
    <button type="button" class="btn-export sidebar-toggle" id="sidebarToggle">Menu</button>

    <!-- NEW: Demo button (always available, even after first run) -->
    <button type="button" id="demoBtn" class="btn-copy" title="Open the Builder Info Page">Info</button>

    <button type="button" id="clearBtn" class="btn-clear">Clear</button>
    <button type="submit" form="clgForm" id="saveBtn" class="btn-save">Save Details</button>
    <button id="openPresenterBtn" type="button" class="btn-open">Open Presenter</button>
    <span id="copyProposalBtn"  hidden aria-hidden="true"></span>

    <script>
      const PRESENTER_URL  = './LNPresents-Presenter.html';
      const PRESENTER_NAME = 'lnp_presenter_tab';
      let presenterWin = null;

      function openPresenter() {
        presenterWin = window.open(PRESENTER_URL, PRESENTER_NAME);
        if (presenterWin) {
          try { presenterWin.focus(); } catch (e) {}
        } else {
          location.href = PRESENTER_URL;
        }
      }

      document.getElementById('openPresenterBtn')
        .addEventListener('click', openPresenter);
    </script>

    <!-- Export button kept; placeholder keeps scripts happy -->
    <span id="exportEmailBtn" hidden aria-hidden="true"></span>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

  <!-- NEW: Demo modal container (injected content is built by JS so it stays easy to update) -->
  <div class="demo-overlay" id="demoOverlay" aria-hidden="true"></div>

  <!-- ========== FORM + LEFT SIDEBAR ========== -->
  <div class="form-shell">
    <div class="builder-layout">

      <!-- LEFT: Add Your Header card -->
      <aside class="builder-sidebar">
        <button type="button" class="sidebar-close" id="sidebarClose">Close Menu</button>

        <!-- Add Your Header (LEFT CARD) -->
        <div class="card" id="repHeaderCard">
          <h2>Add Your Header</h2>
          <p class="lede">
            Upload your header below to personalize your presentation. Your header will not be present on the exported PDF.
          </p>

          <div class="card-info">

            <datalist id="repHeaderList"></datalist>
            <!-- NEW: Local header upload (stored on this device/browser) -->
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
  </div>

  <div style="display:grid; gap:10px; margin-top:10px;">
    <label class="profile-upload" style="margin:0;">
      <span>Upload Header</span>
      <input type="file" id="headerUploadInput" accept="image/png,image/jpeg">
    </label>

    <!-- Preview -->
    <div class="header-preview-wrap">
      <div class="header-preview-meta">
        <span id="headerPreviewStatus">No uploaded header yet.</span>
        <span id="headerPreviewInfo" style="opacity:.75;"></span>
      </div>
      <img id="headerPreviewImg" alt="Header preview" />
    </div>
        <button type="button" id="clearUploadedHeaderBtn" class="clearUploadedHeaderBtn" style="padding:.55rem .85rem; font-size:.78rem;">
      Clear uploaded header
    </button>

   <small class="muted-text">
  Don’t have a header image yet?
  <a
    href="https://lexisnexislngglobal.seismic.com/Link/Content/DC2DVH3GCVQmpGQF6XfHq3VFHW8d"
    target="_blank"
    rel="noopener noreferrer"
    style="font-weight:900;"
  >
    CLICK HERE
  </a>.
</small>
  </div>
</div>
          </div>

        <!-- Save / Load Profiles card -->
        <div class="card">
          <h2>Save / Load Profiles</h2>
          <p class="lede">Easily import or export a full builder profile to save progress, build templates, and share internally. </p>
          <div class="card-info">
            <div class="profile-card-controls">
              <button type="button" id="downloadProfileBtn" class="downloadProfileBtn">
                Download Profile
              </button>

              <label class="profile-upload">
                <span>Load Profile</span>
                <input type="file" id="uploadProfileInput" accept="application/json">
              </label>
            </div>
            <p class="muted-text">
              When you download a profile, you’ll be asked to name the file. The default filename is
              the <strong>Firm Name</strong> .
            </p>
          </div>
        </div>

        <div class="card">
          <p class="lede">Quick tips for using LNPresents:</p>
          <ul class="bullet-list">
            <li>You may choose up to <strong>six</strong> terms to show above your plans.</li>
            <li>You may show up to <strong>four</strong> plans at once.</li>
            <li>Plan contents support basic styling, color, and <a href="https://example.com" target="_blank" rel="noopener">hyperlinks</a>. Highlight to style; clear to reset.</li>
            <li>Click the button below to <strong>Submit Feature Requests</strong> or <strong>Report Bugs</strong>.</li>
          </ul>
          <a
            class="ln-btn ln-btn--sm"
            role="button"
            aria-label="Send LN Presents feedback email"
            href="mailto:chase.lawarregardner@lexisnexis.com
            ?subject=LN%20Presents%20Feedback
            &amp;body=Hello,%0D%0A%0D%0AThanks%20for%20using%20LN%20Presents!%20Please%20answer%20these%20questions%20when%20sending%20feedback%20or%20reporting%20bugs.%0D%0A%0D%0AFeature%20Request%20or%20Bug%3F%0D%0A%0D%0ADescribe%20the%20idea%20or%20issue%3F%0D%0A%0D%0AIf%20bug,%20list%20steps%20to%20reproduce.%0D%0A%0D%0AOther%20Information%20or%20suggestions%3F%0D%0A%0D%0ADo%20I%20have%20your%20permission%20to%20reach%20out%20to%20you%20to%20seek%20more%20detail%20about%20your%20submission,%20if%20necessary%3F">
            Send Feedback
          </a>
        </div>
      </aside>

      <!-- RIGHT: Existing Builder form -->
      <main class="builder-main">
        <form id="clgForm">
          <!-- 1) Firm Details -->
          <div class="card">
            <h2>Firm Details</h2>
            <div class="top-grid">
              <div class="top-simple">
                <div class="top-field">
                  <label>Firm Name</label>
                  <input type="text" data-key="clgFirmName" placeholder="Law Office of LexisNexis" class="input-style">
                </div>
                <div class="top-field">
                  <label>Incentive</label>
                  <input type="text" data-key="clgIncentive" placeholder="Customers get more value than ever" class="input-style">
                </div>
              </div>

                <div id="classicTopTerms" class="terms-classic-panel"></div>
                </div>
              </div>

          <!-- 2) Side-by-side panels -->
          <div class="form-panel-row">
            <div class="card">
              <h2>Terms</h2>
              <div class="terms-tiles-toprow">
                <div class="tab-row">
                  <button type="button" class="tab-btn active" data-panel="retentionPanel">Retention</button>
                  <button type="button" class="tab-btn" data-panel="newBizPanel">New Business</button>
                </div>

                <div class="terms-tiles-controls">
                  <div id="retentionPanel" class="panel active"><div id="retentionTerms"></div></div>
                  <div id="newBizPanel" class="panel"><div id="newBizTerms"></div></div>
                </div>
              </div>

              </div>
            </div>

          <!-- 3) Plans -->
          <div class="card" id="plansSection">
            <h2>Plans</h2>

            <!-- Plan content presets panel (JSON + drag & drop, compact, drag-only) -->
            <div class="presets-panel">
              <div class="presets-header">
                <div>
                  <h3>Plan Content Presets</h3>
                  <p>Drag a preset into a plan's Contents area to start from a template.</p>
                </div>
                <span id="reloadPresetsBtn"  hidden aria-hidden="true"></span>
              </div>
              <div id="presetList" class="preset-list">
                <p class="presets-empty">Loading presets…</p>
              </div>
            </div>

            <button type="button" id="addPlanBtn" class="addPlanbtn" style="addPlanbtn">+ Add Plan</button>
            <div id="plansContainer"></div>
          </div>
        </form>
      </main>

    </div>
  </div>

  <footer class="site-footer">
    <small>&copy; <span>LexisNexis</span></small>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js" crossorigin="anonymous"></script>

<!-- ========== APP SCRIPT ========== -->
<script>
  document.addEventListener("DOMContentLoaded", function () {

    /* =========================
     * 0) FIRST-TIME DEMO OVERVIEW (shown once)
     * ========================= */
    const DEMO_SEEN_KEY = "LNP_BUILDER_DEMO_SEEN";
    const demoOverlay = document.getElementById("demoOverlay");
    const demoBtn = document.getElementById("demoBtn");

    function setDemoSeen(){
      try{ localStorage.setItem(DEMO_SEEN_KEY, "1"); } catch(e){}
    }
    function hasSeenDemo(){
      try{ return localStorage.getItem(DEMO_SEEN_KEY) === "1"; } catch(e){ return false; }
    }

    function closeDemo({ markSeen = true } = {}){
      if (!demoOverlay) return;
      demoOverlay.classList.remove("is-open");
      demoOverlay.setAttribute("aria-hidden","true");
      demoOverlay.innerHTML = "";
      document.body.style.overflow = "";
      if (markSeen) setDemoSeen();
    }

    function openDemo({ markSeenOnClose = true } = {}){
      if (!demoOverlay) return;

      // Build content (easy to edit later)
      demoOverlay.innerHTML = `
        <div class="demo-modal" role="dialog" aria-modal="true" aria-label="LNPresents Builder Info Page">
          <div class="demo-head">
            <div>
              <h2>Welcome to LNPresents Builder</h2>
              <p>
                This Builder creates the proposal content that your Presenter displays. Fill in firm details, select up to 6 terms, build up to 4 plans,
                then click <b>Open Presenter</b> to view the live output.
              </p>
            </div>
            <button type="button" class="demo-close" aria-label="Close demo">✕</button>
          </div>

          <div class="demo-body">
            <div class="demo-grid">
              <div class="demo-card">
                <h3>Builder Breakdown</h3>
                <ol class="demo-steps">
                  <li><b>Firm Details</b>: Enter the Firm Name + Incentive (Personalized Proposal Message).</li>
                  <li><b>Terms</b>: Choose up to <b>6</b> checkboxes across Retention/New Business options to be displayed with your plans.</li>
                  <li><b>Plans</b>: Add up to <b>4</b> plans with Platform, Price, and Contents displayed in a clean and direct format.</li>
                  <li><b>Presets</b>: Drag a preset into a plan’s Contents area to start from a personalized template.</li>
                  <li><b>Save Details</b>: Save details in an easy and secure way by exporting your Plan Profile found in the side menu.</li>
                  <li><b>Open Presenter</b>: Once you've saved your details, Open the Presenter. You will be taken to another page with your presentation and the PDF export.</li>
                </ol>

                <div class="demo-actions">
                  <button type="button" class="pill primary" data-demo-action="gotit">Got it — start building</button>
                </div>

                <div class="demo-footnote">
                  <b>Note:</b> You can always reopen this using the <b>Info</b> button in the top-right.
                </div>
              </div>

              <div class="demo-card">
                <h3>Key features you’ll use most</h3>
                <div class="demo-kv">
                  <div class="kv">
                    <b>Plan Presets</b>
                    <span>Start building your plan with personalized presets designed to make professional and personalized plans quickly. </span>
                  </div>
                  <div class="kv">
                    <b>Profiles (Download / Load)</b>
                    <span>Import and export proposal Profiles as a .json file. This allows you to switch between proposals quickly and share proposals with coworkers and managers for feedback.</span>
                  </div>
                  <div class="kv">
                    <b>Personalized Headers</b>
                    <span>If you choose, you may submit your Header for your use on presentations. This is a great way to personalize your proposals.</span>
                  </div>
                  <div class="kv">
                    <b>Hyperlinked PDFs</b>
                    <span>Full hyperlink support allows you to add Seismic Digital Sales Room Links to your exported Proposal PDFs.</span>
                  </div>
                  <div class="kv">
                    <b>Privacy and Security</b>
                    <span>All information entered on this site is stored locally in your browser cache. At no time is customer or usage data stored or tracked by LNPresents.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      demoOverlay.classList.add("is-open");
      demoOverlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";

      // Close handlers
      const closeBtn = demoOverlay.querySelector(".demo-close");
      closeBtn?.addEventListener("click", () => closeDemo({ markSeen: markSeenOnClose }));

      demoOverlay.addEventListener("click", (e) => {
        // click outside modal closes
        const modal = demoOverlay.querySelector(".demo-modal");
        if (modal && !modal.contains(e.target)) closeDemo({ markSeen: markSeenOnClose });
      });

      document.addEventListener("keydown", function escClose(ev){
        if (!demoOverlay.classList.contains("is-open")) return;
        if (ev.key === "Escape") {
          closeDemo({ markSeen: markSeenOnClose });
        }
      }, { passive: true, once: true });

      // Action shortcuts
      demoOverlay.querySelectorAll("[data-demo-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-demo-action");

          if (action === "gotit") {
            closeDemo({ markSeen: markSeenOnClose });
            return;
          }

          if (action === "scrollToPlans") {
            closeDemo({ markSeen: markSeenOnClose });
            const el = document.getElementById("plansSection");
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            return;
          }

          if (action === "scrollToHeader") {
            closeDemo({ markSeen: markSeenOnClose });
            const el = document.getElementById("repHeaderCard");
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            return;
          }
        });
      });
    }

    // Allow users to reopen demo any time (does not need to “un-see”)
    if (demoBtn) {
      demoBtn.addEventListener("click", () => openDemo({ markSeenOnClose: true }));
    }

    // Only show automatically once, and only after passcode gate is gone
    function tryAutoShowDemo(){
      if (document.getElementById("gate")) return; // still locked
      if (!hasSeenDemo()) openDemo({ markSeenOnClose: true });
    }

    // Run now, and also after unlock signal
    tryAutoShowDemo();
    window.addEventListener("lnp:unlocked", tryAutoShowDemo, { once: true });

    /* =========================
     * A) DOM REFERENCES
     * ========================= */
    const form = document.getElementById("clgForm");
    const retentionHost = document.getElementById("retentionTerms");
    const newBizHost = document.getElementById("newBizTerms");
    const plansContainer = document.getElementById("plansContainer");
    const addPlanBtn = document.getElementById("addPlanBtn");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const tabs = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".panel");
    const exportBtn = document.getElementById('exportEmailBtn');
    const emailProposalBtn = document.getElementById("emailProposalBtn");
    const copyProposalBtn = document.getElementById("copyProposalBtn");

    // NEW: profile save/load controls
    const downloadProfileBtn = document.getElementById("downloadProfileBtn");
    const uploadProfileInput = document.getElementById("uploadProfileInput");

    // Header selection controls (LN_Rep) — actual IDs used in your HTML
    const repHeaderSearch = document.getElementById("repHeaderSearch");
    const repHeaderList   = document.getElementById("repHeaderList");
    const submitHeaderBtn = document.getElementById("submitHeaderBtn");
    // NEW: uploaded header controls
const headerUploadInput       = document.getElementById("headerUploadInput");
const headerPreviewImg        = document.getElementById("headerPreviewImg");
const headerPreviewStatus     = document.getElementById("headerPreviewStatus");
const headerPreviewInfo       = document.getElementById("headerPreviewInfo");
const clearUploadedHeaderBtn  = document.getElementById("clearUploadedHeaderBtn");



    /* =========================
     * B) CONSTANTS & FORMATTERS
     * ========================= */
    const MAX_PLANS = 4;
    const MAX_TERM_SELECTIONS = 6;
    const currencyFmt = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" });

    /* =========================
     * B.1) LN REP (HEADER) STATE
     * ========================= */
    /* =========================
     * HEADER DROPDOWN (from repo /Header or /Headers)
     * Store RAW filename for reliable lookups, display friendly label
     * ========================= */

    // Keys:
    // - LN_REP_FILE_STORAGE_KEY: raw filename (e.g., "Gardner, Chase.png")
    // - LN_REP_LABEL_STORAGE_KEY: friendly label
    // - LN_REP_STORAGE_KEY: backward-compat "LN_Rep" value (we set this to RAW filename)
    let LN_RepFile = "";
    let LN_RepLabel = "";

    const LN_REP_STORAGE_KEY       = "LNP_LN_REP";        // legacy / compat
    const LN_REP_FILE_STORAGE_KEY  = "LNP_LN_REP_FILE";   // raw filename
    const LN_REP_LABEL_STORAGE_KEY = "LNP_LN_REP_LABEL";  // friendly display label

    // Repo + folder settings
    const HEADERS_REPO_OWNER = "chase-gardner";
    const HEADERS_REPO_NAME  = "LN-Presents";
    const HEADERS_BRANCH     = "main";
    const HEADERS_FOLDERS_TO_TRY = ["Header", "Headers", "headers", "header"];

    // In-memory options so we can map label <-> raw
    let headerOptions = []; // [{ raw, label }]

    function setLnRepSelection({ raw, label }) {
      LN_RepFile  = (raw || "").trim();
      LN_RepLabel = (label || "").trim();

      // Persist
      try {
        if (LN_RepFile)  localStorage.setItem(LN_REP_FILE_STORAGE_KEY, LN_RepFile);
        else             localStorage.removeItem(LN_REP_FILE_STORAGE_KEY);

        if (LN_RepLabel) localStorage.setItem(LN_REP_LABEL_STORAGE_KEY, LN_RepLabel);
        else             localStorage.removeItem(LN_REP_LABEL_STORAGE_KEY);

        // Backward compatibility: keep LN_Rep as RAW filename for reliable Presenter lookup
        if (LN_RepFile)  localStorage.setItem(LN_REP_STORAGE_KEY, LN_RepFile);
        else             localStorage.removeItem(LN_REP_STORAGE_KEY);
      } catch (e) {}

      // Display friendly label in the input
      if (repHeaderSearch && repHeaderSearch.value !== LN_RepLabel) {
        repHeaderSearch.value = LN_RepLabel;
      }
    }

    function displayNameFromFilename(filename) {
      const base = String(filename || "").replace(/\.[^.]+$/, "");
      const parts = base.split(",").map(s => s.trim()).filter(Boolean);
      if (parts.length >= 2) return `${parts[1]}, ${parts[0]}`; // "First, Last" if filename is "Last, First"
      return base.replace(/[_-]+/g, " ").trim() || filename;
    }

    function findOptionByLabel(label) {
      const v = (label || "").trim();
      return headerOptions.find(o => o.label === v) || null;
    }

    function findOptionByRaw(raw) {
      const v = (raw || "").trim();
      return headerOptions.find(o => o.raw === v) || null;
    }

    async function fetchFolderListing(folderName) {
      const url =
        `https://api.github.com/repos/${encodeURIComponent(HEADERS_REPO_OWNER)}/${encodeURIComponent(HEADERS_REPO_NAME)}` +
        `/contents/${encodeURIComponent(folderName)}?ref=${encodeURIComponent(HEADERS_BRANCH)}`;

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`GitHub API ${res.status} for ${folderName}`);
      return res.json();
    }

    async function loadHeaderFolderOptions() {
      if (!repHeaderList) return;

      // show loading
      repHeaderList.innerHTML = "";
      repHeaderList.appendChild(Object.assign(document.createElement("option"), { value: "Loading…" }));

      let items = null;
      let lastErr = null;

      for (const folder of HEADERS_FOLDERS_TO_TRY) {
        try {
          const data = await fetchFolderListing(folder);
          if (Array.isArray(data)) { items = data; break; }
        } catch (e) {
          lastErr = e;
        }
      }

      repHeaderList.innerHTML = "";
      headerOptions = [];

      if (!items) {
        console.error("Header list load failed:", lastErr);
        repHeaderList.appendChild(Object.assign(document.createElement("option"), { value: "Could not load headers" }));
        return;
      }

      headerOptions = items
        .filter(x => x && x.type === "file" && typeof x.name === "string" && /\.(jpe?g|png)$/i.test(x.name))
        .map(x => ({ raw: x.name, label: displayNameFromFilename(x.name) }))
        .sort((a, b) => a.label.localeCompare(b.label));

      if (!headerOptions.length) {
        repHeaderList.appendChild(Object.assign(document.createElement("option"), { value: "No headers found" }));
        return;
      }

      // Populate datalist with FRIENDLY labels only (so the input shows label)
      headerOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.label;
        repHeaderList.appendChild(o);
      });

      // After options load, restore any saved selection into the input (label),
      // while keeping raw available in storage.
      try {
        const savedLabel = localStorage.getItem(LN_REP_LABEL_STORAGE_KEY) || "";
        const savedRaw   = localStorage.getItem(LN_REP_FILE_STORAGE_KEY) || localStorage.getItem(LN_REP_STORAGE_KEY) || "";

        // Prefer saved label if it still matches an option
        if (savedLabel) {
          const match = findOptionByLabel(savedLabel);
          if (match) {
            setLnRepSelection(match);
            return;
          }
        }

        // Otherwise, if we have a raw filename, derive label from it and restore if possible
        if (savedRaw) {
          const matchByRaw = findOptionByRaw(savedRaw);
          if (matchByRaw) {
            setLnRepSelection(matchByRaw);
            return;
          }

          // Fallback: show derived label even if not in list (rare)
          const derivedLabel = displayNameFromFilename(savedRaw);
          setLnRepSelection({ raw: savedRaw, label: derivedLabel });
        }
      } catch (e) {}
    }

    // When user selects a real option (label), store BOTH label + raw
    function commitFromInputIfValid() {
      const val = (repHeaderSearch?.value || "").trim();
      if (!val) return;

      const match = findOptionByLabel(val);
      if (!match) return; // don’t persist arbitrary typing
      setLnRepSelection(match);
    }
    /* =========================
 * HEADER UPLOAD (IndexedDB + localStorage fallback)
 * ========================= */

// Storage keys (schema-versioned)
const UPLOADED_HEADER_SCHEMA = 1;
const UPLOADED_HEADER_META_KEY = "LNP_UPLOADED_HEADER_META_V1";
const UPLOADED_HEADER_DATAURL_KEY = "LNP_UPLOADED_HEADER_DATAURL_V1"; // fallback only (may be removed if too big)

// IndexedDB settings
const LNP_IDB_NAME = "LNPresentsDB";
const LNP_IDB_VERSION = 1;
const LNP_IDB_STORE = "kv";
const LNP_IDB_KEY = "uploadedHeaderV1";

function openLnpDb(){
  return new Promise((resolve, reject) => {
    try{
      const req = indexedDB.open(LNP_IDB_NAME, LNP_IDB_VERSION);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(LNP_IDB_STORE)) db.createObjectStore(LNP_IDB_STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    } catch (e){
      reject(e);
    }
  });
}

async function idbSet(key, value){
  const db = await openLnpDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(LNP_IDB_STORE, "readwrite");
    tx.objectStore(LNP_IDB_STORE).put(value, key);
    tx.oncomplete = () => { try{ db.close(); } catch(e){} resolve(true); };
    tx.onerror = () => { try{ db.close(); } catch(e){} reject(tx.error); };
  });
}

async function idbGet(key){
  const db = await openLnpDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(LNP_IDB_STORE, "readonly");
    const req = tx.objectStore(LNP_IDB_STORE).get(key);
    req.onsuccess = () => { try{ db.close(); } catch(e){} resolve(req.result); };
    req.onerror = () => { try{ db.close(); } catch(e){} reject(req.error); };
  });
}

async function idbDel(key){
  const db = await openLnpDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(LNP_IDB_STORE, "readwrite");
    tx.objectStore(LNP_IDB_STORE).delete(key);
    tx.oncomplete = () => { try{ db.close(); } catch(e){} resolve(true); };
    tx.onerror = () => { try{ db.close(); } catch(e){} reject(tx.error); };
  });
}

function fileToDataUrl(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result || ""));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function bytesToNice(n){
  if (!Number.isFinite(n) || n <= 0) return "";
  const kb = n / 1024;
  if (kb < 1024) return `${kb.toFixed(0)} KB`;
  return `${(kb/1024).toFixed(2)} MB`;
}

// Best-effort: store in IDB; fallback to localStorage only if modest size
async function storeUploadedHeader({ dataUrl, type, name, size }){
  const meta = {
    __schema: UPLOADED_HEADER_SCHEMA,
    storedAt: new Date().toISOString(),
    type: type || "",
    name: name || "",
    size: size || 0
  };

  // 1) Try IndexedDB first (best retention)
  try{
    await idbSet(LNP_IDB_KEY, { meta, dataUrl });
    // Keep a small meta marker in localStorage so Presenter can know it's available
    try{ localStorage.setItem(UPLOADED_HEADER_META_KEY, JSON.stringify(meta)); } catch(e){}
    // Optional fallback dataURL (keep only if not huge)
    try{
      // Many browsers allow ~5MB in localStorage; keep a conservative limit.
      if (dataUrl.length < 1_500_000) localStorage.setItem(UPLOADED_HEADER_DATAURL_KEY, dataUrl);
      else localStorage.removeItem(UPLOADED_HEADER_DATAURL_KEY);
    } catch(e){}
    return true;
  } catch (e){
    console.warn("IndexedDB store failed; falling back to localStorage if possible:", e);
  }

  // 2) Fallback: localStorage dataURL (may fail if large)
  try{
    localStorage.setItem(UPLOADED_HEADER_META_KEY, JSON.stringify(meta));
    localStorage.setItem(UPLOADED_HEADER_DATAURL_KEY, dataUrl);
    return true;
  } catch (e){
    console.error("localStorage fallback failed (image likely too large):", e);
    return false;
  }
}

async function loadUploadedHeader(){
  // 1) Try IndexedDB
  try{
    const obj = await idbGet(LNP_IDB_KEY);
    if (obj && obj.dataUrl) return obj;
  } catch(e){}

  // 2) Try localStorage fallback
  try{
    const metaStr = localStorage.getItem(UPLOADED_HEADER_META_KEY);
    const dataUrl = localStorage.getItem(UPLOADED_HEADER_DATAURL_KEY);
    if (dataUrl) {
      const meta = metaStr ? JSON.parse(metaStr) : { __schema: UPLOADED_HEADER_SCHEMA };
      return { meta, dataUrl };
    }
  } catch(e){}

  return null;
}

async function clearUploadedHeader(){
  try{ await idbDel(LNP_IDB_KEY); } catch(e){}
  try{ localStorage.removeItem(UPLOADED_HEADER_META_KEY); } catch(e){}
  try{ localStorage.removeItem(UPLOADED_HEADER_DATAURL_KEY); } catch(e){}
}

function setHeaderPreview({ dataUrl, meta }){
  if (!headerPreviewImg || !headerPreviewStatus) return;

  if (!dataUrl) {
    headerPreviewImg.style.display = "none";
    headerPreviewImg.src = "";
    headerPreviewStatus.textContent = "No uploaded header yet.";
    if (headerPreviewInfo) headerPreviewInfo.textContent = "";
    return;
  }

  headerPreviewImg.src = dataUrl;
  headerPreviewImg.style.display = "block";

  const name = meta?.name ? ` • ${meta.name}` : "";
  const size = meta?.size ? ` • ${bytesToNice(meta.size)}` : "";
  headerPreviewStatus.textContent = "Uploaded header will be used in Presenter.";
}

async function initHeaderUploadUi(){
  const existing = await loadUploadedHeader();
  setHeaderPreview({ dataUrl: existing?.dataUrl || "", meta: existing?.meta });

  if (headerUploadInput) {
    headerUploadInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const isOk = /image\/(png|jpeg)/i.test(file.type) || /\.(png|jpe?g)$/i.test(file.name);
      if (!isOk) {
        alert("Please upload a JPG or PNG file.");
        e.target.value = "";
        return;
      }

      // Optional guardrail: huge images bloat storage; still try, but warn
      if (file.size > 6 * 1024 * 1024) {
        const ok = confirm("That image is larger than 6MB. It may not persist reliably in browser storage. Continue?");
        if (!ok) { e.target.value = ""; return; }
      }

      try{
        const dataUrl = await fileToDataUrl(file);
        const ok = await storeUploadedHeader({
          dataUrl,
          type: file.type,
          name: file.name,
          size: file.size
        });

        if (!ok) {
          alert("Could not store this header (likely too large). Try a smaller image.");
          e.target.value = "";
          return;
        }

        // IMPORTANT: uploaded header should take precedence over repo selection in Presenter
        // We'll keep the dropdown selection intact, but Presenter will prefer uploaded dataUrl.
        setHeaderPreview({
          dataUrl,
          meta: { name: file.name, size: file.size, type: file.type }
        });

        // Rebuild config so Presenter has it immediately
        buildAppConfigFromState(state);
        persistNow();
        alert("Header uploaded and saved for Presenter on this device.");
      } catch(err){
        console.error(err);
        alert("Upload failed. Please try again.");
      } finally {
        e.target.value = "";
      }
    });
  }

  if (clearUploadedHeaderBtn) {
    clearUploadedHeaderBtn.addEventListener("click", async () => {
      const ok = confirm("Clear the uploaded header from this device/browser?");
      if (!ok) return;
      await clearUploadedHeader();
      setHeaderPreview({ dataUrl: "", meta: null });
      buildAppConfigFromState(state);
      persistNow();
    });
  }
}

// boot it
initHeaderUploadUi();

    if (repHeaderSearch) {
      repHeaderSearch.addEventListener("change", commitFromInputIfValid);
      repHeaderSearch.addEventListener("input", commitFromInputIfValid); // Safari-friendly
    }

    // Submit header email button (unchanged)
    if (submitHeaderBtn) {
      submitHeaderBtn.addEventListener("click", (e) => {
        e.preventDefault();

        const to = "chase.lawarregardner@lexisnexis.com";
        const subject = "LNPresents Header Submission";
        const body =
`Hello,

You have opted to submit your header to be displayed on LNPresents. This is a great way to personalize your presentations and maintain a consistent image across communication channels. To submit your header please:

• Ensure your header is in JPG or PNG format.
• Don’t worry about the file name; it will be renamed upon submission.
• Attach your header to this email.

Thanks,
LNPresents Support`;

        const mailto =
          `mailto:${encodeURIComponent(to)}` +
          `?subject=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        window.location.assign(mailto);
      });
    }

    // Load headers on boot
    loadHeaderFolderOptions();

    /* =========================
     * C) TERM DEFINITIONS
     * ========================= */
    const retentionTerms = [
      { key: "currentSpend",     label: "Current Spend",     input: { type: "text", dataKey: "clgCurrentSpend",    placeholder: "$0.00" }, defaultSelected: false },
      { key: "effectiveDate",    label: "Effective Date",    input: { type: "date", dataKey: "clgEffectiveDate" },  defaultSelected: false },
      { key: "currentTermEnd",   label: "Current Term End",  input: { type: "date", dataKey: "clgCurrentTermEnd" }, defaultSelected: false },
      { key: "extensionTermEnd", label: "Extension Term End",input: { type: "date", dataKey: "clgExtensionTermEnd"}, defaultSelected: false },
      { key: "extensionTerm",    label: "Term Extension",    input: { type: "select", dataKey: "clgExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] }, defaultSelected: false }
    ];

    const newBizTerms = [
      { key: "ActivationDate", label: "Activation Date", input: { type: "date", dataKey: "clgActivationDate" }, defaultSelected: false },
      { key: "introPrice",     label: "Promo Price",     input: { type: "text", dataKey: "clgIntroPrice", placeholder: "$0.00" }, defaultSelected: false },
      { key: "termStartDate",  label: "Promo End Date",  input: { type: "date", dataKey: "clgTermStartDate" }, defaultSelected: false },
      { key: "termEndDate",    label: "Term End Date",   input: { type: "date", dataKey: "clgTermEndDate" }, defaultSelected: false },
      { key: "nbExtensionTerm",label: "Term Length",     input: { type: "select", dataKey: "clgnbExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] }, defaultSelected: false }
    ];
    /* =========================
     * C.1) TERMS V4 (Tiles + per-term Applies-to-All)
     * - Classic terms: checkbox + single global value
     * - Tile terms: drag to activate, per-plan by default, optional Applies-to-All
     * ========================= */
    const TERMS_TILES_STORAGE_KEY = "LNP_STATE_V4_TERMS_TILES";
    const TERMS_TILES_SCHEMA = 4;

    const classicTermsDefs = [
      { id: "attorneyCount", label: "Attorney Count", type: "text", dataKey: "clgNumAttorneys", placeholder: "0" },
      { id: "currentSpend",  label: "Current Spend",  type: "text", dataKey: "clgCurrentSpend", placeholder: "$0.00" },
      { id: "currentTermEnd",label: "Current Term End",type: "date", dataKey: "clgCurrentTermEnd" }
    ];

    const tileTermsCatalog = {
      retention: [
        { id: "effectiveDate",     label: "Effective Date",      input: { type: "date", dataKey: "clgEffectiveDate" } },
        { id: "extensionTermEnd",  label: "Extension Term End",  input: { type: "date", dataKey: "clgExtensionTermEnd" } },
        { id: "extensionTerm",     label: "Term Extension",      input: { type: "select", dataKey: "clgExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] } },
        { id: "yoyIncrease",       label: "Year over Year Increase", input: { type: "text", dataKey: "clgYoyIncrease", placeholder: "3%" } }
      ],
      newbiz: [
        { id: "activationDate", label: "Activation Date", input: { type: "date", dataKey: "clgActivationDate" } },
        { id: "introPrice",     label: "Promo Price",     input: { type: "text", dataKey: "clgIntroPrice", placeholder: "$0.00" } },
        { id: "termStartDate",  label: "Promo End Date",  input: { type: "date", dataKey: "clgTermStartDate" } },
        { id: "termEndDate",    label: "Term End Date",   input: { type: "date", dataKey: "clgTermEndDate" } },
        { id: "nbExtensionTerm",label: "Term Length",     input: { type: "select", dataKey: "clgnbExtensionTerm", options: ["", "1 year", "2 years", "3 years", "4 years", "5 years"] } }
      ]
    };

    const tileTermById = (() => {
      const map = {};
      Object.keys(tileTermsCatalog).forEach(g => {
        tileTermsCatalog[g].forEach(t => { map[t.id] = { ...t, group: g }; });
      });
      return map;
    })();

    const saved = JSON.parse(localStorage.getItem("clgFormVars") || "{}");

    function defaultTermsTilesState() {
      const classicSel = {};
      const classicVals = {};
      classicTermsDefs.forEach(d => { classicSel[d.id] = false; classicVals[d.id] = ""; });
      return {
        __schema: TERMS_TILES_SCHEMA,
        classicTermsSelected: classicSel,
        classicTermsValues: classicVals,
        activeTileTermsOrder: { retention: [], newbiz: [] },
        tileTermsState: {}
      };
    }

    function loadTermsTilesState() {
      let raw = null;
      try { raw = JSON.parse(localStorage.getItem(TERMS_TILES_STORAGE_KEY) || "null"); } catch (e) { raw = null; }
      if (raw && raw.__schema === TERMS_TILES_SCHEMA) return raw;

      // Best-effort migration from legacy selection model (clgSelectedTerms + single values)
      const migrated = defaultTermsTilesState();

      const legacySelected = Array.isArray(saved.clgSelectedTerms) ? saved.clgSelectedTerms : [];
      // Classic terms
      migrated.classicTermsSelected.attorneyCount = legacySelected.includes("numAttorneys");
      migrated.classicTermsSelected.currentSpend  = legacySelected.includes("currentSpend");
      migrated.classicTermsSelected.currentTermEnd= legacySelected.includes("currentTermEnd");

      migrated.classicTermsValues.attorneyCount = saved.clgNumAttorneys || "";
      migrated.classicTermsValues.currentSpend  = saved.clgCurrentSpend || "";
      migrated.classicTermsValues.currentTermEnd= saved.clgCurrentTermEnd || "";

      // Tile terms (previously global-only -> migrate as Applies-to-All ON)
      function migrateTile(termId, dataKey, group) {
        const isSel = legacySelected.includes(termId);
        const hasVal = !!(saved[dataKey] != null && String(saved[dataKey]).trim() !== "");
        if (!isSel && !hasVal) return;
        if (!migrated.tileTermsState[termId]) {
          migrated.tileTermsState[termId] = { active: false, appliesToAll: true, globalValue: "", perPlanValues: {} };
        }
        migrated.tileTermsState[termId].active = true;
        migrated.tileTermsState[termId].appliesToAll = true;
        migrated.tileTermsState[termId].globalValue = saved[dataKey] || "";
        if (!migrated.activeTileTermsOrder[group].includes(termId)) migrated.activeTileTermsOrder[group].push(termId);
      }

      migrateTile("effectiveDate", "clgEffectiveDate", "retention");
      migrateTile("extensionTermEnd", "clgExtensionTermEnd", "retention");
      migrateTile("extensionTerm", "clgExtensionTerm", "retention");
      migrateTile("yoyIncrease", "clgYoyIncrease", "retention");

      migrateTile("activationDate", "clgActivationDate", "newbiz");
      migrateTile("introPrice", "clgIntroPrice", "newbiz");
      migrateTile("termStartDate", "clgTermStartDate", "newbiz");
      migrateTile("termEndDate", "clgTermEndDate", "newbiz");
      migrateTile("nbExtensionTerm", "clgnbExtensionTerm", "newbiz");

      // Persist migrated state (do NOT delete legacy storage)
      try { localStorage.setItem(TERMS_TILES_STORAGE_KEY, JSON.stringify(migrated)); } catch (e) {}
      return migrated;
    }

    let termsTilesState = loadTermsTilesState();

    function persistTermsTiles() {
      try {
        termsTilesState.__schema = TERMS_TILES_SCHEMA;
        localStorage.setItem(TERMS_TILES_STORAGE_KEY, JSON.stringify(termsTilesState));
      } catch (e) {}
    }

    function ensureTileTerm(termId) {
      if (!termsTilesState.tileTermsState[termId]) {
        termsTilesState.tileTermsState[termId] = { active: false, appliesToAll: false, globalValue: "", perPlanValues: {} };
      }
      return termsTilesState.tileTermsState[termId];
    }

    function currentPlanIds() {
      return (state.clgPlans || []).map(p => p.__id).filter(Boolean);
    }

    function syncTileTermPlanSlots() {
      const ids = new Set(currentPlanIds());
      Object.keys(termsTilesState.tileTermsState || {}).forEach(termId => {
        const st = ensureTileTerm(termId);
        if (!st.perPlanValues || typeof st.perPlanValues !== "object") st.perPlanValues = {};
        // Remove deleted plans
        Object.keys(st.perPlanValues).forEach(pid => { if (!ids.has(pid)) delete st.perPlanValues[pid]; });
        // Add new plans
        ids.forEach(pid => { if (!(pid in st.perPlanValues)) st.perPlanValues[pid] = ""; });
      });
      persistTermsTiles();
    }


    /* =========================
     * D) PERSISTED & STATE
     * ========================= */

    function makeEmptyPlan() {
      return {
        __id: "plan_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8),
        clgPlatform: "",
        clgPriceCents: null,
        clgPrice: "",
        clgContents: "",
        clgCtaLabel: "",
        clgCtaUrl: ""
      };
    }

    const state = {
      clgFirmName: saved.clgFirmName || "",
      clgNumAttorneys: saved.clgNumAttorneys || "",
      clgYoyIncrease: saved.clgYoyIncrease || "",
      clgIncentive: saved.clgIncentive || "",
      clgCurrentSpend: saved.clgCurrentSpend || "",
      clgEffectiveDate: saved.clgEffectiveDate || "",
      clgActivationDate: saved.clgActivationDate || "",
      clgCurrentTermEnd: saved.clgCurrentTermEnd || "",
      clgTermEndDate: saved.clgTermEndDate || "",
      clgExtensionTermEnd: saved.clgExtensionTermEnd || "",
      clgExtensionTerm: saved.clgExtensionTerm || "",
      clgnbExtensionTerm: saved.clgnbExtensionTerm || "",
      clgIntroPrice: saved.clgIntroPrice || "",
      clgTermStartDate: saved.clgTermStartDate || "",
      clgSelectedTerms: Array.isArray(saved.clgSelectedTerms) ? saved.clgSelectedTerms : [],
      clgPlans: Array.isArray(saved.clgPlans) && saved.clgPlans.length ? saved.clgPlans : [makeEmptyPlan()]
    };

    function ensurePlanIds() {
      if (!Array.isArray(state.clgPlans)) state.clgPlans = [makeEmptyPlan()];
      state.clgPlans = state.clgPlans.map(p => {
        if (!p || typeof p !== "object") p = {};
        if (!p.__id) p.__id = "plan_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
        if (p.clgCtaLabel == null) p.clgCtaLabel = "";
        if (p.clgCtaUrl == null) p.clgCtaUrl = "";
        return p;
      });
    }
    ensurePlanIds();

    // NEW: snapshot -> used by Save & profile download
    function buildProfilePayload() {
      return {
        clgFirmName: state.clgFirmName,
        clgNumAttorneys: state.clgNumAttorneys,
        clgYoyIncrease: state.clgYoyIncrease,
        clgIncentive: state.clgIncentive,
        clgSelectedTerms: state.clgSelectedTerms,
        clgCurrentSpend: state.clgCurrentSpend,
        clgEffectiveDate: state.clgEffectiveDate,
        clgActivationDate: state.clgActivationDate,
        clgCurrentTermEnd: state.clgCurrentTermEnd,
        clgTermEndDate: state.clgTermEndDate,
        clgExtensionTermEnd: state.clgExtensionTermEnd,
        clgExtensionTerm: state.clgExtensionTerm,
        clgnbExtensionTerm: state.clgnbExtensionTerm,
        clgIntroPrice: state.clgIntroPrice,
        clgTermStartDate: state.clgTermStartDate,
        clgPlans: state.clgPlans,
        lnpTermsTiles: termsTilesState
      };
    }

    // NEW: hydrate DOM from current state (top fields + term selections)
    function hydrateFormFromState() {
      form.querySelectorAll("[data-key]").forEach(el => {
        const key = el.getAttribute("data-key");
        if (!key) return;
        const value = state[key];
        el.value = value != null ? value : "";
      });

      form.querySelectorAll("[data-term-option]").forEach(cb => {
        const key = cb.getAttribute("data-term-option");
        if (!key) return;
        const selected = Array.isArray(state.clgSelectedTerms) && state.clgSelectedTerms.includes(key);
        cb.checked = selected;
      });
    }

    // NEW: apply profile JSON to state + DOM + storage
    function applyLoadedProfile(raw) {
      if (!raw || typeof raw !== "object") {
        alert("That file does not look like an LN Presents profile.");
        return;
      }

      const data = raw.data && typeof raw.data === "object" ? raw.data : raw;

      state.clgFirmName = data.clgFirmName || "";
      state.clgNumAttorneys = data.clgNumAttorneys || "";
      state.clgYoyIncrease = data.clgYoyIncrease || "";
      state.clgIncentive = data.clgIncentive || "";
      state.clgSelectedTerms = Array.isArray(data.clgSelectedTerms) ? data.clgSelectedTerms : [];
      state.clgCurrentSpend = data.clgCurrentSpend || "";
      state.clgEffectiveDate = data.clgEffectiveDate || "";
      state.clgActivationDate = data.clgActivationDate || "";
      state.clgCurrentTermEnd = data.clgCurrentTermEnd || "";
      state.clgTermEndDate = data.clgTermEndDate || "";
      state.clgExtensionTermEnd = data.clgExtensionTermEnd || "";
      state.clgExtensionTerm = data.clgExtensionTerm || "";
      state.clgnbExtensionTerm = data.clgnbExtensionTerm || "";
      state.clgIntroPrice = data.clgIntroPrice || "";
      state.clgTermStartDate = data.clgTermStartDate || "";
      state.clgPlans = Array.isArray(data.clgPlans) && data.clgPlans.length ? data.clgPlans : [makeEmptyPlan()];

      ensurePlanIds();
      if (data.lnpTermsTiles && typeof data.lnpTermsTiles === "object") {
        termsTilesState = data.lnpTermsTiles;
        // normalize / defaults
        if (!termsTilesState || typeof termsTilesState !== "object") termsTilesState = defaultTermsTilesState();
        if (!termsTilesState.activeTileTermsOrder) termsTilesState.activeTileTermsOrder = { retention: [], newbiz: [] };
        if (!termsTilesState.tileTermsState) termsTilesState.tileTermsState = {};
        if (!termsTilesState.classicTermsSelected) termsTilesState.classicTermsSelected = defaultTermsTilesState().classicTermsSelected;
        if (!termsTilesState.classicTermsValues) termsTilesState.classicTermsValues = defaultTermsTilesState().classicTermsValues;
        persistTermsTiles();
      }

      hydrateFormFromState();

      renderClassicTopTerms();
      renderTermsTilesPanel("retention", retentionHost);
      renderTermsTilesPanel("newbiz", newBizHost);
      syncTileTermPlanSlots();
      renderPlans();
      persistNow();

      const toSave = buildProfilePayload();
      localStorage.setItem("clgFormVars", JSON.stringify(toSave));
      buildAppConfigFromState(state);
    }

    /* =========================
     * E) GENERIC HELPERS
     * ========================= */
    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
    }

    function fmtDate(iso) {
      if (!iso) return "";
      try { return new Date(iso + "T00:00:00").toLocaleDateString(); }
      catch { return iso; }
    }

    // RTE Normalization helpers
    const SIZE_PRESET_CLASSES = ['rte-size-body','rte-size-subhead','rte-size-head'];
    const SIZE_PRESET_ORDER = ['body','subhead','head'];
    const SIZE_PRESETS = {
      body:{px:14, class:'rte-size-body'},
      subhead:{px:17, class:'rte-size-subhead'},
      head:{px:19, class:'rte-size-head'}
    };

    function closestPreset(px){
      let best = 'body', bestDiff = Infinity;
      for (const key of SIZE_PRESET_ORDER){
        const d = Math.abs(px - SIZE_PRESETS[key].px);
        if (d < bestDiff){ bestDiff = d; best = key; }
      }
      return best;
    }

    /* ===== NEW HELPERS FOR MORE OUTLOOK-FRIENDLY COPY ===== */
    function extractBodyHtmlFromEmail(fullHtml) {
      const match = fullHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      return match ? match[1] : fullHtml;
    }

    async function copyEmailHtmlWithFallback(fullHtml) {
      const fragmentHtml = extractBodyHtmlFromEmail(fullHtml);
      let success = false;

      try {
        const temp = document.createElement('div');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        temp.style.top = '0';
        temp.style.opacity = '0';
        temp.setAttribute('contenteditable', 'true');
        temp.innerHTML = fragmentHtml;

        document.body.appendChild(temp);

        const range = document.createRange();
        range.selectNodeContents(temp);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        success = document.execCommand('copy');

        sel.removeAllRanges();
        document.body.removeChild(temp);
      } catch (e) {
        console.warn('execCommand copy failed:', e);
      }

      if (success) return true;

      try {
        if (navigator.clipboard && window.ClipboardItem) {
          const blobHtml = new Blob([fragmentHtml], { type: 'text/html' });
          const blobText = new Blob([fragmentHtml.replace(/<[^>]+>/g, '')], { type: 'text/plain' });
          const item = new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText });
          await navigator.clipboard.write([item]);
          return true;
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(fragmentHtml);
          return true;
        }
      } catch (err) {
        console.error('Async clipboard failed:', err);
      }

      return false;
    }

    if (copyProposalBtn) {
      copyProposalBtn.addEventListener('click', async () => {
        const data = {
          clgFirmName:      state.clgFirmName,
          clgNumAttorneys:  state.clgNumAttorneys,
          clgYoyIncrease:   state.clgYoyIncrease,
          clgIncentive:     state.clgIncentive,
          clgSelectedTerms: state.clgSelectedTerms,
          clgCurrentSpend:  state.clgCurrentSpend,
          clgEffectiveDate: state.clgEffectiveDate,
          clgActivationDate: state.clgActivationDate,
          clgCurrentTermEnd: state.clgCurrentTermEnd,
          clgTermEndDate:    state.clgTermEndDate,
          clgExtensionTermEnd: state.clgExtensionTermEnd,
          clgExtensionTerm:    state.clgExtensionTerm,
          clgnbExtensionTerm:  state.clgnbExtensionTerm,
          clgIntroPrice:       state.clgIntroPrice,
          clgTermStartDate:    state.clgTermStartDate
        };

        const plans = (state.clgPlans || []).map((p, idx) => ({
          name:     p.clgPlatform || `Plan ${idx + 1}`,
          price:    p.clgPrice || "",
          term:     "",
          contents: p.clgContents || ""
        }));

        const fullHtml = buildEmailHtml(plans, data);

        const ok = await copyEmailHtmlWithFallback(fullHtml);
        if (ok) {
          alert("Proposal copied. In Outlook, click into the message body and paste.");
        } else {
          alert("Could not copy automatically. As a fallback, use the Export Email HTML option, open it in a browser, then copy & paste into Outlook.");
        }
      });
    }

    function applyTextPresetMapping(doc){
      const mapEl = (el) => {
        el.classList.remove(...SIZE_PRESET_CLASSES);
        const tag = el.tagName.toLowerCase();

        if (['h1','h2','h3'].includes(tag)) {
          el.classList.add(tag === 'h1' ? 'rte-size-head' : 'rte-size-subhead');
        }
        const style = el.getAttribute('style') || '';
        const m = /font-size\s*:\s*([0-9.]+)\s*(px|pt|rem|em)/i.exec(style);
        if (m) {
          const val = parseFloat(m[1]);
          const unit = (m[2] || 'px').toLowerCase();
          let px = val;
          if (unit === 'pt')  px = val * (96/72);
          if (unit === 'rem' || unit === 'em') px = val * 16;
          el.classList.add(SIZE_PRESETS[closestPreset(px)].class);
        }
        if (style) {
          const color = /color\s*:\s*[^;]+/i.exec(style);
          if (color) el.setAttribute('style', color[0]); else el.removeAttribute('style');
        }
      };
      doc.querySelectorAll('p, li, span, h1, h2, h3').forEach(mapEl);
    }

    function blockifyTopLevel(doc){
      [...doc.body.childNodes].forEach(node=>{
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') {
          const p = doc.createElement('p'); p.textContent = node.textContent; node.replaceWith(p);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toLowerCase();
          if (!['p','ul','ol'].includes(tag)) {
            const p = doc.createElement('p'); p.innerHTML = node.outerHTML; node.replaceWith(p);
          }
        }
      });
    }

    function normalizeForPaste(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      applyTextPresetMapping(doc);

      doc.querySelectorAll('ul, ol').forEach(list => {
        const frag = doc.createDocumentFragment();
        list.querySelectorAll('li').forEach(li => {
          const p = doc.createElement('p');
          p.innerHTML = li.innerHTML;
          frag.appendChild(p);
        });
        list.replaceWith(frag);
      });

      blockifyTopLevel(doc);
      doc.querySelectorAll('h1,h2,h3').forEach(h => { if (!h.textContent.trim()) h.remove(); });
      return doc.body.innerHTML || '<p><br></p>';

      doc.querySelectorAll('p').forEach(p => {
      p.innerHTML = p.innerHTML.replace(/^[\s•\-–—]+/g, '• ');
      });

    }

    function normalizeForStorage(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      applyTextPresetMapping(doc);
      blockifyTopLevel(doc);
      doc.querySelectorAll('h1,h2,h3').forEach(h => { if (!h.textContent.trim()) h.remove(); });
      return doc.body.innerHTML || '<p><br></p>';
    }

    function sanitizeAndReplaceIfChanged(editor){
      const before = editor.innerHTML;
      const cleaned = DOMPurify.sanitize(before, PLAN_RTE_ALLOWED);
      const normalized = normalizeForStorage(cleaned);

      if (normalized !== before) {
        const y = editor.scrollTop;
        const lockH = editor.clientHeight;
        editor.style.minHeight = lockH + 'px';
        editor.innerHTML = normalized;
        editor.scrollTop = y;
        requestAnimationFrame(()=> { editor.style.minHeight = ''; });
      }
    }

    function parseCurrencyToCents(str) {
      const normalized = String(str).replace(/[^0-9.]/g, "");
      if (!normalized) return null;
      const num = Number(normalized);
      if (Number.isNaN(num)) return null;
      return Math.round(num * 100);
    }

    function parsePercentToBps(str) {
      const normalized = String(str).replace(/[^0-9.\-]/g, "");
      if (!normalized) return null;
      const num = Number(normalized);
      if (Number.isNaN(num)) return null;
      const pct = num <= 1 ? num * 100 : num;
      return Math.round(pct * 100);
    }

    function normalizePlan(raw) {
      if (!raw) return {};
      return {
        name: raw.clgPlatform || raw.name || raw.planName || 'Plan',
        price: raw.clgPrice || raw.price || raw.planPrice || '',
        contents: raw.clgContents || raw.contents || raw.planContents || '',
        term: raw.term || raw.selectedTerm || raw.selectedTerms || ''
      };
    }

    function getProposalData() {
      if (window.clgFormVars) return window.clgFormVars;
      const ls = localStorage.getItem('clgFormVars') || localStorage.getItem('lnpresentsFormVars');
      if (ls) { try { return JSON.parse(ls); } catch (e) { console.warn('Could not parse proposal from localStorage', e); } }
      return { plans: [] };
    }

    function downloadEmailHtml(content, filename) {
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function buildSelectedTermsHtml(data = {}) {
      const sel = Array.isArray(data.clgSelectedTerms) ? data.clgSelectedTerms : [];
      if (!sel.length) return "";
      const items = [];

      const add = (key, label, value, type) => {
        if (!sel.includes(key)) return;
        let out = label;
        if (value) out += ": " + (type === "date" ? fmtDate(value) : value);
        items.push(
          '<li style="margin:0 0 4px 0; font-size:12px; color:#374151;">' +
          escapeHtml(out) +
          '</li>'
        );
      };

      add("numAttorneys","Number of Attorneys",data.clgNumAttorneys);
      add("yoyIncrease","Year over Year increase",data.clgYoyIncrease);

      add("currentSpend","Current Spend",data.clgCurrentSpend);
      add("effectiveDate","Effective Date",data.clgEffectiveDate,"date");
      add("currentTermEnd","Current Term End",data.clgCurrentTermEnd,"date");
      add("extensionTermEnd","Extension Term End",data.clgExtensionTermEnd,"date");
      add("extensionTerm","Term Extension",data.clgExtensionTerm);

      add("ActivationDate","Activation Date",data.clgActivationDate,"date");
      add("introPrice","Promo Price",data.clgIntroPrice);
      add("termStartDate","Promo End Date",data.clgTermStartDate,"date");
      add("termEndDate","Term End Date",data.clgTermEndDate,"date");
      add("nbExtensionTerm","Term Length",data.clgnbExtensionTerm);

      return items.join("");
    }

    function buildEmailHtml(plans, data, opts = {}) {
      const firm = (data && (data.clgFirmName || data.firmName)) || "Firm Name";
      const incentive = data && data.clgIncentive ? data.clgIncentive : "";
      const termsListHtml = buildSelectedTermsHtml(data);

      const planRows = (plans && plans.length ? plans : []).reduce((rows, plan, idx) => {
        if (idx % 2 === 0) rows.push([plan]);
        else rows[rows.length - 1].push(plan);
        return rows;
      }, []);

      const planTableHtml = planRows.length
        ? planRows
          .map(rowPlans => `
          <tr>
            ${rowPlans
              .map(plan => `
                <td width="50%" valign="top" style="padding:12px 10px 14px 10px; border-bottom:1px solid #e5e7eb;">
                  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
                    <tr>
                      <td style="font-size:14px; font-weight:600; color:#111827; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 4px 0;">
                        ${escapeHtml(plan.name || "Plan")}
                      </td>
                    </tr>
                    ${
                      plan.price
                        ? `<tr>
                             <td style="font-size:13px; color:#111827; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 2px 0;">
                               <strong>Price:</strong> ${escapeHtml(plan.price)}
                             </td>
                           </tr>`
                        : ""
                    }
                    ${
                      plan.term
                        ? `<tr>
                             <td style="font-size:12px; color:#4b5563; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; padding:0 0 6px 0;">
                               <strong>Term:</strong> ${escapeHtml(plan.term)}
                             </td>
                           </tr>`
                        : ""
                    }
                    ${
                      plan.contents
                        ? `<tr>
                             <td style="font-size:12px; color:#374151; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; line-height:1.5;">
                               ${plan.contents}
                             </td>
                           </tr>`
                        : ""
                    }
                  </table>
                </td>
              `)
              .join("")}
            ${
              rowPlans.length === 1
                ? `<td width="50%" valign="top" style="padding:12px 10px 14px 10px; border-bottom:1px solid #e5e7eb;">
                     &nbsp;
                   </td>`
                : ""
            }
          </tr>
        `)
        .join("")
        : "";

      return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Proposal</title>
</head>
<body style="margin:0; padding:0; background:#ffffff;">
  <table width="600" align="left" cellpadding="0" cellspacing="0" border="0" style="width:600px; margin:16px 0 16px 16px;">
    <tr>
      <td align="left" valign="top" style="padding:0;">
        <table width="100%" cellpadding="0" cellspacing="0" border="0"
               style="border-collapse:separate; border-radius:8px; border:1px solid #e5e7eb; background-color:#ffffff; overflow:hidden;">
          <tr>
            <td style="padding:16px 20px; background:linear-gradient(90deg,#191970,#4b0082); color:#ffffff; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <div style="font-size:12px; text-transform:uppercase; letter-spacing:.1em; opacity:.9;">LexisNexis</div>
              <div style="margin-top:2px; font-size:18px; font-weight:700;">Proposal Summary</div>
              <div style="margin-top:4px; font-size:13px; opacity:.9;">${escapeHtml(firm)}</div>
              ${
                incentive
                  ? `<div style="margin-top:4px; font-size:12px; opacity:.9;">
                       <strong>Incentive:</strong> ${escapeHtml(incentive)}
                     </div>`
                  : ""
              }
            </td>
          </tr>

          <tr>
            <td style="padding:14px 20px; border-bottom:1px solid #e5e7eb; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <div style="font-size:13px; font-weight:600; color:#111827; margin-bottom:6px;">Proposal Details</div>
              ${
                termsListHtml
                  ? `<ul style="list-style:none; margin:0; padding:0;">${termsListHtml}</ul>`
                  : `<p style="margin:0; font-size:12px; color:#6b7280;">(No terms selected)</p>`
              }
            </td>
          </tr>

          ${
            planTableHtml
              ? `
                <tr>
                  <td style="padding:0 12px 8px 12px; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
                    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
                      ${planTableHtml}
                    </table>
                  </td>
                </tr>`
              : ""
          }

          <tr>
            <td style="padding:10px 20px 14px 20px; text-align:center; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
              <p style="margin:0; font-size:11px; color:#9ca3af;">
                LexisNexis Confidential
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;
    }

    /* =========================
     * F) RENDERERS
     * ========================= */
    function renderClassicTopTerms() {
      const host = document.getElementById("classicTopTerms");
      if (!host) return;

      host.innerHTML = `
        <div class="terms-classic-panel__head">
        <div class="terms-classic-grid" id="classicTermsGrid"></div>
      `;

      const grid = host.querySelector("#classicTermsGrid");
      classicTermsDefs.forEach(def => {
        const selected = !!termsTilesState.classicTermsSelected?.[def.id];
        const value = termsTilesState.classicTermsValues?.[def.id] ?? "";

        const row = document.createElement("div");
        row.className = "terms-classic-row";

        const check = document.createElement("div");
        check.className = "term-check";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selected;
        cb.setAttribute("aria-label", "Select " + def.label);
        const box = document.createElement("span");
        box.className = "box";
        check.appendChild(cb);
        check.appendChild(box);

        const right = document.createElement("div");
        const label = document.createElement("div");
        label.className = "term-label";
        label.textContent = def.label;

        const inputWrap = document.createElement("div");
        inputWrap.className = "term-input";
        const input = document.createElement("input");
        input.type = def.type;
        if (def.placeholder) input.placeholder = def.placeholder;
        input.value = value || "";
        inputWrap.appendChild(input);

        right.appendChild(label);
        right.appendChild(inputWrap);

        row.appendChild(check);
        row.appendChild(right);
        grid.appendChild(row);

        cb.addEventListener("change", () => {
          termsTilesState.classicTermsSelected[def.id] = !!cb.checked;
          // Keep legacy state mirrors (compat only)
          if (def.dataKey) {
            if (!state.clgSelectedTerms) state.clgSelectedTerms = [];
            const legacyKey = def.id === "attorneyCount" ? "numAttorneys" : def.id;
            const idx = state.clgSelectedTerms.indexOf(legacyKey);
            if (cb.checked && idx === -1) state.clgSelectedTerms.push(legacyKey);
            if (!cb.checked && idx !== -1) state.clgSelectedTerms.splice(idx, 1);
          }
          persistTermsTiles();
          persistNow();
        });

        input.addEventListener("input", () => {
          termsTilesState.classicTermsValues[def.id] = input.value;
          if (def.dataKey) state[def.dataKey] = input.value; // mirror for exports/compat
          persistTermsTiles();
          persistNow();
        });
      });
    }

    function buildInputElForTile(termDef) {
      let inputEl;
      const t = termDef.input.type;
      if (t === "select") {
        inputEl = document.createElement("select");
        (termDef.input.options || []).forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt === "" ? "-- choose --" : opt;
          inputEl.appendChild(o);
        });
      } else {
        inputEl = document.createElement("input");
        inputEl.type = t;
        if (termDef.input.placeholder) inputEl.placeholder = termDef.input.placeholder;
      }
      return inputEl;
    }

    function renderTermsTilesPanel(group, host) {
      const catalog = tileTermsCatalog[group] || [];
      if (!host) return;

      const groupLabel = group === "retention" ? "Retention" : "New Business";

      host.innerHTML = `
        <div class="terms-tiles-split">
          <div class="terms-tiles-block">
            <div class="terms-tiles-block__head">
              <h3>Available Terms — ${groupLabel}</h3>
            </div>
            <div class="terms-tile-library" id="${group}TileLibrary" aria-label="${groupLabel} available terms"></div>
          </div>

          <div class="terms-tiles-block">
            <div class="terms-tiles-block__head">
              <h3>Active Terms — ${groupLabel}</h3>
            </div>
<div class="terms-dropzone" id="${group}Dropzone" tabindex="0" aria-label="${groupLabel} active terms drop zone">
  <!-- Empty-state drop indicator (auto-hides once terms exist) -->
  <div class="drop-indicator" aria-hidden="true">
    <span class="drop-indicator__icon">＋</span>
    <span class="drop-indicator__text">Drop terms here</span>
    <span class="drop-indicator__sub">Drag from the library above</span>
  </div>
  <div class="terms-active-list" id="${group}ActiveList"></div>
</div>

          </div>
        </div>
      `;

      const lib = host.querySelector(`#${group}TileLibrary`);
      const dropzone = host.querySelector(`#${group}Dropzone`);
      const activeList = host.querySelector(`#${group}ActiveList`);

      const activeOrder = (termsTilesState.activeTileTermsOrder[group] || []).slice();

      // Library tiles
      catalog.forEach(term => {
        const st = ensureTileTerm(term.id);
        const tile = document.createElement("div");
        tile.className = "term-tile" + (st.active ? " is-used" : "");
        tile.setAttribute("role", "button");
        tile.setAttribute("tabindex", st.active ? "-1" : "0");
        tile.setAttribute("draggable", st.active ? "false" : "true");
        tile.dataset.termId = term.id;
        tile.innerHTML = `<span class="dot"></span><span>${term.label}</span>`;

        function activateFromUI() {
          const s = ensureTileTerm(term.id);
          if (s.active) return;
          s.active = true;
          // default OFF (per-plan)
          if (typeof s.appliesToAll !== "boolean") s.appliesToAll = false;
          // inherit from any legacy global value if present
          if (!s.globalValue) {
            const dk = term.input?.dataKey;
            if (dk && state[dk]) s.globalValue = state[dk];
          }
          // seed per-plan keys
          syncTileTermPlanSlots();
          if (!termsTilesState.activeTileTermsOrder[group].includes(term.id)) {
            termsTilesState.activeTileTermsOrder[group].push(term.id);
          }
          persistTermsTiles();
          persistNow();
          renderTermsTilesPanel(group, host);
        }

        tile.addEventListener("click", () => { if (!st.active) activateFromUI(); });
        tile.addEventListener("keydown", (e) => {
          if (st.active) return;
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activateFromUI(); }
        });

        tile.addEventListener("dragstart", (e) => {
          if (st.active) { e.preventDefault(); return; }
          e.dataTransfer.setData("text/plain", term.id);
          e.dataTransfer.effectAllowed = "copy";
        });

        lib.appendChild(tile);
      });

      // Dropzone
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("is-over");
        e.dataTransfer.dropEffect = "copy";
      });
      dropzone.addEventListener("dragleave", () => dropzone.classList.remove("is-over"));
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("is-over");
        const termId = e.dataTransfer.getData("text/plain");
        if (!termId || !tileTermById[termId]) return;
        const termDef = tileTermById[termId];
        const s = ensureTileTerm(termId);
        if (s.active) return;
        s.active = true;
        if (typeof s.appliesToAll !== "boolean") s.appliesToAll = false;
        if (!s.globalValue) {
          const dk = termDef.input?.dataKey;
          if (dk && state[dk]) s.globalValue = state[dk];
        }
        syncTileTermPlanSlots();
        if (!termsTilesState.activeTileTermsOrder[group].includes(termId)) {
          termsTilesState.activeTileTermsOrder[group].push(termId);
        }
        persistTermsTiles();
        persistNow();
        renderTermsTilesPanel(group, host);
      });

      // Active rows
      function renderActiveRows() {
        activeList.innerHTML = "";
        const order = (termsTilesState.activeTileTermsOrder[group] || []).filter(id => ensureTileTerm(id).active);

        order.forEach(termId => {
          const termDef = tileTermById[termId];
          if (!termDef) return;
          const st = ensureTileTerm(termId);

          const row = document.createElement("div");
          row.className = "term-active-row";
          row.dataset.termId = termId;

          const head = document.createElement("div");
          head.className = "term-active-row__head";

          const title = document.createElement("div");
          title.className = "term-active-row__title";

          const handle = document.createElement("div");
          handle.className = "term-drag-handle";
          handle.textContent = "⋮⋮";
          handle.setAttribute("title", "Drag to reorder");
          handle.setAttribute("draggable", "true");

          const name = document.createElement("div");
          name.textContent = termDef.label;

          title.appendChild(handle);
          title.appendChild(name);

          const actions = document.createElement("div");
          actions.className = "term-row-actions";

          const toggleBtn = document.createElement("button");
          toggleBtn.type = "button";
          toggleBtn.className = "applies-toggle";
          toggleBtn.innerHTML = `<span class="switch ${st.appliesToAll ? "is-on" : ""}"></span><span>Applies to All</span>`;

          toggleBtn.addEventListener("click", () => {
            st.appliesToAll = !st.appliesToAll;
            // Keep globalValue in sync when turning ON (use first non-empty per-plan if global is empty)
            if (st.appliesToAll && (!st.globalValue || String(st.globalValue).trim() === "")) {
              const ids = currentPlanIds();
              for (const pid of ids) {
                const v = st.perPlanValues?.[pid];
                if (v && String(v).trim() !== "") { st.globalValue = v; break; }
              }
            }
            persistTermsTiles();
            persistNow();
            renderTermsTilesPanel(group, host);
          });

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "term-remove";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            st.active = false;
            // Remove from order list
            termsTilesState.activeTileTermsOrder[group] = (termsTilesState.activeTileTermsOrder[group] || []).filter(id => id !== termId);
            persistTermsTiles();
            persistNow();
            renderTermsTilesPanel(group, host);
          });

          actions.appendChild(toggleBtn);
          actions.appendChild(removeBtn);

          head.appendChild(title);
          head.appendChild(actions);

          const body = document.createElement("div");
          body.className = "term-active-row__body";

          // Shared or per-plan inputs
          if (st.appliesToAll) {
            const wrap = document.createElement("div");
            wrap.className = "term-shared-input";
            const inputEl = buildInputElForTile(termDef);
            inputEl.value = st.globalValue || "";
            wrap.appendChild(inputEl);
            body.appendChild(wrap);

            inputEl.addEventListener("input", () => {
              st.globalValue = inputEl.value;
              // Mirror to legacy state (for export placeholders)
              const dk = termDef.input?.dataKey;
              if (dk) state[dk] = inputEl.value;
              persistTermsTiles();
              persistNow();
            });

            if (termDef.input?.type === "select") {
              inputEl.addEventListener("change", () => {
                st.globalValue = inputEl.value;
                const dk = termDef.input?.dataKey;
                if (dk) state[dk] = inputEl.value;
                persistTermsTiles();
                persistNow();
              });
            }
          } else {
            syncTileTermPlanSlots();
            const grid = document.createElement("div");
            grid.className = "term-plan-grid";

            (state.clgPlans || []).forEach((plan, idx) => {
              const pid = plan.__id;
              const planName = plan.clgPlatform || `Plan ${idx + 1}`;

              const card = document.createElement("div");
              card.className = "term-plan-input";

              const chip = document.createElement("div");
              chip.className = "term-plan-chip";
              chip.textContent = planName;

              const inputEl = buildInputElForTile(termDef);
              inputEl.value = (st.perPlanValues && pid in st.perPlanValues) ? (st.perPlanValues[pid] || "") : "";

              card.appendChild(chip);
              card.appendChild(inputEl);
              grid.appendChild(card);

              const onUpdate = () => {
                if (!st.perPlanValues || typeof st.perPlanValues !== "object") st.perPlanValues = {};
                st.perPlanValues[pid] = inputEl.value;
                persistTermsTiles();
                persistNow();
              };
              inputEl.addEventListener("input", onUpdate);
              if (termDef.input?.type === "select") inputEl.addEventListener("change", onUpdate);
            });

            body.appendChild(grid);
          }

          row.appendChild(head);
          row.appendChild(body);
          activeList.appendChild(row);

          // Reorder drag
          handle.addEventListener("dragstart", (e) => {
            row.classList.add("term-row--dragging");
            e.dataTransfer.setData("text/plain", termId);
            e.dataTransfer.effectAllowed = "move";
          });
          handle.addEventListener("dragend", () => row.classList.remove("term-row--dragging"));
          row.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          });
          row.addEventListener("drop", (e) => {
            e.preventDefault();
            const movingId = e.dataTransfer.getData("text/plain");
            if (!movingId || movingId === termId) return;
            const arr = (termsTilesState.activeTileTermsOrder[group] || []).slice();
            const from = arr.indexOf(movingId);
            const to = arr.indexOf(termId);
            if (from === -1 || to === -1) return;

            // Decide before/after based on cursor position
            const rect = row.getBoundingClientRect();
            const before = (e.clientY - rect.top) < rect.height / 2;

            arr.splice(from, 1);
            const insertAt = before ? (to > from ? to - 1 : to) : (to > from ? to : to + 1);
            arr.splice(insertAt, 0, movingId);
            termsTilesState.activeTileTermsOrder[group] = arr;

            persistTermsTiles();
            persistNow();
            renderTermsTilesPanel(group, host);
          });
        });
      }

      renderActiveRows();
    }

    function renderPlans() {
      plansContainer.innerHTML = "";
      state.clgPlans.forEach((plan, idx) => {
        const card = document.createElement("div");
        card.className = "plan-card";
        card.setAttribute("draggable", "true");       /* enable drag on card */
        card.dataset.planId = plan.__id;

        card.innerHTML = `
          <div class="plan-card-header">
            <div class="plan-card-title">Plan ${idx + 1}</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <!-- FIXED: handle is real + visible -->
              <button type="button" class="secondary" data-remove="${idx}">Remove</button>
            </div>
          </div>

          <div class="plan-card-topfields">
            <div class="field">
              <label>Platform</label>
              <input type="text" data-plan-idx="${idx}" data-plan-field="clgPlatform" value="${plan.clgPlatform || ""}">
            </div>
            <div class="field">
              <label>Plan Price</label>
              <input type="text" data-plan-idx="${idx}" data-plan-field="clgPrice" value="${plan.clgPrice || ""}" placeholder="$0.00">
            </div>
          </div>

          <div class="field">
            <label>Plan Contents</label>

            <div class="plan-toolbar" data-plan-idx="${idx}" role="toolbar" aria-label="Formatting">
              <button type="button" data-cmd="bold" title="Bold (⌘/Ctrl+B)"><b>B</b></button>
              <button type="button" data-cmd="italic" title="Italic (⌘/Ctrl+I)"><i>I</i></button>
              <button type="button" data-cmd="underline" title="Underline (⌘/Ctrl+U)"><u>U</u></button>
              <button type="button" data-cmd="insertUnorderedList" title="Bulleted list">• • •</button>
              <button type="button" data-cmd="insertOrderedList" title="Numbered list">1.</button>
              <button type="button" data-cmd="createLink" title="Set plan CTA (⌘/Ctrl+K)">CTA Link</button>
              <input type="color" class="rte-color" aria-label="Text color">
              <select data-size-select class="rte-size-select" aria-label="Text size">
                <option value="body">Body</option>
                <option value="subhead">Subhead</option>
                <option value="head">Head</option>
              </select>
              <button type="button" data-cmd="removeFormat" title="Clear formatting">Clear</button>
            </div>

            <div class="plan-contents rte" contenteditable="true" data-plan-content="true"
              data-plan-idx="${idx}" data-plan-field="clgContents"
              placeholder="Type or paste content. Use ⌘/Ctrl+B, I, U. Bullets supported.">
              ${(plan.clgContents || '').trim() || '<p><br></p>'}
            </div>

            <small class="muted-text" data-plan-cta-summary>
              ${formatPlanCtaSummary(plan)}
            </small>
            <small class="muted-text">Tip: Use ⌘/Ctrl+B, I, U. Click list buttons for bullets. ⌘/Ctrl+K sets the plan CTA.</small>
          </div>
        `;
        plansContainer.appendChild(card);
      });

      // keep ids stable
      ensurePlanIds();

      if (state.clgPlans.length >= MAX_PLANS) {
        addPlanBtn.disabled = true; addPlanBtn.textContent = "Max plans reached";
      } else {
        addPlanBtn.disabled = false; addPlanBtn.textContent = "+ Add Plan";
      }
    }

    function formatPlanCtaSummary(plan) {
      const defaultLabel = "This Month Only";
      const label = (plan?.clgCtaLabel || "").trim();
      const url = (plan?.clgCtaUrl || "").trim();
      const displayLabel = label || defaultLabel;
      if (!url) return `CTA button: ${displayLabel} (no link)`;
      return `CTA button: ${displayLabel} — ${url}`;
    }

    function updatePlanCtaSummary(card, plan) {
      const summaryEl = card?.querySelector('[data-plan-cta-summary]');
      if (!summaryEl) return;
      summaryEl.textContent = formatPlanCtaSummary(plan);
    }

    function setPlanCtaFromPrompt(idx, card) {
      const plan = state.clgPlans[idx];
      if (!plan) return;
      const currentUrl = plan.clgCtaUrl || "";
      const currentLabel = plan.clgCtaLabel || "";
      const urlInput = prompt("CTA URL (leave blank to clear):", currentUrl);
      if (urlInput === null) return;
      const labelInput = prompt("CTA button label:", currentLabel);
      if (labelInput === null) return;
      plan.clgCtaUrl = String(urlInput || "").trim();
      plan.clgCtaLabel = String(labelInput || "").trim();
      updatePlanCtaSummary(card, plan);
      persistNow();
    }

    function buildAppConfigFromState(s) {
      // TERM DELIVERY RULES (V4):
      // - Classic terms: show in regular terms area if selected
      // - Tile terms: only show if active; if appliesToAll => regular terms area, else => per-plan terms

      const deliveredRegular = [];

      // Classic terms
      const ctSel = termsTilesState.classicTermsSelected || {};
      const ctVal = termsTilesState.classicTermsValues || {};

      function pushRegular(key, label, rawVal, type) {
        if (!label) return;
        let finalLabel = label;
        if (rawVal && String(rawVal).trim() !== "") {
          finalLabel = type === "date" ? `${label}: ${fmtDate(rawVal)}` : `${label}: ${rawVal}`;
        }
        deliveredRegular.push({ key, label: finalLabel });
      }

      if (ctSel.attorneyCount) pushRegular("attorneyCount", "Attorney Count", ctVal.attorneyCount, "text");
      if (ctSel.currentSpend)  pushRegular("currentSpend",  "Current Spend",  ctVal.currentSpend,  "text");
      if (ctSel.currentTermEnd)pushRegular("currentTermEnd","Current Term End",ctVal.currentTermEnd,"date");

      // Tile terms that are active + appliesToAll
      const ttState = termsTilesState.tileTermsState || {};
      const activeOrders = termsTilesState.activeTileTermsOrder || { retention: [], newbiz: [] };

      function maybePushTileRegular(termId) {
        const def = tileTermById[termId];
        if (!def) return;
        const st = ttState[termId];
        if (!st || !st.active || !st.appliesToAll) return;
        const val = st.globalValue || (def.input?.dataKey ? (s[def.input.dataKey] || "") : "");
        pushRegular(termId, def.label, val, def.input?.type === "date" ? "date" : "text");
      }

      activeOrders.retention.forEach(maybePushTileRegular);
      activeOrders.newbiz.forEach(maybePushTileRegular);

      // Cap for regular area (legacy behavior)
      const delivered = deliveredRegular.slice(0, MAX_TERM_SELECTIONS);

      // Plans + plan terms
      const plans = (s.clgPlans || []).map((plan, idx) => {
        const planId = plan.__id;
        const planTerms = [];

        function maybePushPlanTerm(termId) {
          const def = tileTermById[termId];
          if (!def) return;
          const st = ttState[termId];
          if (!st || !st.active || st.appliesToAll) return;

          let rawVal = "";
          if (st.perPlanValues && planId && planId in st.perPlanValues) rawVal = st.perPlanValues[planId] || "";
          if (!rawVal) rawVal = st.globalValue || ""; // fallback

          let label = def.label;
          if (rawVal && String(rawVal).trim() !== "") {
            label = def.input?.type === "date" ? `${def.label}: ${fmtDate(rawVal)}` : `${def.label}: ${rawVal}`;
          }
          planTerms.push({ key: termId, label });
        }

        activeOrders.retention.forEach(maybePushPlanTerm);
        activeOrders.newbiz.forEach(maybePushPlanTerm);

        return {
          id: idx + 1,
          title: plan.clgPlatform || `Plan ${idx + 1}`,
          price: plan.clgPrice || "",
          contentsHtml: plan.clgContents || "",
          terms: planTerms,
          cta: plan.clgCtaLabel || "",
          ctaLabel: plan.clgCtaLabel || "",
          ctaUrl: plan.clgCtaUrl || ""
        };
      });

      // Keep Rep header selection available to the Presenter (raw + label)
      let repFile = "";
      let repLabel = "";
      try {
        repFile  = localStorage.getItem("LNP_LN_REP_FILE")  || localStorage.getItem("LNP_LN_REP") || "";
        repLabel = localStorage.getItem("LNP_LN_REP_LABEL") || "";
      } catch (e) {
        repFile = "";
        repLabel = "";
      }
      // NEW: pull uploaded header (best-effort) so Presenter can use it
let uploadedHeaderDataUrl = "";
let uploadedHeaderMeta = null;

try{
  // Prefer IDB, fallback to localStorage
  // Note: buildAppConfigFromState isn't async; we rely on localStorage fallback being present.
  const metaStr = localStorage.getItem("LNP_UPLOADED_HEADER_META_V1");
  const dataUrl = localStorage.getItem("LNP_UPLOADED_HEADER_DATAURL_V1");
  if (dataUrl) uploadedHeaderDataUrl = dataUrl;
  if (metaStr) uploadedHeaderMeta = JSON.parse(metaStr);
} catch(e){}


      window.APP_CONFIG = {
        ui: {
          companyName: s.clgFirmName || "Default Firm",
          subhead: s.clgIncentive || "",
          terms: delivered,
          plans: plans,

          // Backward-compatible (now RAW filename)
          LN_Rep: repFile,

          // New explicit fields
          LN_RepFile: repFile,
          LN_RepLabel: repLabel,
          uploadedHeaderDataUrl: uploadedHeaderDataUrl || "",
          uploadedHeaderMeta: uploadedHeaderMeta || null

        }
      };
    }

    /* =========================
     * G) RTE SANITIZE/HOOKS
     * ========================= */
    const PLAN_RTE_ALLOWED = {
      ALLOWED_TAGS: ['b','strong','i','em','u','p','br','ul','ol','li','a','span'],
      ALLOWED_ATTR: ['href','target','rel','style','class'],
      FORBID_TAGS: ['style','script','iframe','object','embed','form','input','button','img','video','audio']
    };

    if (window.DOMPurify && DOMPurify.addHook) {
      DOMPurify.addHook('uponSanitizeAttribute', (node, data) => {
        if (data.attrName !== 'style') return;
        const m = /color\s*:\s*([^;]+)/i.exec(data.attrValue);
        if (m) { data.attrValue = `color:${m[1].trim()}`; } else { data.keepAttr = false; }
      });
    }

    const planSelectionByIdx = {};
    function rememberSelectionFor(el){
      const idx = el.getAttribute('data-plan-idx');
      const sel = window.getSelection();
      if (!idx || !sel || sel.rangeCount === 0) return;
      planSelectionByIdx[idx] = sel.getRangeAt(0);
    }
    function restoreSelectionFor(idx, editor){
      const r = planSelectionByIdx[idx];
      if (!r) return;
      const sel = window.getSelection();
      editor.focus();
      sel.removeAllRanges();
      sel.addRange(r);
    }

    // selection + color handling
    (() => {
      const rangeByEditor = new WeakMap();

      function getCurrentRange() {
        const sel = window.getSelection();
        return (sel && sel.rangeCount) ? sel.getRangeAt(0).cloneRange() : null;
      }

      function restoreRange(range) {
        if (!range) return false;
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        return true;
      }

      document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (!sel || !sel.anchorNode) return;
        const editor = sel.anchorNode.nodeType === 1
          ? sel.anchorNode.closest?.('.plan-contents.rte')
          : sel.anchorNode.parentElement?.closest?.('.plan-contents.rte');
        if (editor) {
          const r = getCurrentRange();
          if (r) rangeByEditor.set(editor, r);
        }
      });

      document.addEventListener('mousedown', (e) => {
        const btn = e.target.closest('.plan-toolbar button, .plan-toolbar .ln-btn');
        if (btn) e.preventDefault();
      });

      document.addEventListener('change', (e) => {
        const colorInput = e.target.closest('.plan-toolbar input[type="color"].rte-color');
        if (!colorInput) return;

        const card = colorInput.closest('.plan-card');
        const editor = card?.querySelector('.plan-contents.rte');
        if (!editor) return;

        const saved = rangeByEditor.get(editor);

        requestAnimationFrame(() => {
          editor.focus({ preventScroll: true });
          restoreRange(saved);

          const color = colorInput.value;
          applyColorByWrap(color);
        });
      });

      function applyColorByWrap(color) {
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) return;

        const range = sel.getRangeAt(0);
        if (range.collapsed) return;

        const frag = range.extractContents();
        const span = document.createElement('span');
        span.style.color = color;

        if (frag.childNodes.length === 1 &&
            frag.firstChild.nodeType === 1 &&
            frag.firstChild.nodeName === 'SPAN' &&
            frag.firstChild.style?.color === color) {
          range.insertNode(frag.firstChild);
        } else {
          span.appendChild(frag);
          range.insertNode(span);
          span.normalize();
        }

        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.addRange(newRange);
      }
    })();

    function textToParagraphs(t){
      const esc = t.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      return '<p>'+esc.split(/\n{2,}/).map(s=>s.replace(/\n/g,'<br>')).join('</p><p>')+'</p>';
    }

    function insertHtmlAtCursor(editor, html){
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) { editor.insertAdjacentHTML('beforeend', html); return; }
      let range = sel.getRangeAt(0);
      if (!editor.contains(range.startContainer)) { editor.focus(); range = window.getSelection().getRangeAt(0); }
      range.deleteContents();
      const frag = range.createContextualFragment(html);
      const last = frag.lastChild;
      range.insertNode(frag);
      if (last){
        range.setStartAfter(last);
        range.collapse(true);
        sel.removeAllRanges(); sel.addRange(range);
      }
    }

    function convertFontTagsToSpan(rootEl){
      rootEl.querySelectorAll('font[color]').forEach(font => {
        const span = document.createElement('span');
        const color = font.getAttribute('color');
        if (color) span.setAttribute('style', `color:${color}`);
        span.innerHTML = font.innerHTML;
        font.replaceWith(span);
      });
    }

    function syncPlanContents(idx, editor){
      sanitizeAndReplaceIfChanged(editor);
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
      persistNow();
    }


    /* =========================
     * H) EVENT WIRING
     * ========================= */

    // Hydrate top fields from state (initial)
    form.querySelectorAll("[data-key]").forEach(el => {
      const key = el.getAttribute("data-key");
      if (state[key]) el.value = state[key];
    });

    // Render term panels
    renderClassicTopTerms();
    renderTermsTilesPanel("retention", retentionHost);
    renderTermsTilesPanel("newbiz", newBizHost);
    hydrateFormFromState();
    syncTileTermPlanSlots();

    const STORAGE_KEY = "clgFormVars";
const STORAGE_SCHEMA = 1;

function persistNow(){
  const payload = {
    __schema: STORAGE_SCHEMA,
    ...buildProfilePayload()
  };
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); } catch(e){}
}

    // Tabs
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-panel");
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        panels.forEach(p => p.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });
    });

    // Clear (NOTE: does NOT clear LN_Rep)
    function clearForm() {
      form.querySelectorAll("[data-key]").forEach(el => { el.value = ""; });
      form.querySelectorAll("[data-term-option]").forEach(cb => { cb.checked = false; });

      state.clgFirmName = "";
      state.clgNumAttorneys = "";
      state.clgYoyIncrease = "";
      state.clgIncentive = "";
      state.clgSelectedTerms = [];
      state.clgCurrentSpend = "";
      state.clgEffectiveDate = "";
      state.clgActivationDate = "";
      state.clgExtensionTermEnd = "";
      state.clgCurrentTermEnd = "";
      state.clgTermEndDate = "";
      state.clgExtensionTerm = "";
      state.clgnbExtensionTerm = "";
      state.clgIntroPrice = "";
      state.clgTermStartDate = "";
      state.clgPlans = [makeEmptyPlan()];
      renderPlans();
      termsTilesState = defaultTermsTilesState();
      try { localStorage.removeItem(TERMS_TILES_STORAGE_KEY); } catch (e) {}
      renderClassicTopTerms();
      renderTermsTilesPanel("retention", retentionHost);
      renderTermsTilesPanel("newbiz", newBizHost);
      syncTileTermPlanSlots();
      localStorage.removeItem("clgFormVars");
      buildAppConfigFromState(state);
    }
    clearBtn.addEventListener("click", clearForm);

    // Plans initial render
    renderPlans();

    /* =========================
     * Plans: drag to reorder (handle-only, grid-safe)
     * ========================= */
    let dragEl = null;

    function reorderStateFromDom() {
      const cards = [...plansContainer.querySelectorAll(".plan-card[data-plan-id]")];
      const ids = cards.map(c => c.dataset.planId);
      const byId = new Map((state.clgPlans || []).map(p => [p.__id, p]));
      const next = ids.map(id => byId.get(id)).filter(Boolean);
      if (!next.length) return;

      state.clgPlans = next;
      renderPlans();
      buildAppConfigFromState(state);
    }

    function getClosestCard(container, x, y) {
      const cards = [...container.querySelectorAll(".plan-card:not(.is-dragging)")];
      let best = null;
      let bestDist = Infinity;

      for (const el of cards) {
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const dx = x - cx;
        const dy = y - cy;
        const dist = (dx * dx) + (dy * dy);
        if (dist < bestDist) {
          bestDist = dist;
          best = { el, rect: r, cx, cy };
        }
      }
      return best;
    }

    plansContainer.addEventListener("dragstart", (e) => {
      const handle = e.target.closest('[data-drag-handle="1"]');
      if (!handle) { e.preventDefault(); return; }

      const card = handle.closest(".plan-card");
      if (!card) return;

      dragEl = card;
      card.classList.add("is-dragging");

      try { e.dataTransfer.setData("text/plain", card.dataset.planId || "plan"); } catch {}
      e.dataTransfer.effectAllowed = "move";

      try {
        const ghost = card.cloneNode(true);
        ghost.style.position = "fixed";
        ghost.style.top = "-9999px";
        ghost.style.left = "-9999px";
        ghost.style.width = card.getBoundingClientRect().width + "px";
        document.body.appendChild(ghost);
        e.dataTransfer.setDragImage(ghost, 20, 20);
        setTimeout(() => ghost.remove(), 0);
      } catch {}
    });

    plansContainer.addEventListener("dragover", (e) => {
      if (!dragEl) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";

      const hit = getClosestCard(plansContainer, e.clientX, e.clientY);
      if (!hit || !hit.el || hit.el === dragEl) return;

      plansContainer.querySelectorAll(".plan-card.drop-target").forEach(el => el.classList.remove("drop-target"));
      hit.el.classList.add("drop-target");

      const after =
        (e.clientY > hit.cy) ||
        (Math.abs(e.clientY - hit.cy) < 6 && e.clientX > hit.cx);

      if (after) {
        const next = hit.el.nextElementSibling;
        if (next !== dragEl) plansContainer.insertBefore(dragEl, next);
      } else {
        if (hit.el !== dragEl) plansContainer.insertBefore(dragEl, hit.el);
      }
    });

    plansContainer.addEventListener("drop", (e) => {
      if (!dragEl) return;
      e.preventDefault();
    });

    plansContainer.addEventListener("dragend", () => {
      if (dragEl) dragEl.classList.remove("is-dragging");
      plansContainer.querySelectorAll(".plan-card.drop-target").forEach(el => el.classList.remove("drop-target"));
      dragEl = null;
      reorderStateFromDom();
    });

    // Plan inputs
    plansContainer.addEventListener("input", function (e) {
      const field = e.target.getAttribute("data-plan-field");
      const idxStr = e.target.getAttribute("data-plan-idx");
      if (!field || idxStr == null) return;

      const idx = Number(idxStr);
      if (!state.clgPlans[idx]) return;

      let val = e.target.value;

      if (field === "clgPrice") {
        state.clgPlans[idx].clgPrice = val;
        const cents = parseCurrencyToCents(val);
        state.clgPlans[idx].clgPriceCents = (cents == null ? null : cents);
        return;
      }

      if (field === "clgPlatform") {
        state.clgPlans[idx].clgPlatform = val;
        return;
      }

      if (field === "clgContents") {
        state.clgPlans[idx].clgContents = val;
      }
    });

    plansContainer.addEventListener("blur", function (e) {
      const field = e.target.getAttribute("data-plan-field");
      const idxStr = e.target.getAttribute("data-plan-idx");
      if (field !== "clgPrice" || idxStr == null) return;

      const idx = Number(idxStr);
      const cents = parseCurrencyToCents(e.target.value);
      if (cents != null) {
        const pretty = currencyFmt.format(cents / 100);
        e.target.value = pretty;
        state.clgPlans[idx].clgPrice = pretty;
        state.clgPlans[idx].clgPriceCents = cents;
      }
    }, true);

    // Plans: remove
    plansContainer.addEventListener("click", function (e) {
      const rem = e.target.getAttribute("data-remove");
      if (rem != null) {
        state.clgPlans.splice(Number(rem), 1);
        if (state.clgPlans.length === 0) state.clgPlans.push(makeEmptyPlan());
        renderPlans();
        syncTileTermPlanSlots();
        renderTermsTilesPanel("retention", retentionHost);
        renderTermsTilesPanel("newbiz", newBizHost);
      }
    });

    // Plans: add
    addPlanBtn.addEventListener("click", function () {
      if (state.clgPlans.length >= MAX_PLANS) return;
      state.clgPlans.push(makeEmptyPlan());
      renderPlans();
      syncTileTermPlanSlots();
      renderTermsTilesPanel("retention", retentionHost);
      renderTermsTilesPanel("newbiz", newBizHost);
    });

    // Form input (top-level)
    form.addEventListener("input", function (e) {
      const key = e.target.getAttribute("data-key");
      if (!key) return;

      if (key === "clgCurrentSpend" || key === "clgIntroPrice") {
        const cents = parseCurrencyToCents(e.target.value);
        state[key] = cents == null ? "" : currencyFmt.format(cents / 100);
        return;
      }

      if (key === "clgYoyIncrease") {
        const bps = parsePercentToBps(e.target.value);
        state.clgYoyIncrease = bps == null ? "" : (bps / 100).toFixed(2).replace(/\.00$/, "") + "%";
        return;
      }

      state[key] = e.target.value;
      persistNow();
    });

    // Term checkbox selection
    form.addEventListener("change", function (e) {
      const termKey = e.target.getAttribute("data-term-option");
      if (!termKey) return;

      let selected = Array.isArray(state.clgSelectedTerms) ? [...state.clgSelectedTerms] : [];
      if (e.target.checked) {
        if (!selected.includes(termKey)) {
          if (selected.length >= MAX_TERM_SELECTIONS) { e.target.checked = false; return; }
          selected.push(termKey);
        }
      } else {
        selected = selected.filter(k => k !== termKey);
      }
      state.clgSelectedTerms = selected;
      persistNow();
    });

    // Export -> HTML file
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        const data = getProposalData();
        const rawPlans = data.clgPlans || data.plans || data.planCards || (data.form?.plans) || [];
        const plans = rawPlans.map(normalizePlan);
        const emailHtml = buildEmailHtml(plans, data);
        downloadEmailHtml(emailHtml, 'proposal-email.html');
      });
    }

    // Download Profile (JSON) with popup filename prompt
    if (downloadProfileBtn) {
      downloadProfileBtn.addEventListener("click", () => {
        const payload = {
          meta: {
            app: "LNPresents-Builder",
            version: 1,
            exportedAt: new Date().toISOString()
          },
          data: buildProfilePayload()
        };

        const suggestedBase = state.clgFirmName || "lnpresents-profile";
        let rawBase = window.prompt("File name for this profile (no extension):", suggestedBase);
        if (rawBase === null) return;

        rawBase = rawBase.trim();
        if (!rawBase) rawBase = suggestedBase;

        let safeBase = rawBase
          .toLowerCase()
          .replace(/[^a-z0-9\-]+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");

        if (!safeBase) safeBase = "lnpresents-profile";
        const filename = `${safeBase}.json`;

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    // Upload Profile (JSON) with overwrite confirmation
    if (uploadProfileInput) {
      uploadProfileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const json = JSON.parse(text);

          const ok = window.confirm(
            "Load this profile and overwrite all current Builder details (firm info, terms, and plan contents)?"
          );
          if (!ok) return;

          applyLoadedProfile(json);
          alert("Profile loaded into Builder.");
        } catch (err) {
          console.error("Error loading profile:", err);
          alert("Could not load that file. Make sure it was exported from LN Presents Builder.");
        } finally {
          e.target.value = "";
        }
      });
    }

    // Save
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const toSave = buildProfilePayload();
      localStorage.setItem("clgFormVars", JSON.stringify(toSave));
      buildAppConfigFromState(state);
      const original = saveBtn.textContent;
      saveBtn.textContent = "Saved ✓";
      setTimeout(() => (saveBtn.textContent = original), 1200);
    });

    /* =========================
     * I) RTE INTERACTIONS
     * ========================= */
    plansContainer.addEventListener('input', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      const idx = Number(editor.getAttribute('data-plan-idx'));
      if (Number.isNaN(idx)) return;
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    });

    ['mouseup','keyup','touchend'].forEach(ev=>{
      plansContainer.addEventListener(ev, (e)=>{
        const editor = e.target.closest('.plan-contents[contenteditable]');
        if (editor) rememberSelectionFor(editor);
      });
    });

    plansContainer.addEventListener('paste', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      e.preventDefault();
      const html = (e.clipboardData && e.clipboardData.getData('text/html')) || '';
      const text = (e.clipboardData && e.clipboardData.getData('text/plain')) || '';
      const incoming = html && html.trim() ? html : textToParagraphs(text);
      const cleaned = DOMPurify.sanitize(incoming, PLAN_RTE_ALLOWED);
      const normalized = normalizeForPaste(cleaned);
      insertHtmlAtCursor(editor, normalized);
      const idx = Number(editor.getAttribute('data-plan-idx'));
      syncPlanContents(idx, editor);
      convertFontTagsToSpan(editor);
    });

    plansContainer.addEventListener('keydown', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      const planIdx = Number(editor.getAttribute('data-plan-idx'));
      const mod = e.ctrlKey || e.metaKey;
      if (!mod) return;
      const k = e.key.toLowerCase();
      if (!['b','i','u','k'].includes(k)) return;
      e.preventDefault();
      if (k === 'b') document.execCommand('bold');
      if (k === 'i') document.execCommand('italic');
      if (k === 'u') document.execCommand('underline');
      if (k === 'k') {
        const card = editor.closest('.plan-card');
        setPlanCtaFromPrompt(planIdx, card);
      }
      convertFontTagsToSpan(editor);
      if (state.clgPlans[planIdx]) state.clgPlans[planIdx].clgContents = editor.innerHTML;
    });

    plansContainer.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cmd]');
      if (!btn) return;
      const toolbar = btn.closest('.plan-toolbar');
      const idx = toolbar?.getAttribute('data-plan-idx');
      if (idx == null) return;
      const editor = plansContainer.querySelector('.plan-contents[data-plan-idx="'+idx+'"]');
      if (!editor) return;
      restoreSelectionFor(idx, editor);
      const cmd = btn.getAttribute('data-cmd');
      if (cmd === 'createLink') {
        const card = editor.closest('.plan-card');
        setPlanCtaFromPrompt(Number(idx), card);
      } else if (cmd === 'removeFormat') {
        document.execCommand('removeFormat', false, null);
        editor.querySelectorAll('a').forEach(a=>{ a.replaceWith(document.createTextNode(a.textContent)); });
      } else {
        document.execCommand(cmd, false, null);
      }

      convertFontTagsToSpan(editor);
      const i = Number(idx);
      if (state.clgPlans[i]) state.clgPlans[i].clgContents = editor.innerHTML;
    });

    document.addEventListener('selectionchange', ()=>{
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const node = sel.anchorNode;
      if (!node) return;
      const editor = node.nodeType === 1 ? node.closest('.plan-contents[contenteditable]')
                                         : node.parentElement?.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      rememberSelectionFor(editor);
    });

    plansContainer.addEventListener('focusout', (e)=>{
      const editor = e.target.closest('.plan-contents[contenteditable]');
      if (!editor) return;
      convertFontTagsToSpan(editor);
      const idx = Number(editor.getAttribute('data-plan-idx'));
      if (state.clgPlans[idx]) state.clgPlans[idx].clgContents = editor.innerHTML;
    });

    // =========================
    // PRESETS: load from GitHub + drag/drop with {{STATE}} injection
    // =========================
    const PRESETS_URL = "https://raw.githubusercontent.com/chase-gardner/LN-Presents/refs/heads/main/Plan-Presets.json";
    const presetListEl = document.getElementById("presetList");
    const STATE_TOKEN_RE = /\{\{\s*STATE\s*\}\}/gi;

    let allPresets = [];
    let draggedPreset = null;
    let lastPresetState = localStorage.getItem("lnpPresetState") || "";

    async function loadPlanPresetsFromGitHub() {
      if (!presetListEl) return;
      presetListEl.innerHTML = `<p class="presets-empty">Loading presets…</p>`;

      try {
        const res = await fetch(PRESETS_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        allPresets = Array.isArray(json) ? json : [];
        renderPresetGroups(allPresets);
      } catch (err) {
        console.error("Error loading presets:", err);
        presetListEl.innerHTML = `<p class="presets-empty">Could not load presets from GitHub. Please try again later.</p>`;
      }
    }

    function renderPresetGroups(presets) {
      if (!presets.length) {
        presetListEl.innerHTML = `<p class="presets-empty">No presets found in Plan-Presets.json.</p>`;
        return;
      }

      const byGroup = {};
      presets.forEach(p => {
        const g = p.group || "Other";
        if (!byGroup[g]) byGroup[g] = [];
        byGroup[g].push(p);
      });

      presetListEl.innerHTML = "";

      Object.keys(byGroup).sort().forEach(groupName => {
        const groupEl = document.createElement("div");
        groupEl.className = "preset-group";

        const label = document.createElement("div");
        label.className = "preset-group__label";
        label.textContent = groupName;
        groupEl.appendChild(label);

        byGroup[groupName].forEach(preset => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "preset-pill";
          pill.textContent = preset.name || "Preset";
          pill.draggable = true;

          pill.dataset.presetName = preset.name || "";
          pill.dataset.usesState = STATE_TOKEN_RE.test(preset.contents || "") ? "true" : "false";

          pill.addEventListener("dragstart", (e) => {
            draggedPreset = preset;
            e.dataTransfer.effectAllowed = "copy";
            e.dataTransfer.setData("text/plain", preset.name || "Preset");
          });

          pill.addEventListener("dragend", () => {
            draggedPreset = null;
          });

          groupEl.appendChild(pill);
        });

        presetListEl.appendChild(groupEl);
      });
    }

    function applyPresetToEditor(editor, preset) {
      if (!editor || !preset) return;

      let raw = String(preset.contents || "");

      if (STATE_TOKEN_RE.test(raw)) {
        const userState = window.prompt(
          "Enter the State for this proposal (e.g., Florida):",
          lastPresetState || ""
        );
        if (userState === null) return;

        lastPresetState = userState.trim();
        if (lastPresetState) {
          localStorage.setItem("lnpPresetState", lastPresetState);
        }
        raw = raw.replace(STATE_TOKEN_RE, lastPresetState || "");
      }

      const html = textToParagraphs(raw);
      const cleaned = DOMPurify.sanitize(html, PLAN_RTE_ALLOWED);
      insertHtmlAtCursor(editor, cleaned);
    }

    plansContainer.addEventListener("dragover", (e) => {
      const editor = e.target.closest('[data-plan-content="true"]');
      if (!editor || !draggedPreset) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
      editor.classList.add("preset-drop-target");
    });

    plansContainer.addEventListener("dragleave", (e) => {
      const editor = e.target.closest('[data-plan-content="true"]');
      if (!editor) return;
      editor.classList.remove("preset-drop-target");
    });

    plansContainer.addEventListener("drop", (e) => {
      const editor = e.target.closest('[data-plan-content="true"]');
      if (!editor || !draggedPreset) return;
      e.preventDefault();
      editor.classList.remove("preset-drop-target");

      applyPresetToEditor(editor, draggedPreset);

      const idx = Number(editor.getAttribute("data-plan-idx"));
      syncPlanContents(idx, editor);
    });

    loadPlanPresetsFromGitHub();

    /* =========================
     * J) INITIAL CONFIG BUILD
     * ========================= */
    buildAppConfigFromState(state);

  });
</script>

<script>
(function(){
  const body = document.body;
  const openBtn = document.getElementById('sidebarToggle');
  const closeBtn = document.getElementById('sidebarClose');
  const overlay = document.getElementById('sidebarOverlay');

  if (!openBtn || !closeBtn || !overlay) return;

  function closePanel(){
    body.classList.remove('sidebar-open');
  }
  function toggle(){
    body.classList.toggle('sidebar-open');
  }

  openBtn.addEventListener('click', toggle);
  closeBtn.addEventListener('click', closePanel);
  overlay.addEventListener('click', closePanel);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePanel();
  });

  // Close if user rotates / resizes back to desktop
  window.addEventListener('resize', () => {
    if (window.matchMedia('(min-width: 1101px)').matches) closePanel();
  });
})();
</script>

<script>
(function () {
  function ready(fn){ if (document.readyState !== "loading") fn(); else document.addEventListener("DOMContentLoaded", fn); }

  ready(function () {
    const presetsPanel = document.querySelector(".presets-panel");
    const presetList = document.getElementById("presetList");
    if (!presetsPanel || !presetList) return;

    // Create a placeholder so the original panel doesn't "collapse" when we move #presetList
    const placeholder = document.createElement("div");
    placeholder.className = "presets-list-placeholder";
    placeholder.hidden = true;

    // Insert placeholder right after the header (before the list)
    const header = presetsPanel.querySelector(".presets-header");
    if (header && header.nextSibling) {
      presetsPanel.insertBefore(placeholder, header.nextSibling);
    } else {
      presetsPanel.appendChild(placeholder);
    }

    // Build the sidecar
    const sidecar = document.createElement("aside");
    sidecar.className = "presets-sidecar";
    sidecar.setAttribute("aria-hidden", "true");

    sidecar.innerHTML = `
      <div class="presets-sidecar__header">
        <div>
          <h3>Plan Content Presets</h3>
          <p>Drag a preset into a plan's Contents area to start from a template.</p>
        </div>
        <button type="button" class="presets-sidecar__close" aria-label="Close presets">✕</button>
      </div>
      <div class="presets-sidecar__body"></div>
    `;

    document.body.appendChild(sidecar);

    const sidecarBody = sidecar.querySelector(".presets-sidecar__body");
    const closeBtn = sidecar.querySelector(".presets-sidecar__close");

    let userClosed = false;

    closeBtn.addEventListener("click", function () {
      userClosed = true;
      hideSidecar();
      // Move list back to original when user closes
      moveListToOriginal();
    });

    function showSidecar() {
      if (userClosed) return;
      sidecar.classList.add("is-open");
      sidecar.setAttribute("aria-hidden", "false");
    }

    function hideSidecar() {
      sidecar.classList.remove("is-open");
      sidecar.setAttribute("aria-hidden", "true");
    }

    function moveListToSidecar() {
      if (!sidecarBody.contains(presetList)) {
        placeholder.hidden = false;
        sidecarBody.appendChild(presetList);
      }
    }

    function moveListToOriginal() {
      if (!presetsPanel.contains(presetList)) {
        placeholder.hidden = true;
        // Put it back where it originally lived: after the header, before placeholder (or at end)
        if (header && placeholder.parentNode === presetsPanel) {
          presetsPanel.insertBefore(presetList, placeholder);
        } else {
          presetsPanel.appendChild(presetList);
        }
      }
    }

    // Detect when user scrolls past the presets panel
    function onScroll() {
      const rect = presetsPanel.getBoundingClientRect();
      const passed = rect.bottom <= 8; // threshold: once the panel is fully above the viewport

      if (passed) {
        showSidecar();
        moveListToSidecar();
      } else {
        hideSidecar();
        moveListToOriginal();
        userClosed = false; // re-enable if they scroll back above then down again
      }
    }

    // Use passive scroll + also run once initially
    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", onScroll, { passive: true });
    onScroll();
  });
})();
</script>
</body>
</html>
